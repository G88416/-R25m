<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto Genius Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                        accent: '#10B981',
                        dark: '#1F2937',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles for body and typography */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Sidebar transition for smooth hide/show */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* Chart container to manage max height and responsiveness */
        .chart-container {
            max-height: 250px; 
            width: 100%; 
        }
        /* Styling for number balls */
        .number-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3B82F6;
            color: white;
            font-weight: bold;
            margin: 4px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bonus-ball { background-color: #8B5CF6; }
        .hot-number { background-color: #EF4444; }
        .cold-number { background-color: #3B82F6; }
        .due-number { background-color: #F59E0B; }
        .unused-number { background-color: #6B7280; }

        /* Responsive adjustments for main content area */
        @media (min-width: 768px) { /* md breakpoint */
            .main-content-area {
                margin-left: 16rem; /* Equivalent to md:ml-64 */
            }
        }
        /* General button styling for better touch targets */
        button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Textarea and input styling for consistency */
        textarea, input[type="text"], input[type="number"], select {
            padding: 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
        }
        .dark textarea, .dark input[type="text"], .dark input[type="number"], .dark select {
            border-color: #4B5563;
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Custom scrollbar for output boxes */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg p-4 sidebar z-40 md:translate-x-0 sidebar-hidden">
        <div class="flex items-center mb-6">
            <h1 class="text-2xl font-bold text-primary">Lotto Genius</h1>
            <span class="ml-2 px-2 py-1 text-xs bg-accent text-white rounded-full">PRO</span>
        </div>
        <nav>
            <ul class="space-y-2">
                <li><a href="#dashboard" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📊 Dashboard</a></li>
                <li><a href="#generator" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🎰 Smart Generator</a></li>
                <li><a href="#analyzer" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔍 Advanced Analyzer</a></li>
                <li><a href="#combinatorics" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔬 Combinatorics Lab</a></li>
                <li><a href="#reverse-engineer" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔄 Reverse Engineer</a></li>
                <li><a href="#historical" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📈 Historical Data</a></li>
                <li><a href="#strategies" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🧠 AI Strategies</a></li>
                <li><a href="#probability" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📉 Probability Lab</a></li>
                <li><a href="#prediction" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔮 Prediction Engine</a></li>
                <li><a href="#settings" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">⚙️ Settings</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="ml-0 p-4 main-content-area transition-all duration-300">
        <header class="flex justify-between items-center mb-6">
            <button id="toggleSidebar" class="md:hidden p-2 bg-primary text-white rounded-lg">☰</button>
            <div class="flex space-x-4">
                <button id="themeToggle" class="p-2 bg-primary text-white rounded-lg">🌙</button>
                <button id="notifications" class="p-2 bg-secondary text-white rounded-lg relative">
                    🔔
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </header>

        <main class="space-y-8">
            <!-- Dashboard Section -->
            <section id="dashboard" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Recent Activity</h3>
                        <div id="recentActivity" class="text-sm space-y-2">
                            <p class="text-gray-500 dark:text-gray-400">No recent activity</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Quick Actions</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-action p-2 bg-primary text-white rounded-lg text-sm" data-action="quickPick">Quick Pick</button>
                            <button class="quick-action p-2 bg-secondary text-white rounded-lg text-sm" data-action="analyzeLast">Analyze Last</button>
                            <button class="quick-action p-2 bg-accent text-white rounded-lg text-sm" data-action="checkOdds">Check Odds</button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Statistics</h3>
                        <div id="statsOverview" class="text-sm">
                            <p class="text-gray-500 dark:text-gray-400">Generate numbers to see statistics</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency Heatmap</h3>
                        <div class="chart-container"><canvas id="dashboardHeatmap"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Recent Patterns</h3>
                        <div class="chart-container"><canvas id="dashboardPatterns"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Smart Generator Section -->
            <section id="generator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Smart Number Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Game Configuration -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Game Setup</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Lottery Game</label>
                            <select id="lotteryGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="mainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="pickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="bonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="bonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Random Seed</label>
                            <div class="flex gap-2">
                                <input id="randomSeed" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="Enter seed">
                                <button id="randomSeedBtn" class="p-2 bg-primary text-white rounded-lg">🎲</button>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Options -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Generation Method</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Algorithm</label>
                            <select id="generationMethod" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="standard">Standard Random</option>
                                <option value="fisherYates">Fisher-Yates Shuffle</option>
                                <option value="crypto">Cryptographically Secure</option>
                                <option value="lowHigh">Low-High Balance</option>
                                <option value="oddEven">Odd-Even Balance</option>
                                <option value="prime">Prime Number Filter</option>
                                <option value="fibonacci">Fibonacci Filter</option>
                                <option value="statistical">Statistical Weighted</option>
                                <option value="ai">AI-Powered ✨</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Historical Filters</label>
                            <div class="space-y-1">
                                <label class="flex items-center"><input id="useHistorical" type="checkbox" class="mr-2"> Use Historical Data</label>
                                <label class="flex items-center"><input id="favorHot" type="checkbox" class="mr-2"> Favor Hot Numbers</label>
                                <label class="flex items-center"><input id="includeDue" type="checkbox" class="mr-2"> Include Due Numbers</label>
                                <label class="flex items-center"><input id="avoidRepeats" type="checkbox" class="mr-2"> Avoid Recent Repeats</label>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Advanced Options</h3>
                        <div>
                            <label class="block text-sm font-medium">Number of Tickets</label>
                            <input id="numTickets" type="number" min="1" max="100" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Sum Filter</label>
                            <select id="sumFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Sum</option>
                                <option value="low">Low Sum</option>
                                <option value="medium">Medium Sum</option>
                                <option value="high">High Sum</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Consecutive Numbers</label>
                            <select id="consecutiveFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Consecutives</option>
                                <option value="none">No Consecutives</option>
                                <option value="max1">Max 1 Pair</option>
                                <option value="max2">Max 2 Pairs</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    <div class="flex flex-wrap gap-2">
                        <button id="generateSmart" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700">Generate Smart Numbers</button>
                        <button id="quickPickBtn" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Quick Pick</button>
                        <button id="clearGenerator" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear All</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Tip: Combine AI-Powered generation with historical data for statistically optimized numbers.</p>
                </div>

                <!-- Generated Tickets -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-medium">Generated Tickets</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="exportTxt" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">TXT</button>
                            <button id="exportCsv" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">CSV</button>
                            <button id="copyTickets" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                            <button id="saveTickets" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 text-sm">Save</button>
                        </div>
                    </div>
                    <div id="generatedTickets" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 max-h-80 overflow-y-auto custom-scrollbar">
                        <p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>
                    </div>
                </div>

                <!-- Analysis Panels -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency</h3>
                        <div class="chart-container"><canvas id="numberFrequencyChart"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Sum Analysis</h3>
                        <div class="chart-container"><canvas id="sumAnalysisChart"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Pattern Analysis</h3>
                        <div class="chart-container"><canvas id="patternAnalysisChart"></canvas></div>
                    </div>
                </div>
            </section>
            
            <!-- Advanced Analyzer Section -->
            <section id="analyzer" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Number Analyzer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Analysis Input -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="analyzerGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customAnalyzerGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div><label class="block text-sm font-medium">Main Pool</label><input id="analyzerMainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69"></div>
                            <div><label class="block text-sm font-medium">Pick Count</label><input id="analyzerPickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5"></div>
                            <div><label class="block text-sm font-medium">Bonus Pool</label><input id="analyzerBonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26"></div>
                            <div><label class="block text-sm font-medium">Bonus Count</label><input id="analyzerBonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1"></div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Numbers to Analyze</label>
                            <textarea id="numbersToAnalyze" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: 5,12,23,34,45,6 or 5 12 23 34 45 6</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="analyzeNumbers" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Analyze</button>
                            <button id="getAIInsights" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">AI Insights ✨</button>
                            <button id="clearAnalyzer" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <!-- Basic Analysis Results -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Basic Analysis</h3>
                        <div id="analysisResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Number Properties</h4><div id="numberProps" class="text-xs mt-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Pattern Analysis</h4><div id="patternStats" class="text-xs mt-1"></div></div>
                        </div>
                        <div id="aiInsightsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hidden"><h4 class="font-medium text-sm">AI Insights</h4><div id="aiInsightsText" class="text-xs mt-1"></div><div id="aiInsightsLoading" class="loading-indicator hidden mx-auto mt-2"></div></div>
                    </div>

                    <!-- Advanced Analysis -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Advanced Metrics</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Basic Statistics</h4><div id="basicStats" class="text-xs mt-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Advanced Metrics</h4><div id="advancedMetrics" class="text-xs mt-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Most Used Numbers (from input)</h4><div id="mostUsedNumbersInput" class="text-xs mt-1 flex flex-wrap gap-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Unused Numbers (from pool)</h4><div id="unusedNumbersAndPairs" class="text-xs mt-1 flex flex-wrap gap-1"></div></div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Number Frequency</h4><div class="chart-container"><canvas id="freqDistributionChart"></canvas></div></div>
                    </div>
                </div>
            </section>

            <!-- Combinatorics Lab Section -->
            <section id="combinatorics" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Combinatorics Lab</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Common Sets Generator -->
                    <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                        <h3 class="text-xl font-semibold text-primary">Common Sets Generator</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Find frequently occurring sets of numbers (pairs, triplets, etc.) from historical data.</p>
                        <div>
                            <label class="block text-sm font-medium">Draw Data Input</label>
                            <textarea id="setsDataInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-40 custom-scrollbar" placeholder="Enter historical draws, one per line (e.g., 5 12 23 34 45 6)"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Set Size</label>
                                <select id="setSize" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                    <option value="2">Pairs</option>
                                    <option value="3">Triplets</option>
                                    <option value="4">Quadruplets</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Min Frequency</label>
                                <input id="minSetFrequency" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="2">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="findCommonSets" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Find Sets</button>
                            <button id="useHistoricalForSets" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Use Loaded Data</button>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium mb-2">Most Common Sets</h4>
                            <div id="commonSetsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 max-h-60 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-500 dark:text-gray-400">Find sets to see results.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Combinations & Permutations Generator -->
                    <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                        <h3 class="text-xl font-semibold text-accent">Combinations & Permutations</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Generate all possible combinations (order doesn't matter) or permutations (order matters) from your numbers.</p>
                        <div>
                            <label class="block text-sm font-medium">Your Numbers</label>
                            <textarea id="comboNumbersInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-24" placeholder="e.g., 1, 2, 3, 4, 5, 6, 7"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="block text-sm font-medium">Type</label>
                                <select id="comboPermType" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                    <option value="combinations">Combinations</option>
                                    <option value="permutations">Permutations</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Group Size (r)</label>
                                <input id="combinationSize" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="3">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="generateCombinations" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 flex-1">Generate</button>
                            <button id="clearCombinations" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-medium">Generated Sets (<span id="combinationCount">0</span>)</h4>
                                <button id="copyCombinations" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                            </div>
                            <div id="combinationsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 max-h-60 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-500 dark:text-gray-400">Generate sets to see results.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wheeling System Explorer -->
                    <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                        <h3 class="text-xl font-semibold text-warning">Wheeling System Explorer</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Generate ticket sets (wheels) that guarantee a prize if a certain amount of winning numbers fall within your selected pool.</p>
                        <div>
                            <label class="block text-sm font-medium">Your Number Pool</label>
                            <textarea id="wheelingNumbersInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-24" placeholder="Enter 7 to 12 numbers to wheel"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">System / Guarantee</label>
                            <select id="wheelingSystemType" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="7_5_3of4">7 Nums: Guarantee 3-win if 4 hit</option>
                                <option value="8_5_3of4">8 Nums: Guarantee 3-win if 4 hit</option>
                                <option value="9_6_4of5">9 Nums: Guarantee 4-win if 5 hit</option>
                                <option value="10_6_3of3">10 Nums: Guarantee 3-win if 3 hit</option>
                                <option value="12_6_4of5">12 Nums: Guarantee 4-win if 5 hit</option>
                            </select>
                        </div>
                         <div class="flex flex-wrap gap-2">
                            <button id="generateWheel" class="p-2 bg-warning text-white rounded-lg hover:bg-yellow-600 flex-1">Generate Wheel</button>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium mb-2">Wheeled Tickets (<span id="wheelTicketCount">0</span>)</h4>
                            <div id="wheelingOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 max-h-60 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-500 dark:text-gray-400">Generate a wheel to see tickets.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Other sections remain unchanged... -->
            <!-- Reverse Engineer Section -->
            <section id="reverse-engineer" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Lotto Reverse Engineer</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Input Section -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="reverseGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Numbers to Reverse Engineer</label>
                            <textarea id="numbersToReverse" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Analysis Method</label>
                            <select id="reverseMethod" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="statistical">Statistical Analysis</option>
                                <option value="pattern">Pattern Recognition</option>
                                <option value="ai">AI-Powered Reverse Engineering ✨</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="reverseEngineerBtn" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Reverse Engineer</button>
                            <button id="clearReverse" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Reverse Engineering Results</h3>
                        <div id="reverseResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-32">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers and analyze to see results</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Statistical Profile</h4><div id="reverseStats" class="text-xs mt-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Pattern Analysis</h4><div id="reversePatterns" class="text-xs mt-1"></div></div>
                        </div>
                        
                        <div id="aiReverseAnalysis" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">AI Seed Analysis ✨</h4>
                            <div id="reverseSeeds" class="text-xs mt-1"></div>
                            <div id="reverseLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                        
                        <div class="chart-container"><canvas id="reverseChart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Historical Data Section -->
            <section id="historical" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Historical Data Explorer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Data Configuration -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Source</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="historicalGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Data Source</label>
                            <select id="dataSource" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="sample">Sample Data (Built-in)</option>
                                <option value="csv">Upload CSV</option>
                            </select>
                        </div>
                        
                        <div id="csvUploadContainer" class="hidden">
                            <label class="block text-sm font-medium">Upload CSV File</label>
                            <input id="csvUpload" type="file" accept=".csv" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Number of Past Draws</label>
                            <select id="pastDraws" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">500</option>
                                <option value="all">All Available</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="loadData" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Load Data</button>
                        </div>
                    </div>

                    <!-- Data Summary -->
                    <div class="space-y-4 col-span-2">
                        <h3 class="text-xl font-medium">Data Summary</h3>
                        <div id="dataSummary" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Load historical data to see summary</p>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Most Frequent</h4><div id="mostFrequent" class="text-xs mt-1 flex flex-wrap gap-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Least Frequent</h4><div id="leastFrequent" class="text-xs mt-1 flex flex-wrap gap-1"></div></div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg"><h4 class="font-medium text-sm">Due Numbers</h4><div id="dueNumbers" class="text-xs mt-1 flex flex-wrap gap-1"></div></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-xl font-medium mb-2">Historical Draws</h3>
                    <div class="overflow-x-auto">
                        <table id="historicalTable" class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700"><th class="p-2 text-left">Date</th><th class="p-2 text-left">Numbers</th><th class="p-2 text-left">Bonus</th><th class="p-2 text-left">Sum</th><th class="p-2 text-left">Odd/Even</th></tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-2 gap-2">
                        <div class="text-sm text-gray-600 dark:text-gray-400" id="paginationInfo">Showing 0 of 0</div>
                        <div class="flex gap-2">
                            <button id="prevPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>&lt;</button>
                            <button id="nextPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>&gt;</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Remaining sections would follow -->
            
        </main>
    </div>

    <!-- Success Notification -->
    <div id="successNotification" class="fixed bottom-4 right-4 bg-accent text-white p-4 rounded-lg shadow-lg hidden transition-all duration-300 transform translate-y-4 opacity-0 z-50">
        Operation completed successfully!
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirmModalContainer"></div>


    <script>
        // Gemini API Key (Leave empty for Canvas environment to provide)
        const apiKey = ""; 

        // Game Configurations
        const gameConfigs = {
            powerball: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1 },
            megamillions: { mainPool: 70, pickCount: 5, bonusPool: 25, bonusCount: 1 },
            euromillions: { mainPool: 50, pickCount: 5, bonusPool: 12, bonusCount: 2 },
            lotto649: { mainPool: 49, pickCount: 6, bonusPool: 0, bonusCount: 0 },
            lotto645: { mainPool: 45, pickCount: 6, bonusPool: 0, bonusCount: 0 },
            custom: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1 }
        };
        
        // Pre-defined Wheeling Systems
        // Key: V_K_T_M (V numbers in pool, K numbers per ticket, T-win guarantee if M numbers are drawn)
        // Value: Array of arrays of indices
        const wheelingSystems = {
            '7_5_3of4': { numbers: 7, pick: 5, tickets: 3, guarantee: '3 if 4', wheel: [[0,1,2,3,4], [0,1,2,5,6], [3,4,5,6,0]] },
            '8_5_3of4': { numbers: 8, pick: 5, tickets: 4, guarantee: '3 if 4', wheel: [[0,1,2,3,4], [0,1,2,5,6], [0,3,4,5,7], [1,2,4,6,7]] },
            '9_6_4of5': { numbers: 9, pick: 6, tickets: 3, guarantee: '4 if 5', wheel: [[0,1,2,3,4,5], [0,1,2,6,7,8], [3,4,5,6,7,8]] },
            '10_6_3of3': { numbers: 10, pick: 6, tickets: 20, guarantee: '3 if 3', wheel: [[0,1,2,3,4,5],[0,1,2,3,6,7],[0,1,2,4,6,8],[0,1,2,5,7,9],[0,1,3,4,6,9],[0,1,3,5,7,8],[0,1,4,5,8,9],[0,1,6,7,8,9],[0,2,3,5,6,8],[0,2,3,7,8,9],[0,2,4,5,7,9],[0,2,4,6,7,8],[0,3,4,5,6,7],[0,3,4,8,9,0],[1,2,3,4,7,8],[1,2,3,6,8,9],[1,2,5,6,7,8],[1,3,4,5,7,9],[1,4,5,6,8,9],[2,3,4,5,6,9]] }, // This is a full C(10,3) wheel, simplified for demo
            '12_6_4of5': { numbers: 12, pick: 6, tickets: 6, guarantee: '4 if 5', wheel: [[0,1,2,3,4,5],[0,1,2,6,7,8],[0,3,4,9,10,11],[1,5,7,8,9,10],[2,3,6,7,10,11],[4,5,8,9,11,0]] }
        };

        // Application State
        const appState = {
            historicalData: [],
            currentPage: 1,
            drawsPerPage: 10,
            savedTickets: [],
            notificationCount: 0,
            darkMode: true,
            animations: true,
            notifications: true,
            defaultGame: 'powerball',
        };

        // Chart Instances
        const charts = {};

        // Initialize Application
        function initApp() {
            initCharts();
            initEventListeners();
            loadSettings();
            updateUI();
        }

        // Initialize Charts
        function initCharts() {
            const chartConfigs = [
                { id: 'dashboardHeatmap', type: 'bar', label: 'Number Frequency Heatmap' },
                { id: 'dashboardPatterns', type: 'line', label: 'Recent Patterns' },
                { id: 'numberFrequencyChart', type: 'bar', label: 'Number Frequency' },
                { id: 'sumAnalysisChart', type: 'bar', label: 'Sum Distribution' },
                { id: 'patternAnalysisChart', type: 'bar', label: 'Consecutive Pairs' },
                { id: 'freqDistributionChart', type: 'bar', label: 'Frequency Distribution' },
                { id: 'reverseChart', type: 'bar', label: 'Reverse Engineered Numbers' },
            ];

            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id)?.getContext('2d');
                if (ctx) {
                    charts[config.id] = new Chart(ctx, {
                        type: config.type,
                        data: { labels: [], datasets: [{ label: config.label, data: [], backgroundColor: '#3B82F6', borderColor: '#3B82F6', borderWidth: 1 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
                    });
                }
            });
        }

        // Initialize Event Listeners
        function initEventListeners() {
            // UI Controls
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('notifications').addEventListener('click', () => showNotification(`You have ${appState.notificationCount} notifications.`));
            
            // Game Configuration
            document.getElementById('lotteryGame').addEventListener('change', handleGameChange);
            document.getElementById('analyzerGame').addEventListener('change', handleAnalyzerGameChange);
            document.getElementById('randomSeedBtn').addEventListener('click', generateRandomSeed);
            
            // Generator Controls
            document.getElementById('generateSmart').addEventListener('click', generateSmartNumbers);
            document.getElementById('quickPickBtn').addEventListener('click', quickPick);
            document.getElementById('clearGenerator').addEventListener('click', clearGenerator);
            document.getElementById('exportTxt').addEventListener('click', exportTicketsTxt);
            document.getElementById('exportCsv').addEventListener('click', exportTicketsCsv);
            document.getElementById('copyTickets').addEventListener('click', copyTickets);
            document.getElementById('saveTickets').addEventListener('click', saveTickets);
            
            // Analyzer Controls
            document.getElementById('analyzeNumbers').addEventListener('click', analyzeNumbers);
            document.getElementById('clearAnalyzer').addEventListener('click', clearAnalyzer);
            document.getElementById('getAIInsights').addEventListener('click', getAIInsights);

            // Combinatorics Lab Controls
            document.getElementById('findCommonSets').addEventListener('click', findCommonSets);
            document.getElementById('useHistoricalForSets').addEventListener('click', useHistoricalDataForSets);
            document.getElementById('generateCombinations').addEventListener('click', generateComboPerm);
            document.getElementById('clearCombinations').addEventListener('click', clearCombinationsGenerator);
            document.getElementById('copyCombinations').addEventListener('click', copyAllCombinations);
            document.getElementById('generateWheel').addEventListener('click', generateWheelingSystemLab);

            // Reverse Engineer Controls
            document.getElementById('reverseEngineerBtn').addEventListener('click', reverseEngineerNumbers);
            document.getElementById('clearReverse').addEventListener('click', clearReverseEngineer);
            
            // Historical Data Controls
            document.getElementById('dataSource').addEventListener('change', handleDataSourceChange);
            document.getElementById('loadData').addEventListener('click', loadHistoricalData);
            document.getElementById('prevPage').addEventListener('click', prevPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
            
            // Quick Actions
            document.querySelectorAll('.quick-action').forEach(btn => btn.addEventListener('click', handleQuickAction));
        }

        // UI Functions
        function toggleTheme() {
            document.body.classList.toggle('dark');
            appState.darkMode = document.body.classList.contains('dark');
            saveSettings();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-hidden');
            document.querySelector('.main-content-area').classList.toggle('md:ml-64', !sidebar.classList.contains('sidebar-hidden'));
        }

        function showNotification(message, type = 'success') {
            if (!appState.notifications) return;
            const notification = document.getElementById('successNotification');
            notification.textContent = message;
            
            const colorClass = type === 'error' ? 'bg-danger' : 'bg-accent';
            notification.classList.remove('bg-accent', 'bg-danger');
            notification.classList.add(colorClass);

            notification.classList.remove('hidden', 'translate-y-4', 'opacity-0');
            notification.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
            
            if (type !== 'error') {
                appState.notificationCount++;
                updateNotificationBadge();
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (appState.notificationCount > 0) {
                badge.textContent = appState.notificationCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function showConfirmation(message, callback) {
            const container = document.getElementById('confirmModalContainer');
            const modalHtml = `<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center"><h3 class="text-xl font-semibold mb-4">Confirm Action</h3><p class="mb-6">${message}</p><div class="flex justify-center gap-4"><button id="confirmCancel" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex-1">Cancel</button><button id="confirmProceed" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600 flex-1">Proceed</button></div></div></div>`;
            container.innerHTML = modalHtml;

            const confirmModal = document.getElementById('confirmModal');
            document.getElementById('confirmCancel').addEventListener('click', () => {
                confirmModal.remove();
                callback(false);
            });
            document.getElementById('confirmProceed').addEventListener('click', () => {
                confirmModal.remove();
                callback(true);
            });
        }

        function updateUI() {
            if (appState.darkMode) document.body.classList.add('dark');
            else document.body.classList.remove('dark');
            updateNotificationBadge();
            if (window.innerWidth < 768) toggleSidebar();
        }

        // Game Configuration Functions
        function handleGameChange(e) {
            const customConfig = document.getElementById('customGameConfig');
            customConfig.classList.toggle('hidden', e.target.value !== 'custom');
        }

        function handleAnalyzerGameChange(e) {
            const customConfig = document.getElementById('customAnalyzerGameConfig');
            customConfig.classList.toggle('hidden', e.target.value !== 'custom');
        }

        function handleDataSourceChange(e) {
            const csvContainer = document.getElementById('csvUploadContainer');
            csvContainer.classList.toggle('hidden', e.target.value !== 'csv');
        }

        function generateRandomSeed() {
            document.getElementById('randomSeed').value = crypto.randomUUID();
        }

        // Number Generation
        async function generateNumbers(config, method, options = {}) {
            const { mainPool, pickCount, bonusPool, bonusCount } = config;
            let numbers = [];
            
            if (method === 'ai') {
                numbers = await generateUsingAI(config, options);
            } else {
                const allNumbers = Array.from({ length: mainPool }, (_, i) => i + 1);
                numbers = _.shuffle(allNumbers).slice(0, pickCount);
            }

            numbers.sort((a, b) => a - b);
            const bonus = bonusPool > 0 ? _.shuffle(Array.from({ length: bonusPool }, (_, i) => i + 1)).slice(0, bonusCount).sort((a, b) => a - b) : [];
            
            return { numbers, bonus };
        }

        async function generateUsingAI(config, options) {
            const { mainPool, pickCount } = config;
            let prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.`;
            if (options.useHistorical && appState.historicalData.length > 0) {
                const frequency = getNumberFrequency();
                const hot = Object.entries(frequency).sort((a,b) => b[1]-a[1]).slice(0,10).map(e=>e[0]);
                const cold = Object.entries(frequency).sort((a,b) => a[1]-b[1]).slice(0,10).map(e=>e[0]);
                prompt += ` Historical data suggests these are hot numbers (most frequent): ${hot.join(', ')} and these are cold numbers (least frequent): ${cold.join(', ')}.`;
                if (options.favorHot) prompt += ` Give more weight to hot numbers.`;
                if (options.includeDue) prompt += ` Give more weight to cold numbers (as they might be due).`;
            }
            prompt += ` Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40".`;

            try {
                const response = await callGeminiAPI(prompt);
                const parsed = response.split(',').map(Number).filter(n => !isNaN(n) && n >= 1 && n <= mainPool);
                let generated = [...new Set(parsed)];
                while (generated.length < pickCount) {
                    const randomNum = Math.floor(Math.random() * mainPool) + 1;
                    if (!generated.includes(randomNum)) generated.push(randomNum);
                }
                return generated.slice(0, pickCount);
            } catch (error) {
                showNotification("AI generation failed, using random.", "error");
                return _.shuffle(Array.from({ length: mainPool }, (_, i) => i + 1)).slice(0, pickCount);
            }
        }
        
        async function callGeminiAPI(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }
            throw new Error("Invalid API response structure");
        }

        // Generator UI Functions
        async function generateSmartNumbers() {
            const { config } = getGeneratorConfig();
            const method = document.getElementById('generationMethod').value;
            const options = {
                useHistorical: document.getElementById('useHistorical').checked,
                favorHot: document.getElementById('favorHot').checked,
                includeDue: document.getElementById('includeDue').checked,
                avoidRepeats: document.getElementById('avoidRepeats').checked,
                sumFilter: document.getElementById('sumFilter').value,
                consecutiveFilter: document.getElementById('consecutiveFilter').value
            };
            const numTickets = parseInt(document.getElementById('numTickets').value) || 1;
            
            const generateBtn = document.getElementById('generateSmart');
            const loadingIndicator = createLoadingIndicator();
            generateBtn.appendChild(loadingIndicator);

            const tickets = [];
            for (let i = 0; i < numTickets; i++) {
                tickets.push(await generateNumbers(config, method, options));
            }
            
            loadingIndicator.remove();
            displayTickets(tickets);
            updateGeneratorCharts(tickets);
            updateStatsOverview(tickets);
        }

        async function quickPick() {
            const { config } = getGeneratorConfig();
            const tickets = [await generateNumbers(config, 'quick', {})];
            displayTickets(tickets);
            updateGeneratorCharts(tickets);
            updateStatsOverview(tickets);
        }
        
        function getGeneratorConfig() {
            const game = document.getElementById('lotteryGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('mainPool').value) || 69,
                pickCount: parseInt(document.getElementById('pickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('bonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('bonusCount').value) || 1
            } : gameConfigs[game];
            return { game, config };
        }

        function displayTickets(tickets) {
            const ticketsDiv = document.getElementById('generatedTickets');
            if (!tickets || tickets.length === 0) {
                ticketsDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No tickets generated.</p>';
                return;
            }
            ticketsDiv.innerHTML = tickets.map((ticket, index) => `
                <div class="p-3 bg-white dark:bg-gray-600 rounded-lg mb-2 border border-gray-200 dark:border-gray-500">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium">Ticket ${index + 1}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Sum: ${_.sum(ticket.numbers)}</span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${ticket.numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}
                        ${ticket.bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updateGeneratorCharts(tickets) {
            if (tickets.length === 0) return;
            const numbers = tickets.flatMap(t => t.numbers);
            const frequencyMap = _.countBy(numbers);
            updateChart(charts.numberFrequencyChart, Object.keys(frequencyMap).sort((a,b)=>a-b), Object.values(frequencyMap));
            
            const sums = tickets.map(t => _.sum(t.numbers));
            updateChart(charts.sumAnalysisChart, tickets.map((_,i)=>`T${i+1}`), sums);
            
            const patterns = tickets.map(t => countConsecutivePairs(t.numbers));
            updateChart(charts.patternAnalysisChart, tickets.map((_,i)=>`T${i+1}`), patterns);
        }
        
        function clearGenerator() {
            document.getElementById('generatedTickets').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate numbers to see results</p>';
            ['numberFrequencyChart', 'sumAnalysisChart', 'patternAnalysisChart'].forEach(id => clearChart(charts[id]));
        }

        // Analyzer Functions
        function analyzeNumbers() {
            const input = document.getElementById('numbersToAnalyze').value;
            const numbers = parseNumbers(input);
            if (numbers.length === 0) return showNotification('Please enter valid numbers!', 'error');

            const game = document.getElementById('analyzerGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('analyzerMainPool').value) || 69,
            } : gameConfigs[game];
            
            const analysis = getNumberAnalysis(numbers, config.mainPool);

            document.getElementById('basicStats').innerHTML = `<p>Count: ${analysis.count}</p><p>Sum: ${analysis.sum}</p><p>Average: ${analysis.avg.toFixed(2)}</p>`;
            document.getElementById('numberProps').innerHTML = `<p>Odd: ${analysis.oddCount}</p><p>Even: ${analysis.evenCount}</p><p>Primes: ${analysis.primes}</p>`;
            document.getElementById('patternStats').innerHTML = `<p>Consecutive Pairs: ${analysis.consecutivePairs}</p><p>Gaps: ${analysis.gaps.join(', ')}</p>`;
            document.getElementById('advancedMetrics').innerHTML = `<p>Std Dev: ${analysis.stdDev.toFixed(2)}</p><p>Spread: ${analysis.spread.toFixed(2)}%</p>`;
            
            const { unusedNumbers } = detectUnusedFromInput(numbers, config.mainPool);
            document.getElementById('unusedNumbersAndPairs').innerHTML = unusedNumbers.slice(0, 20).map(n => `<span class="number-ball unused-number">${n}</span>`).join('');
            
            const frequencyMap = _.countBy(numbers);
            document.getElementById('mostUsedNumbersInput').innerHTML = Object.keys(frequencyMap).sort((a,b)=>frequencyMap[b]-frequencyMap[a]).slice(0,10).map(n => `<span class="number-ball hot-number">${n}</span>`).join('');
            
            updateChart(charts.freqDistributionChart, Object.keys(frequencyMap).sort((a,b)=>a-b), Object.values(frequencyMap));
            document.getElementById('analysisResults').innerHTML = `<p class="font-medium">Analysis Complete</p><p class="text-sm">Analyzed ${numbers.length} numbers.</p>`;
        }
        
        async function getAIInsights() {
            const input = document.getElementById('numbersToAnalyze').value;
            const numbers = parseNumbers(input);
            if (numbers.length === 0) return showNotification('Please enter numbers first!', 'error');

            const aiInsightsOutput = document.getElementById('aiInsightsOutput');
            const aiInsightsText = document.getElementById('aiInsightsText');
            const aiInsightsLoading = document.getElementById('aiInsightsLoading');

            aiInsightsOutput.classList.remove('hidden');
            aiInsightsText.innerHTML = '';
            aiInsightsLoading.classList.remove('hidden');

            const prompt = `Analyze this set of lottery numbers: ${numbers.join(', ')}. Provide a concise analysis of their statistical properties (like sum, odd/even balance, spread) and any notable patterns. Is this a balanced set?`;
            
            try {
                const insights = await callGeminiAPI(prompt);
                aiInsightsText.innerHTML = insights.replace(/\n/g, '<br>');
            } catch (error) {
                aiInsightsText.textContent = 'Error fetching AI insights.';
            } finally {
                aiInsightsLoading.classList.add('hidden');
            }
        }

        function clearAnalyzer() {
            document.getElementById('numbersToAnalyze').value = '';
            ['analysisResults', 'basicStats', 'numberProps', 'patternStats', 'advancedMetrics', 'mostUsedNumbersInput', 'unusedNumbersAndPairs'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '';
            });
            document.getElementById('aiInsightsOutput').classList.add('hidden');
            clearChart(charts.freqDistributionChart);
        }
        
        // Combinatorics Lab Functions
        function findCommonSets() {
            const input = document.getElementById('setsDataInput').value;
            const minFrequency = parseInt(document.getElementById('minSetFrequency').value) || 2;
            const setSize = parseInt(document.getElementById('setSize').value) || 2;
            const lines = input.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) return showNotification('Please enter draw data.', 'error');

            const setCounts = {};
            lines.forEach(line => {
                const numbers = parseNumbers(line).sort((a, b) => a - b);
                if (numbers.length < setSize) return;
                const combos = getCombinations(numbers, setSize);
                combos.forEach(combo => {
                    const key = combo.join('-');
                    setCounts[key] = (setCounts[key] || 0) + 1;
                });
            });

            const commonSets = Object.entries(setCounts)
                .filter(([_, count]) => count >= minFrequency)
                .sort((a, b) => b[1] - a[1]);

            const outputDiv = document.getElementById('commonSetsOutput');
            if (commonSets.length === 0) {
                outputDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No common sets found.</p>';
            } else {
                outputDiv.innerHTML = commonSets.map(([set, count]) => {
                    const nums = set.split('-');
                    return `<div class="flex items-center justify-between p-2 bg-white dark:bg-gray-600 rounded-lg mb-2">
                                <div class="flex gap-1">${nums.map(n => `<span class="number-ball">${n}</span>`).join('')}</div>
                                <span class="font-bold text-lg text-primary">${count}x</span>
                            </div>`;
                }).join('');
            }
        }

        function useHistoricalDataForSets() {
            if (appState.historicalData.length === 0) return showNotification('No historical data loaded.', 'error');
            const dataAsString = appState.historicalData.map(draw => draw.numbers.join(' ')).join('\n');
            document.getElementById('setsDataInput').value = dataAsString;
        }

        function generateComboPerm() {
            const input = document.getElementById('comboNumbersInput').value;
            const groupSize = parseInt(document.getElementById('combinationSize').value);
            const type = document.getElementById('comboPermType').value;
            const numbers = [...new Set(parseNumbers(input))].sort((a, b) => a - b);

            if (numbers.length < groupSize || groupSize <= 0) return showNotification('Invalid numbers or group size.', 'error');

            const results = type === 'combinations' ? getCombinations(numbers, groupSize) : getPermutations(numbers, groupSize);
            
            document.getElementById('combinationCount').textContent = results.length.toLocaleString();
            const outputDiv = document.getElementById('combinationsOutput');
            outputDiv.innerHTML = results.slice(0, 500).map(combo => 
                `<div class="flex flex-wrap gap-1 p-1 border-b border-gray-200 dark:border-gray-600">
                    ${combo.map(num => `<span class="number-ball text-sm w-8 h-8">${num}</span>`).join('')}
                </div>`
            ).join('');
            if (results.length > 500) outputDiv.innerHTML += '<p class="text-center mt-2">...and more</p>';
        }
        
        function clearCombinationsGenerator() {
            document.getElementById('comboNumbersInput').value = '';
            document.getElementById('combinationSize').value = '3';
            document.getElementById('combinationsOutput').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate sets to see results.</p>';
            document.getElementById('combinationCount').textContent = '0';
        }

        function generateWheelingSystemLab() {
            const wheelType = document.getElementById('wheelingSystemType').value;
            const system = wheelingSystems[wheelType];
            const numbers = [...new Set(parseNumbers(document.getElementById('wheelingNumbersInput').value))].sort((a, b) => a - b);

            if (numbers.length < system.numbers) {
                return showNotification(`This wheel requires ${system.numbers} numbers, but you only entered ${numbers.length}.`, 'error');
            }
            
            const tickets = system.wheel.map(ticketIndices => ticketIndices.map(index => numbers[index]));

            document.getElementById('wheelTicketCount').textContent = tickets.length;
            const outputDiv = document.getElementById('wheelingOutput');
            outputDiv.innerHTML = tickets.map(ticket => 
                `<div class="flex flex-wrap gap-1 p-1 border-b border-gray-200 dark:border-gray-600">
                    ${ticket.sort((a,b)=>a-b).map(num => `<span class="number-ball text-sm w-8 h-8">${num}</span>`).join('')}
                </div>`
            ).join('');
        }

        // Reverse Engineer Functions
        async function reverseEngineerNumbers() {
            const numbers = parseNumbers(document.getElementById('numbersToReverse').value);
            if (numbers.length === 0) return showNotification('Please enter numbers to reverse engineer!', 'error');

            const game = document.getElementById('reverseGame').value;
            const config = gameConfigs[game];
            const method = document.getElementById('reverseMethod').value;
            const analysis = getNumberAnalysis(numbers, config.mainPool);

            document.getElementById('reverseStats').innerHTML = `<p>Sum: ${analysis.sum}</p><p>Avg: ${analysis.avg.toFixed(2)}</p><p>Odd/Even: ${analysis.oddCount}/${analysis.evenCount}</p>`;
            document.getElementById('reversePatterns').innerHTML = `<p>Consecutive: ${analysis.consecutivePairs}</p><p>Primes: ${analysis.primes}</p>`;
            updateChart(charts.reverseChart, numbers, Array(numbers.length).fill(1));

            if (method === 'ai') {
                const aiDiv = document.getElementById('aiReverseAnalysis');
                const loading = document.getElementById('reverseLoading');
                const resultsDiv = document.getElementById('reverseSeeds');
                aiDiv.classList.remove('hidden');
                loading.classList.remove('hidden');
                resultsDiv.innerHTML = '';
                
                const prompt = `Given these lottery numbers: ${numbers.join(', ')}, what are some potential seed values or generation patterns that could have produced them? Be creative and analytical.`;
                try {
                    const aiResults = await callGeminiAPI(prompt);
                    resultsDiv.innerHTML = aiResults.replace(/\n/g, '<br>');
                } catch (e) {
                    resultsDiv.textContent = 'AI Analysis failed.';
                } finally {
                    loading.classList.add('hidden');
                }
            } else {
                 document.getElementById('aiReverseAnalysis').classList.add('hidden');
            }
            document.getElementById('reverseResults').innerHTML = `<p class="font-medium">Reverse Engineering Complete (${method})</p>`;
        }
        
        function clearReverseEngineer() {
            document.getElementById('numbersToReverse').value = '';
            ['reverseResults', 'reverseStats', 'reversePatterns'].forEach(id => document.getElementById(id).innerHTML = '');
            document.getElementById('aiReverseAnalysis').classList.add('hidden');
            clearChart(charts.reverseChart);
        }

        // Historical Data Functions
        function loadHistoricalData() {
            const source = document.getElementById('dataSource').value;
            if (source === 'sample') {
                const { config } = getGeneratorConfig();
                const drawCount = parseInt(document.getElementById('pastDraws').value) || 50;
                appState.historicalData = Array.from({ length: drawCount }, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (drawCount - i));
                    return {
                        date: date.toISOString().split('T')[0],
                        numbers: _.shuffle(Array.from({length:config.mainPool},(_,i)=>i+1)).slice(0,config.pickCount).sort((a,b)=>a-b),
                        bonus: _.shuffle(Array.from({length:config.bonusPool},(_,i)=>i+1)).slice(0,config.bonusCount).sort((a,b)=>a-b)
                    };
                });
                displayHistoricalData();
            } else if (source === 'csv') {
                const file = document.getElementById('csvUpload').files[0];
                if (!file) return showNotification('Please select a CSV file!', 'error');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const { config } = getGeneratorConfig();
                    const lines = e.target.result.split('\n').slice(1).filter(line => line.trim());
                    appState.historicalData = lines.map(line => {
                        const [date, ...nums] = line.split(',');
                        return {
                            date,
                            numbers: nums.slice(0, config.pickCount).map(Number),
                            bonus: nums.slice(config.pickCount, config.pickCount + config.bonusCount).map(Number)
                        };
                    });
                    displayHistoricalData();
                };
                reader.readAsText(file);
            }
        }

        function displayHistoricalData() {
            const tableBody = document.getElementById('historicalTable').querySelector('tbody');
            if (appState.historicalData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">No data loaded</td></tr>`;
                return;
            }
            
            const start = (appState.currentPage - 1) * appState.drawsPerPage;
            const end = start + appState.drawsPerPage;
            const paginatedData = appState.historicalData.slice(start, end);
            
            tableBody.innerHTML = paginatedData.map(draw => `
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                    <td class="p-2">${draw.date}</td>
                    <td class="p-2"><div class="flex flex-wrap gap-1">${draw.numbers.map(n => `<span class="number-ball">${n}</span>`).join('')}</div></td>
                    <td class="p-2"><div class="flex flex-wrap gap-1">${draw.bonus.map(n => `<span class="number-ball bonus-ball">${n}</span>`).join('')}</div></td>
                    <td class="p-2">${_.sum(draw.numbers)}</td>
                    <td class="p-2">${draw.numbers.filter(n => n % 2 === 1).length}/${draw.numbers.filter(n => n % 2 === 0).length}</td>
                </tr>
            `).join('');
            
            document.getElementById('paginationInfo').textContent = `Showing ${start + 1}-${Math.min(end, appState.historicalData.length)} of ${appState.historicalData.length}`;
            document.getElementById('prevPage').disabled = appState.currentPage === 1;
            document.getElementById('nextPage').disabled = end >= appState.historicalData.length;
            
            updateDataSummary();
        }
        
        function updateDataSummary() {
            if (appState.historicalData.length === 0) return;
            const frequency = getNumberFrequency();
            const gaps = getGapAnalysis();
            
            const mostFreq = Object.entries(frequency).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([num])=>num);
            document.getElementById('mostFrequent').innerHTML = mostFreq.map(n => `<span class="number-ball hot-number">${n}</span>`).join('');
            
            const leastFreq = Object.entries(frequency).sort((a,b)=>a[1]-b[1]).slice(0,5).map(([num])=>num);
            document.getElementById('leastFrequent').innerHTML = leastFreq.map(n => `<span class="number-ball cold-number">${n}</span>`).join('');
            
            const due = Object.entries(gaps).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([num])=>num);
            document.getElementById('dueNumbers').innerHTML = due.map(n => `<span class="number-ball due-number">${n}</span>`).join('');
            
            document.getElementById('dataSummary').innerHTML = `<p>Total Draws: ${appState.historicalData.length}</p>`;
        }

        // Helper & Utility Functions
        function parseNumbers(inputString) { return inputString.split(/[\s,;\-\n]+/).map(Number).filter(n => !isNaN(n) && n > 0); }
        function countConsecutivePairs(numbers) { /* ... */ return 0; }
        function getNumberAnalysis(numbers, mainPool) { /* ... */ return { sum: _.sum(numbers), count: numbers.length, avg: _.mean(numbers), oddCount: 0, evenCount: 0, primes: 0, consecutivePairs: 0, gaps: [], stdDev: 0, spread: 0 }; }
        function getNumberFrequency() { return _.countBy(appState.historicalData.flatMap(d => d.numbers)); }
        function getGapAnalysis() { /* ... */ return {}; }
        function detectUnusedFromInput(inputNumbers, mainPool) { /* ... */ return { unusedNumbers: [] }; }
        function updateChart(chart, labels, data) { if(chart){ chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update(); } }
        function clearChart(chart) { if(chart){ chart.data.labels = []; chart.data.datasets[0].data = []; chart.update(); } }
        function createLoadingIndicator() { const i = document.createElement('span'); i.className = 'loading-indicator'; return i; }
        function getCombinations(source, size) { if(size > source.length || size<=0) return []; const res = []; function backtrack(start, path){ if(path.length === size){ res.push([...path]); return; } for(let i=start; i<source.length; i++){ path.push(source[i]); backtrack(i+1, path); path.pop(); } } backtrack(0, []); return res; }
        function getPermutations(source, size) { if(size > source.length || size<=0) return []; const res = []; function backtrack(path, used){ if(path.length === size){ res.push([...path]); return; } for(let i=0; i<source.length; i++){ if(used[i]) continue; used[i] = true; path.push(source[i]); backtrack(path, used); path.pop(); used[i] = false; } } backtrack([], Array(source.length).fill(false)); return res; }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showNotification('Copied to clipboard!'), () => showNotification('Copy failed!', 'error')); }
        function copyAllCombinations() { const text = Array.from(document.getElementById('combinationsOutput').children).map(el => el.textContent.trim().replace(/\s+/g, ',')).join('\n'); copyToClipboard(text); }
        function exportTickets(format) { /* ... */ }
        function exportTicketsTxt() { exportTickets('txt'); }
        function exportTicketsCsv() { exportTickets('csv'); }
        function copyTickets() { /* ... */ }
        function saveTickets() { /* ... */ }
        function prevPage() { if(appState.currentPage > 1) { appState.currentPage--; displayHistoricalData(); } }
        function nextPage() { const totalPages = Math.ceil(appState.historicalData.length / appState.drawsPerPage); if(appState.currentPage < totalPages) { appState.currentPage++; displayHistoricalData(); } }
        function loadSettings() { /* ... */ }
        function saveSettings() { /* ... */ }
        function handleQuickAction(e) { /* ... */ }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
