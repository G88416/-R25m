<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto Genius Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                        accent: '#10B981',
                        dark: '#1F2937',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles for body and typography */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sidebar transition for smooth hide/show */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* Chart container to manage max height and responsiveness */
        .chart-container {
            max-height: 200px; /* Limits height for smaller screens, responsive width */
            width: 100%; /* Ensures charts take full available width */
        }
        /* Styling for number balls */
        .number-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px; /* Slightly larger for better touch target */
            height: 36px; /* Slightly larger for better touch target */
            border-radius: 50%;
            background-color: #3B82F6;
            color: white;
            font-weight: bold;
            margin: 4px; /* Increased margin for better spacing on mobile */
            flex-shrink: 0; /* Prevent shrinking on small screens */
        }
        .bonus-ball {
            background-color: #8B5CF6;
        }
        .hot-number {
            background-color: #EF4444;
        }
        .cold-number {
            background-color: #3B82F6;
        }
        .due-number {
            background-color: #F59E0B;
        }

        /* Responsive adjustments for main content area */
        @media (min-width: 768px) { /* md breakpoint */
            .main-content-area {
                margin-left: 16rem; /* Equivalent to md:ml-64 */
            }
        }
        /* General button styling for better touch targets */
        button {
            padding: 0.75rem 1rem; /* Increase padding for better touch area */
            border-radius: 0.5rem; /* More rounded corners */
            font-weight: 500; /* Medium font weight */
            transition: background-color 0.2s ease-in-out;
        }
        /* Textarea and input styling for consistency */
        textarea, input[type="text"], input[type="number"], select {
            padding: 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB; /* Light gray border */
        }
        .dark textarea, .dark input[type="text"], .dark input[type="number"], .dark select {
            border-color: #4B5563; /* Darker border in dark mode */
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-900 dark:text-white transition-colors duration-300">
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg p-4 sidebar z-40 md:translate-x-0 sidebar-hidden">
        <div class="flex items-center mb-6">
            <h1 class="text-2xl font-bold text-primary">Lotto Genius</h1>
            <span class="ml-2 px-2 py-1 text-xs bg-accent text-white rounded-full">PRO</span>
        </div>
        <nav>
            <ul class="space-y-2">
                <li><a href="#dashboard" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üìä Dashboard</a></li>
                <li><a href="#generator" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üé∞ Smart Generator</a></li>
                <li><a href="#analyzer" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üîç Advanced Analyzer</a></li>
                <li><a href="#seed-reverser" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üîÑ Seed Reverser</a></li>
                <li><a href="#historical" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üìà Historical Data</a></li>
                <li><a href="#strategies" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üß† AI Strategies</a></li>
                <li><a href="#probability" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üìâ Probability Lab</a></li>
                <li><a href="#prediction" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">üîÆ Prediction Engine</a></li>
                <li><a href="#settings" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">‚öôÔ∏è Settings</a></li>
            </ul>
        </nav>
    </aside>

    <div class="ml-0 p-4 main-content-area">
        <header class="flex justify-between items-center mb-6">
            <button id="toggleSidebar" class="md:hidden p-2 bg-primary text-white rounded-lg">‚ò∞</button>
            <div class="flex space-x-4">
                <button id="themeToggle" class="p-2 bg-primary text-white rounded-lg">üåô Toggle Theme</button>
                <button id="notifications" class="p-2 bg-secondary text-white rounded-lg relative">
                    üîî Notifications
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </header>

        <main class="space-y-6">
            <section id="dashboard" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Recent Activity</h3>
                        <div id="recentActivity" class="text-sm">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Quick Actions</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-action p-2 bg-primary text-white rounded-lg text-sm" data-action="quickPick">Quick Pick</button>
                            <button class="quick-action p-2 bg-secondary text-white rounded-lg text-sm" data-action="analyzeLast">Analyze Last</button>
                            <button class="quick-action p-2 bg-accent text-white rounded-lg text-sm" data-action="checkOdds">Check Odds</button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Statistics</h3>
                        <div id="statsOverview" class="text-sm">
                            <p>Generate numbers to see statistics</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency Heatmap</h3>
                        <canvas id="dashboardHeatmap" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Recent Patterns</h3>
                        <canvas id="dashboardPatterns" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <section id="generator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Smart Number Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Game Setup</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Lottery Game</label>
                            <select id="lotteryGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="mainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="pickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="bonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="bonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Random Seed</label>
                            <div class="flex gap-2">
                                <input id="randomSeed" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="Enter seed">
                                <button id="randomSeedBtn" class="p-2 bg-primary text-white rounded-lg">üé≤ Random</button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Generation Method</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Algorithm</label>
                            <select id="generationMethod" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="standard">Standard Random</option>
                                <option value="fisherYates">Fisher-Yates Shuffle</option>
                                <option value="crypto">Cryptographically Secure</option>
                                <option value="lowHigh">Low-High Balance</option>
                                <option value="oddEven">Odd-Even Balance</option>
                                <option value="prime">Prime Number Filter</option>
                                <option value="fibonacci">Fibonacci Filter</option>
                                <option value="statistical">Statistical Weighted</option>
                                <option value="ai">AI-Powered ‚ú®</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Historical Filters</label>
                            <div class="space-y-1">
                                <label class="flex items-center"><input id="useHistorical" type="checkbox" class="mr-2"> Use Historical Data</label>
                                <label class="flex items-center"><input id="favorHot" type="checkbox" class="mr-2"> Favor Hot Numbers</label>
                                <label class="flex items-center"><input id="includeDue" type="checkbox" class="mr-2"> Include Due Numbers</label>
                                <label class="flex items-center"><input id="avoidRepeats" type="checkbox" class="mr-2"> Avoid Recent Repeats</label>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Advanced Options</h3>
                        <div>
                            <label class="block text-sm font-medium">Number of Tickets</label>
                            <input id="numTickets" type="number" min="1" max="100" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Sum Filter</label>
                            <select id="sumFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Sum</option>
                                <option value="low">Low Sum</option>
                                <option value="medium">Medium Sum</option>
                                <option value="high">High Sum</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Consecutive Numbers</label>
                            <select id="consecutiveFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Consecutives</option>
                                <option value="none">No Consecutives</option>
                                <option value="max1">Max 1 Pair</option>
                                <option value="max2">Max 2 Pairs</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">Quick Actions</h3>
                    <div class="flex flex-wrap gap-2">
                        <button id="generateSmart" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700">Generate Smart Numbers</button>
                        <button id="quickPick" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Quick Pick (Random)</button>
                        <button id="generateWheeling" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700">Generate Wheeling System</button>
                        <button id="clearGenerator" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear All</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Tip: Combine AI-Powered generation with historical data for statistically optimized numbers.</p>
                </div>

                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-medium">Generated Tickets</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="exportTxt" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">TXT</button>
                            <button id="exportCsv" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">CSV</button>
                            <button id="copyTickets" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                            <button id="saveTickets" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 text-sm">Save</button>
                        </div>
                    </div>
                    <div id="generatedTickets" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20">
                        <p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency</h3>
                        <canvas id="numberFrequencyChart" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Sum Analysis</h3>
                        <canvas id="sumAnalysisChart" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Pattern Analysis</h3>
                        <canvas id="patternAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <section id="analyzer" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Number Analyzer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="analyzerGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Numbers to Analyze</label>
                            <textarea id="numbersToAnalyze" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: 5,12,23,34,45,6 or 5 12 23 34 45 6 or 5-12-23-34-45-6</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="analyzeNumbers" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Analyze</button>
                            <button id="getAIInsights" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">AI Insights ‚ú®</button>
                            <button id="clearAnalyzer" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Sample Inputs</h4>
                            <div class="text-xs space-y-1 mt-1">
                                <button class="sample-input text-primary hover:underline" data-sample="5,12,23,34,45,6">Powerball</button><br>
                                <button class="sample-input text-primary hover:underline" data-sample="3,18,29,41,52,15">Mega Millions</button><br>
                                <button class="sample-input text-primary hover:underline" data-sample="7,14,21,28,35">Lotto 6/49</button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Basic Analysis</h3>
                        <div id="analysisResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Number Properties</h4>
                                <div id="numberProps" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Pattern Analysis</h4>
                                <div id="patternStats" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Visual Analysis</h4>
                            <div id="visualAnalysis" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div id="aiInsightsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">AI Insights</h4>
                            <div id="aiInsightsText" class="text-xs mt-1"></div>
                            <div id="aiInsightsLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-medium">Advanced Metrics</h3>
                            <button id="exportAnalysis" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Basic Statistics</h4>
                                <div id="basicStats" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Advanced Metrics</h4>
                                <div id="advancedMetrics" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Number Frequency</h4>
                            <canvas id="freqDistributionChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Last Digit Distribution</h4>
                        <canvas id="lastDigitDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Number Sum Distribution</h4>
                        <canvas id="sumDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Odd/Even Distribution</h4>
                        <canvas id="oddEvenDistributionChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <section id="seed-reverser" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advance Lotto Seed Reverser</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers for Profile</h3>
                        <div>
                            <label class="block text-sm font-medium">Lottery Game</label>
                            <select id="seedReverseGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Numbers to Reverse Analyze</label>
                            <textarea id="numbersToReverse" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: 5,12,23,34,45,6 or 5 12 23 34 45 6</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="reverseSeedBtn" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Generate Seed Profile</button>
                            <button id="interpretSeedProfile" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">Interpret Profile ‚ú®</button>
                            <button id="clearSeedReverse" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Generated Seed Profile</h3>
                        <div id="seedProfileResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers and generate profile</p>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Statistical Characteristics</h4>
                                <div id="seedStats" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Pattern Indicators</h4>
                                <div id="seedPatterns" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Visual Representation</h4>
                            <div id="seedVisuals" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div id="seedInterpretationOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">AI Interpretation</h4>
                            <div id="seedInterpretationText" class="text-xs mt-1"></div>
                            <div id="seedInterpretationLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="historical" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Historical Data Explorer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Source</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="historicalGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Data Source</label>
                            <select id="dataSource" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="sample">Sample Data (Built-in)</option>
                                <option value="api">Live API (Premium)</option>
                                <option value="csv">Upload CSV</option>
                            </select>
                        </div>
                        
                        <div id="csvUploadContainer" class="hidden">
                            <label class="block text-sm font-medium">Upload CSV File</label>
                            <input id="csvUpload" type="file" accept=".csv" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">CSV format: Date,Number1,Number2,...,Bonus1,Bonus2</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Number of Past Draws</label>
                            <select id="pastDraws" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="10">10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">500</option>
                                <option value="all">All Available</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="loadData" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Load Data</button>
                            <button id="clearHistorical" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Summary</h3>
                        <div id="dataSummary" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Load historical data to see summary</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Most Frequent</h4>
                                <div id="mostFrequent" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Least Frequent</h4>
                                <div id="leastFrequent" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Due Numbers</h4>
                            <div id="dueNumbers" class="text-xs mt-1"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-medium">Quick Analysis</h3>
                            <button id="exportHistorical" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Recent Trends</h4>
                            <div id="recentTrends" class="text-xs mt-1"></div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Pattern Frequency</h4>
                            <div id="patternFrequency" class="text-xs mt-1"></div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Sum Statistics</h4>
                            <div id="sumStatistics" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-xl font-medium mb-2">Historical Draws</h3>
                    <div class="overflow-x-auto">
                        <table id="historicalTable" class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700">
                                    <th class="p-2 text-left">Date</th>
                                    <th class="p-2 text-left">Numbers</th>
                                    <th class="p-2 text-left">Bonus</th>
                                    <th class="p-2 text-left">Sum</th>
                                    <th class="p-2 text-left">Odd/Even</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr>
                                    <td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-2 gap-2">
                        <div class="text-sm text-gray-600 dark:text-gray-400" id="paginationInfo">Showing 0 of 0</div>
                        <div class="flex gap-2">
                            <button id="prevPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled><</button>
                            <button id="nextPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>></button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Number Frequency Heatmap</h4>
                        <canvas id="freqHeatmapChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Frequency Over Time</h4>
                        <canvas id="freqOverTimeChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Gap Analysis</h4>
                        <canvas id="gapAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <section id="strategies" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">AI-Powered Strategies</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-primary">
                        <h3 class="text-xl font-medium">Frequency Analysis</h3>
                        <p class="text-sm mt-2">Identifies hot (frequently drawn) and cold (rarely drawn) numbers based on historical data patterns.</p>
                        <button class="applyStrategy mt-4 p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full" data-strategy="frequency">Apply Strategy</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-secondary">
                        <h3 class="text-xl font-medium">Gap Analysis</h3>
                        <p class="text-sm mt-2">Finds numbers that are statistically "due" to be drawn based on the time since their last appearance.</p>
                        <button class="applyStrategy mt-4 p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 w-full" data-strategy="gap">Apply Strategy</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-accent">
                        <h3 class="text-xl font-medium">Pattern Recognition</h3>
                        <p class="text-sm mt-2">Detects number patterns and sequences that frequently occur in winning combinations.</p>
                        <button class="applyStrategy mt-4 p-2 bg-accent text-white rounded-lg hover:bg-green-700 w-full" data-strategy="pattern">Apply Strategy</button>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-4">Custom Strategy Builder</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium">Strategy Components</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="frequency" checked> Number Frequency</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="gap" checked> Gap Analysis</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="pattern"> Pattern Recognition</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="sum"> Sum Analysis</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="prime"> Prime Numbers</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="fibonacci"> Fibonacci Numbers</label>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium">Weighting</h4>
                            <div class="space-y-2 mt-2">
                                <div>
                                    <label class="block text-sm">Frequency Importance</label>
                                    <input id="freqWeight" type="range" min="0" max="100" value="40" class="w-full">
                                    <span id="freqWeightValue" class="text-xs">40%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Gap Importance</label>
                                    <input id="gapWeight" type="range" min="0" max="100" value="30" class="w-full">
                                    <span id="gapWeightValue" class="text-xs">30%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Pattern Importance</label>
                                    <input id="patternWeight" type="range" min="0" max="100" value="20" class="w-full">
                                    <span id="patternWeightValue" class="text-xs">20%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Other Importance</label>
                                    <input id="otherWeight" type="range" min="0" max="100" value="10" class="w-full">
                                    <span id="otherWeightValue" class="text-xs">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="buildStrategy" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Build & Apply Custom Strategy</button>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">Strategy Results</h3>
                    <div id="strategyResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-gray-500 dark:text-gray-400">Apply a strategy to see recommendations</p>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Recommended Numbers</h4>
                            <div id="recommendedNumbers" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Strategy Analysis</h4>
                            <div id="strategyAnalysis" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="probability" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Probability Laboratory</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Probability Calculator</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="probabilityGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Numbers to Match (Main Pool)</label>
                            <input id="matchMain" type="number" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Numbers to Match (Bonus Pool)</label>
                            <input id="matchBonus" type="number" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="1">
                        </div>
                        <button id="calculateProbability" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Calculate Probability</button>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Results</h3>
                        <div id="probabilityResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Select game and matches to calculate odds</p>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Odds in 1 to X</h4>
                            <div id="oddsInverse" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="prediction" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Lotto Prediction Engine</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Prediction Parameters</h3>
                        <div>
                            <label class="block text-sm font-medium">Lottery Game</label>
                            <select id="predictionGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Prediction Model</label>
                            <select id="predictionModel" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="rnn">Recurrent Neural Network (Simulated)</option>
                                <option value="lstm">LSTM (Simulated)</option>
                                <option value="markov">Markov Chain</option>
                                <option value="regression">Linear Regression</option>
                            </select>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Note: Simulated models offer conceptual insights; real-world AI requires substantial data and processing.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Confidence Level (%)</label>
                            <input id="confidenceLevel" type="number" min="50" max="99" value="70" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                        </div>
                        <button id="generatePrediction" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Generate Prediction</button>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Predicted Numbers</h3>
                        <div id="predictionResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Generate a prediction to see results</p>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Prediction Insights</h4>
                            <div id="predictionInsights" class="text-xs mt-1"></div>
                            <div id="predictionLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Prediction Certainty Chart</h4>
                            <canvas id="predictionCertaintyChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">General Settings</h3>
                        <div>
                            <label class="block text-sm font-medium">Default Lottery Game</label>
                            <select id="defaultGameSetting" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Notifications</label>
                            <label class="flex items-center mt-2"><input id="enableNotifications" type="checkbox" class="mr-2" checked> Enable Pop-up Notifications</label>
                        </div>
                        <button id="saveSettings" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Save Settings</button>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Management</h3>
                        <p class="text-sm">Manage your stored historical data and application state.</p>
                        <button id="clearAllData" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600 w-full">Clear All Local Data</button>
                        <button id="exportAllData" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 w-full">Export All Data (JSON)</button>
                        <button id="importData" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 w-full">Import Data (JSON)</button>
                        <input id="importFileInput" type="file" accept=".json" class="hidden">
                    </div>
                </div>
            </section>
        </main>

        <div id="notificationToast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl hidden z-50">
            <p id="notificationMessage"></p>
        </div>
    </div>

    <script>
        // --- Global Application State and Persistence ---
        const appState = {
            historicalData: [], // Stores all historical draws {date: "YYYY-MM-DD", numbers: [n1, n2, ...], bonus: [b1, ...]}
            gameConfig: {
                powerball: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1 },
                megamillions: { mainPool: 70, pickCount: 5, bonusPool: 25, bonusCount: 1 },
                euromillions: { mainPool: 50, pickCount: 5, bonusPool: 12, bonusCount: 2 },
                lotto649: { mainPool: 49, pickCount: 6, bonusPool: 0, bonusCount: 0 },
                lotto645: { mainPool: 45, pickCount: 6, bonusPool: 0, bonusCount: 0 },
                custom: { mainPool: 1, pickCount: 1, bonusPool: 0, bonusCount: 0 } // Placeholder
            },
            currentDraws: [], // Stores generated tickets
            settings: {
                theme: 'dark', // 'light' or 'dark'
                notifications: true,
                defaultGame: 'powerball'
            }
        };

        function saveAppState() {
            localStorage.setItem('lottoGeniusProState', JSON.stringify(appState));
        }

        function loadAppState() {
            const storedState = localStorage.getItem('lottoGeniusProState');
            if (storedState) {
                Object.assign(appState, JSON.parse(storedState));
                // Ensure historicalData is an array and numbers are sorted if loaded
                if (appState.historicalData && Array.isArray(appState.historicalData)) {
                    appState.historicalData.forEach(draw => {
                        if (draw.numbers) draw.numbers.sort((a, b) => a - b);
                        if (draw.bonus) draw.bonus.sort((a, b) => a - b);
                    });
                } else {
                    appState.historicalData = []; // Reset if corrupted
                }
            }
        }

        // --- Utility Functions ---
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const msgElement = document.getElementById('notificationMessage');
            if (!appState.settings.notifications) return;

            msgElement.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-xl z-50 ${type === 'danger' ? 'bg-red-600' : type === 'warning' ? 'bg-orange-500' : 'bg-gray-900'} text-white block animate-fade-in-up`;
            
            setTimeout(() => {
                toast.classList.add('animate-fade-out-down');
                toast.classList.remove('animate-fade-in-up');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('animate-fade-out-down');
                }, 500); // Wait for fade-out animation
            }, 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark:bg-dark');
            document.body.classList.toggle('dark:text-white');
            document.body.classList.toggle('bg-gray-50');
            document.body.classList.toggle('text-gray-900');

            const isDarkMode = document.body.classList.contains('dark:bg-dark');
            appState.settings.theme = isDarkMode ? 'dark' : 'light';
            saveAppState();
            document.getElementById('themeToggle').textContent = isDarkMode ? '‚òÄÔ∏è Light Theme' : 'üåô Dark Theme';
        }

        function getGameParams(gameType) {
            return appState.gameConfig[gameType] || appState.gameConfig.powerball; // Default to Powerball
        }

        function isPrime(num) {
            if (num <= 1) return false;
            for (let i = 2; i * i <= num; i++) {
                if (num % i === 0) return false;
            }
            return true;
        }

        function isFibonacci(num) {
            if (num < 0) return false;
            const isPerfectSquare = (n) => Number.isInteger(Math.sqrt(n));
            return isPerfectSquare(5 * num * num + 4) || isPerfectSquare(5 * num * num - 4);
        }
        
        // --- Number Generation Logic ---
        function generateNumbers(gameType, method, options = {}) {
            const params = getGameParams(gameType);
            const { mainPool, pickCount, bonusPool, bonusCount } = params;
            let numbers = [];
            let bonusNumbers = [];

            // Helper to generate a unique random number from a pool
            const generateUniqueRandom = (poolMax, count, exclude = []) => {
                const pool = Array.from({ length: poolMax }, (_, i) => i + 1).filter(n => !exclude.includes(n));
                if (pool.length < count) {
                    showNotification('Not enough unique numbers available for generation given filters.', 'warning');
                    return [];
                }
                const result = [];
                for (let i = 0; i < count; i++) {
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    result.push(pool[randomIndex]);
                    pool.splice(randomIndex, 1); // Remove to ensure uniqueness
                }
                return result.sort((a, b) => a - b);
            };

            // Cryptographically Secure Random Number Generation (CSRNG)
            const getCryptoRandomNumbers = (poolMax, count, exclude = []) => {
                if (typeof window.crypto === 'undefined' || typeof window.crypto.getRandomValues === 'undefined') {
                    showNotification('Cryptographically secure random numbers not supported. Falling back to standard random.', 'warning');
                    return generateUniqueRandom(poolMax, count, exclude);
                }
                const numbers = new Set();
                while (numbers.size < count) {
                    const array = new Uint32Array(1);
                    window.crypto.getRandomValues(array);
                    const num = (array[0] % poolMax) + 1;
                    if (!exclude.includes(num)) {
                        numbers.add(num);
                    }
                }
                return Array.from(numbers).sort((a, b) => a - b);
            };

            // Statistical Weighting - more sophisticated logic
            const getStatisticalWeightedNumbers = (poolMax, count, historicalData, exclude = []) => {
                if (!historicalData || historicalData.length < 50) { // Need sufficient data for weighting
                    showNotification('Insufficient historical data for statistical weighting. Using standard random.', 'warning');
                    return generateUniqueRandom(poolMax, count, exclude);
                }

                const frequencies = {};
                for (let i = 1; i <= poolMax; i++) {
                    frequencies[i] = 0;
                }
                historicalData.forEach(draw => {
                    draw.numbers.forEach(n => {
                        if (n <= poolMax) frequencies[n]++;
                    });
                    if (draw.bonus) { // Include bonus numbers in main pool frequency if applicable
                        draw.bonus.forEach(b => {
                            if (b <= poolMax) frequencies[b]++;
                        });
                    }
                });

                const hotNumbers = Object.entries(frequencies)
                                     .sort(([, a], [, b]) => b - a)
                                     .slice(0, Math.floor(poolMax * 0.2)) // Top 20% most frequent
                                     .map(([num]) => parseInt(num));
                const coldNumbers = Object.entries(frequencies)
                                      .sort(([, a], [, b]) => a - b)
                                      .slice(0, Math.floor(poolMax * 0.2)) // Bottom 20% least frequent
                                      .map(([num]) => parseInt(num));
                
                const weightedPool = [];
                for (let i = 1; i <= poolMax; i++) {
                    if (exclude.includes(i)) continue;
                    let weight = 1;
                    if (hotNumbers.includes(i)) {
                        weight = options.favorHot ? 3 : 1.5; // Favor hot more if option is set
                    } else if (coldNumbers.includes(i)) {
                        weight = 0.5; // Less likely for cold numbers
                    }

                    // Add number to weighted pool based on its weight
                    for (let j = 0; j < weight * 10; j++) { // Multiply by 10 to ensure integer weights
                        weightedPool.push(i);
                    }
                }
                
                return generateUniqueRandom(poolMax, count, exclude, weightedPool); // Use weighted pool for selection
            };

            // AI-Powered generation (conceptual, combines statistical insights)
            const getAIPoweredNumbers = (gameType, historicalData, exclude = []) => {
                if (!historicalData || historicalData.length < 100) { // More data needed for "AI"
                    showNotification('Insufficient historical data for AI-Powered generation. Using statistical weighting.', 'warning');
                    return getStatisticalWeightedNumbers(mainPool, pickCount, historicalData, exclude);
                }

                const freqAnalysis = calculateFrequency(historicalData, mainPool);
                const gapAnalysis = calculateGapAnalysis(historicalData, mainPool);
                const hotNumbers = freqAnalysis.hot;
                const dueNumbers = gapAnalysis.due; // Numbers overdue
                
                const potentialNumbers = Array.from({ length: mainPool }, (_, i) => i + 1);
                let candidates = [];

                // Combine influence from hot, due, and general distribution
                const combinedWeights = {};
                potentialNumbers.forEach(num => {
                    let weight = 1;
                    if (hotNumbers.includes(num)) weight += 2; // Strong preference for hot numbers
                    if (dueNumbers.includes(num)) weight += 1.5; // Moderate preference for due numbers
                    
                    // Add a slight bias based on overall frequency, but less than hot/due
                    const numFreq = freqAnalysis.overall[num] || 0;
                    weight += numFreq / (historicalData.length * 0.5); // Normalize frequency

                    combinedWeights[num] = weight;
                });

                // Sort candidates by combined weight and pick the top `pickCount`
                candidates = Object.entries(combinedWeights)
                               .sort(([, a], [, b]) => b - a)
                               .map(([num]) => parseInt(num))
                               .filter(n => !exclude.includes(n));

                return _.take(candidates, pickCount).sort((a,b) => a-b);
            };

            const allNumbers = Array.from({ length: mainPool }, (_, i) => i + 1);

            switch (method) {
                case 'standard':
                    numbers = generateUniqueRandom(mainPool, pickCount);
                    break;
                case 'fisherYates':
                    numbers = _.sampleSize(allNumbers, pickCount).sort((a,b) => a-b);
                    break;
                case 'crypto':
                    numbers = getCryptoRandomNumbers(mainPool, pickCount);
                    break;
                case 'lowHigh':
                    // Target a balance of low and high numbers
                    const lowNumbers = allNumbers.filter(n => n <= mainPool / 2);
                    const highNumbers = allNumbers.filter(n => n > mainPool / 2);
                    const numLow = Math.floor(pickCount / 2);
                    const numHigh = pickCount - numLow;
                    numbers = [..._.sampleSize(lowNumbers, numLow), ..._.sampleSize(highNumbers, numHigh)].sort((a,b) => a-b);
                    break;
                case 'oddEven':
                    // Target a balance of odd and even numbers
                    const oddNumbers = allNumbers.filter(n => n % 2 !== 0);
                    const evenNumbers = allNumbers.filter(n => n % 2 === 0);
                    const numOdd = Math.floor(pickCount / 2);
                    const numEven = pickCount - numOdd;
                    numbers = [..._.sampleSize(oddNumbers, numOdd), ..._.sampleSize(evenNumbers, numEven)].sort((a,b) => a-b);
                    break;
                case 'prime':
                    numbers = _.sampleSize(allNumbers.filter(isPrime), pickCount).sort((a,b) => a-b);
                    if (numbers.length < pickCount) {
                        showNotification('Not enough prime numbers for selection. Filling with random.', 'warning');
                        const remaining = pickCount - numbers.length;
                        numbers = [...numbers, ...generateUniqueRandom(mainPool, remaining, numbers)].sort((a,b) => a-b);
                    }
                    break;
                case 'fibonacci':
                    numbers = _.sampleSize(allNumbers.filter(isFibonacci), pickCount).sort((a,b) => a-b);
                    if (numbers.length < pickCount) {
                        showNotification('Not enough Fibonacci numbers for selection. Filling with random.', 'warning');
                        const remaining = pickCount - numbers.length;
                        numbers = [...numbers, ...generateUniqueRandom(mainPool, remaining, numbers)].sort((a,b) => a-b);
                    }
                    break;
                case 'statistical':
                    numbers = getStatisticalWeightedNumbers(mainPool, pickCount, appState.historicalData, []);
                    break;
                case 'ai':
                    numbers = getAIPoweredNumbers(gameType, appState.historicalData, []);
                    break;
                default:
                    numbers = generateUniqueRandom(mainPool, pickCount);
            }

            // Apply historical filters after initial generation
            if (options.useHistorical && appState.historicalData.length > 0) {
                const hotNumbers = calculateFrequency(appState.historicalData, mainPool).hot;
                const dueNumbers = calculateGapAnalysis(appState.historicalData, mainPool).due;
                const recentDraws = appState.historicalData.slice(0, 10).flatMap(d => [...d.numbers, ...(d.bonus || [])]); // Last 10 draws

                let filteredNumbers = [...numbers]; // Start with generated numbers

                if (options.favorHot) {
                    // Try to replace cold numbers with hot ones if available and not already in numbers
                    const currentCold = filteredNumbers.filter(n => !hotNumbers.includes(n));
                    const availableHot = hotNumbers.filter(n => !filteredNumbers.includes(n));
                    for (let i = 0; i < currentCold.length && availableHot.length > 0; i++) {
                        const replaceIndex = filteredNumbers.indexOf(currentCold[i]);
                        if (replaceIndex !== -1) {
                            filteredNumbers[replaceIndex] = availableHot.shift();
                        }
                    }
                }

                if (options.includeDue) {
                    // Try to include due numbers if not already present, possibly replacing less "important" numbers
                    dueNumbers.forEach(dueNum => {
                        if (!filteredNumbers.includes(dueNum) && filteredNumbers.length < pickCount) {
                            filteredNumbers.push(dueNum);
                        } else if (!filteredNumbers.includes(dueNum) && filteredNumbers.length === pickCount) {
                            // Replace a non-hot, non-due, non-recent number if possible
                            const replaceableIndex = filteredNumbers.findIndex(n => !hotNumbers.includes(n) && !dueNumbers.includes(n) && !recentDraws.includes(n));
                            if (replaceableIndex !== -1) {
                                filteredNumbers[replaceableIndex] = dueNum;
                            }
                        }
                    });
                }

                if (options.avoidRepeats) {
                    filteredNumbers = filteredNumbers.filter(n => !recentDraws.includes(n));
                    // If filtering removed too many numbers, refill randomly
                    while (filteredNumbers.length < pickCount) {
                        const newNum = generateUniqueRandom(mainPool, 1, [...filteredNumbers, ...recentDraws])[0];
                        if (newNum) filteredNumbers.push(newNum);
                        else break; // Avoid infinite loop if no more numbers available
                    }
                }
                numbers = _.take(_.uniq(filteredNumbers).sort((a,b) => a-b), pickCount); // Ensure unique and correct count
            }
            
            // Generate bonus numbers if applicable
            if (bonusCount > 0) {
                bonusNumbers = generateUniqueRandom(bonusPool, bonusCount, numbers);
            }

            return { numbers, bonusNumbers };
        }

        // --- Number Analysis Logic ---
        function analyzeNumbers(inputString, gameType) {
            const params = getGameParams(gameType);
            const { mainPool, pickCount, bonusPool, bonusCount } = params;

            const parsedNumbers = inputString.split(/[, ]+/).map(Number).filter(n => !isNaN(n) && n > 0);
            
            if (parsedNumbers.length === 0) {
                showNotification('Please enter valid numbers to analyze.', 'danger');
                return;
            }

            // Separate main and bonus numbers based on game config
            let numbers = [];
            let bonus = [];

            if (bonusCount > 0) {
                // For games with bonus numbers, assume the last `bonusCount` are bonus numbers
                // This is a simplification; a more robust solution would distinguish based on ranges
                numbers = parsedNumbers.slice(0, pickCount).sort((a, b) => a - b);
                bonus = parsedNumbers.slice(pickCount, pickCount + bonusCount).sort((a, b) => a - b);
            } else {
                numbers = parsedNumbers.sort((a, b) => a - b);
            }

            // Basic Stats
            const sum = _.sum(numbers);
            const oddCount = numbers.filter(n => n % 2 !== 0).length;
            const evenCount = numbers.length - oddCount;
            const avg = sum / numbers.length;

            // Low/High Balance
            const lowCount = numbers.filter(n => n <= mainPool / 2).length;
            const highCount = numbers.length - lowCount;

            // Consecutive Numbers
            let consecutivePairs = 0;
            for (let i = 0; i < numbers.length - 1; i++) {
                if (numbers[i + 1] === numbers[i] + 1) {
                    consecutivePairs++;
                }
            }
            
            // Prime/Fibonacci counts
            const primeCount = numbers.filter(isPrime).length;
            const fibonacciCount = numbers.filter(isFibonacci).length;

            // Frequency and Gap Analysis (requires historical data)
            const historicalData = appState.historicalData;
            let hotColdStatus = {}; // {number: 'hot'|'cold'|'due'}
            if (historicalData.length > 0) {
                const freqAnalysis = calculateFrequency(historicalData, mainPool);
                const gapAnalysis = calculateGapAnalysis(historicalData, mainPool);

                numbers.forEach(num => {
                    if (freqAnalysis.hot.includes(num)) hotColdStatus[num] = 'hot';
                    else if (freqAnalysis.cold.includes(num)) hotColdStatus[num] = 'cold';
                    else if (gapAnalysis.due.includes(num)) hotColdStatus[num] = 'due';
                });
            }

            // Display results
            document.getElementById('analysisResults').innerHTML = `
                <p><strong>Numbers:</strong> ${numbers.join(', ')}${bonus.length > 0 ? ` + ${bonus.join(', ')}` : ''}</p>
                <p><strong>Game:</strong> ${gameType.charAt(0).toUpperCase() + gameType.slice(1)}</p>
                <p><strong>Total Sum:</strong> ${sum}</p>
                <p><strong>Average:</strong> ${avg.toFixed(2)}</p>
            `;

            document.getElementById('numberProps').innerHTML = `
                <p><strong>Odd/Even:</strong> ${oddCount}/${evenCount}</p>
                <p><strong>Low/High:</strong> ${lowCount}/${highCount}</p>
                <p><strong>Prime Count:</strong> ${primeCount}</p>
                <p><strong>Fibonacci Count:</strong> ${fibonacciCount}</p>
            `;

            document.getElementById('patternStats').innerHTML = `
                <p><strong>Consecutive Pairs:</strong> ${consecutivePairs}</p>
                <p><strong>Repeated Digits:</strong> (Requires more complex analysis)</p>
                <p><strong>Patterns:</strong> (e.g., sequences, groups)</p>
            `;

            // Visual Analysis
            const visualAnalysisDiv = document.getElementById('visualAnalysis');
            visualAnalysisDiv.innerHTML = '';
            [...numbers, ...bonus].forEach(num => {
                const span = document.createElement('span');
                span.classList.add('number-ball');
                if (bonus.includes(num) && bonusCount > 0) span.classList.add('bonus-ball');
                if (hotColdStatus[num] === 'hot') span.classList.add('hot-number');
                else if (hotColdStatus[num] === 'cold') span.classList.add('cold-number');
                else if (hotColdStatus[num] === 'due') span.classList.add('due-number');
                span.textContent = num;
                visualAnalysisDiv.appendChild(span);
            });

            // Update Advanced Metrics
            document.getElementById('basicStats').innerHTML = `
                <p><strong>Min:</strong> ${_.min(numbers)}</p>
                <p><strong>Max:</strong> ${_.max(numbers)}</p>
                <p><strong>Range:</strong> ${_.max(numbers) - _.min(numbers)}</p>
                <p><strong>Standard Deviation:</strong> (Needs calculation)</p>
            `;

            document.getElementById('advancedMetrics').innerHTML = `
                <p><strong>Frequency Rank:</strong> (From historical)</p>
                <p><strong>Last Drawn:</strong> (From historical)</p>
                <p><strong>Time Since Last Drawn:</strong> (From historical)</p>
            `;
            
            // Update Charts
            updateAnalysisCharts(numbers, bonus, mainPool, bonusPool);
        }

        // --- Historical Data Functions ---
        function loadHistoricalData(gameType, count = 'all') {
            const dataLoadStatus = document.getElementById('dataSummary');
            dataLoadStatus.innerHTML = `<p>Loading data for ${gameType}...</p>`;
            
            // This is a placeholder for actual data loading.
            // In a real app, you'd fetch from an API or a more extensive local database.
            // For now, let's generate some sample data if it's empty.
            if (appState.historicalData.length === 0 || count === 'sample') {
                const sampleData = generateSampleHistoricalData(gameType, count === 'all' ? 200 : parseInt(count) || 50);
                appState.historicalData = sampleData;
                saveAppState();
                showNotification(`Loaded ${appState.historicalData.length} sample draws for ${gameType}.`);
            } else {
                showNotification(`Using existing historical data (${appState.historicalData.length} draws) for ${gameType}.`);
            }
            
            displayHistoricalData();
            updateHistoricalDataCharts(gameType);
            updateDashboardStats();
        }

        function generateSampleHistoricalData(gameType, numDraws) {
            const params = getGameParams(gameType);
            const { mainPool, pickCount, bonusPool, bonusCount } = params;
            const data = [];
            for (let i = 0; i < numDraws; i++) {
                const date = new Date(Date.now() - i * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // Weekly draws
                const numbers = _.sampleSize(Array.from({ length: mainPool }, (_, x) => x + 1), pickCount).sort((a,b) => a-b);
                const bonus = bonusCount > 0 ? _.sampleSize(Array.from({ length: bonusPool }, (_, x) => x + 1), bonusCount).sort((a,b) => a-b) : [];
                data.push({ date, numbers, bonus });
            }
            return data;
        }

        function displayHistoricalData() {
            const tableBody = document.querySelector('#historicalTable tbody');
            tableBody.innerHTML = '';
            if (appState.historicalData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">No historical data loaded.</td></tr>';
                document.getElementById('paginationInfo').textContent = 'Showing 0 of 0';
                document.getElementById('prevPage').disabled = true;
                document.getElementById('nextPage').disabled = true;
                return;
            }

            // Simple pagination (conceptual, needs proper implementation with current page etc.)
            const currentPageData = appState.historicalData.slice(0, 100); // Show first 100 for now
            currentPageData.forEach(draw => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = draw.date;
                row.insertCell().textContent = draw.numbers.join(', ');
                row.insertCell().textContent = draw.bonus.length > 0 ? draw.bonus.join(', ') : '-';
                row.insertCell().textContent = _.sum(draw.numbers);
                const oddCount = draw.numbers.filter(n => n % 2 !== 0).length;
                const evenCount = draw.numbers.length - oddCount;
                row.insertCell().textContent = `${oddCount}/${evenCount}`;
            });
            document.getElementById('paginationInfo').textContent = `Showing ${currentPageData.length} of ${appState.historicalData.length}`;
            // Pagination buttons would be enabled/disabled based on current page and total data
            document.getElementById('prevPage').disabled = true; // For now
            document.getElementById('nextPage').disabled = true; // For now

            updateHistoricalDataSummary();
        }

        function updateHistoricalDataSummary() {
            const historicalData = appState.historicalData;
            const params = getGameParams(document.getElementById('historicalGame').value);
            const { mainPool } = params;

            if (historicalData.length === 0) {
                document.getElementById('dataSummary').innerHTML = `<p class="text-gray-500 dark:text-gray-400">Load historical data to see summary</p>`;
                document.getElementById('mostFrequent').innerHTML = '';
                document.getElementById('leastFrequent').innerHTML = '';
                document.getElementById('dueNumbers').innerHTML = '';
                document.getElementById('recentTrends').innerHTML = '';
                document.getElementById('patternFrequency').innerHTML = '';
                document.getElementById('sumStatistics').innerHTML = '';
                return;
            }

            const freqAnalysis = calculateFrequency(historicalData, mainPool);
            const gapAnalysis = calculateGapAnalysis(historicalData, mainPool);
            const sumStats = calculateSumStatistics(historicalData);

            document.getElementById('dataSummary').innerHTML = `
                <p>Total Draws: ${historicalData.length}</p>
                <p>From: ${historicalData[historicalData.length - 1].date} To: ${historicalData[0].date}</p>
            `;
            document.getElementById('mostFrequent').innerHTML = `<p>${freqAnalysis.mostFrequent.slice(0, 5).join(', ')}</p>`;
            document.getElementById('leastFrequent').innerHTML = `<p>${freqAnalysis.leastFrequent.slice(0, 5).join(', ')}</p>`;
            document.getElementById('dueNumbers').innerHTML = `<p>${gapAnalysis.due.slice(0, 5).join(', ')}</p>`;
            document.getElementById('recentTrends').innerHTML = `<p>Avg Sum (Last 10): ${sumStats.avgLast10.toFixed(2)}</p><p>Odd/Even Ratio (Last 10): ${sumStats.oddEvenRatioLast10.toFixed(2)}</p>`;
            document.getElementById('patternFrequency').innerHTML = `<p>Avg Consecutive Pairs: ${sumStats.avgConsecutive.toFixed(2)}</p>`;
            document.getElementById('sumStatistics').innerHTML = `<p>Min Sum: ${sumStats.minSum}</p><p>Max Sum: ${sumStats.maxSum}</p><p>Avg Sum: ${sumStats.avgSum.toFixed(2)}</p>`;
        }

        function calculateFrequency(historicalData, maxNumber) {
            const frequencies = {};
            const lastDrawn = {};
            for (let i = 1; i <= maxNumber; i++) {
                frequencies[i] = 0;
                lastDrawn[i] = -1; // -1 means never drawn
            }

            historicalData.forEach((draw, index) => {
                [...draw.numbers, ...(draw.bonus || [])].forEach(n => {
                    if (n <= maxNumber) {
                        frequencies[n]++;
                        lastDrawn[n] = index; // Store the index of the last draw
                    }
                });
            });

            const sortedByFreq = Object.entries(frequencies).sort(([, a], [, b]) => b - a);
            const mostFrequent = sortedByFreq.slice(0, 5).map(([num]) => parseInt(num));
            const leastFrequent = sortedByFreq.slice(-5).map(([num]) => parseInt(num));
            
            const hot = sortedByFreq.filter(([, freq]) => freq > (historicalData.length / 10)).map(([num]) => parseInt(num)); // Arbitrary threshold
            const cold = sortedByFreq.filter(([, freq]) => freq < (historicalData.length / 50)).map(([num]) => parseInt(num)); // Arbitrary threshold

            return { overall: frequencies, mostFrequent, leastFrequent, hot, cold, lastDrawn };
        }

        function calculateGapAnalysis(historicalData, maxNumber) {
            const freqAnalysis = calculateFrequency(historicalData, maxNumber);
            const lastDrawn = freqAnalysis.lastDrawn;
            const currentDrawIndex = historicalData.length; // Next theoretical draw

            const gaps = {};
            for (let i = 1; i <= maxNumber; i++) {
                gaps[i] = lastDrawn[i] === -1 ? currentDrawIndex : currentDrawIndex - lastDrawn[i];
            }

            const sortedByGap = Object.entries(gaps).sort(([, a], [, b]) => b - a);
            const dueNumbers = sortedByGap.slice(0, 5).map(([num]) => parseInt(num)); // Top 5 with largest gaps

            return { gaps, due: dueNumbers };
        }

        function calculateSumStatistics(historicalData) {
            const sums = historicalData.map(draw => _.sum(draw.numbers));
            const minSum = _.min(sums);
            const maxSum = _.max(sums);
            const avgSum = _.mean(sums);

            const last10Draws = historicalData.slice(0, 10);
            const avgLast10 = _.mean(last10Draws.map(draw => _.sum(draw.numbers)));

            let totalOddEvenRatio = 0;
            let totalConsecutive = 0;
            last10Draws.forEach(draw => {
                const oddCount = draw.numbers.filter(n => n % 2 !== 0).length;
                const evenCount = draw.numbers.length - oddCount;
                totalOddEvenRatio += oddCount / (oddCount + evenCount);

                let consecutivePairs = 0;
                for (let i = 0; i < draw.numbers.length - 1; i++) {
                    if (draw.numbers[i + 1] === draw.numbers[i] + 1) {
                        consecutivePairs++;
                    }
                }
                totalConsecutive += consecutivePairs;
            });

            return {
                minSum,
                maxSum,
                avgSum,
                avgLast10,
                oddEvenRatioLast10: totalOddEvenRatio / last10Draws.length,
                avgConsecutive: totalConsecutive / last10Draws.length
            };
        }
        
        // --- Charting Functions (using Chart.js) ---
        let dashboardHeatmapChart, dashboardPatternsChart;
        let freqDistributionChart, lastDigitDistributionChart, sumDistributionChart, oddEvenDistributionChart;
        let freqHeatmapChart, freqOverTimeChart, gapAnalysisChart;
        let predictionCertaintyChart;

        function updateDashboardCharts() {
            const historicalData = appState.historicalData;
            if (historicalData.length === 0) {
                if (dashboardHeatmapChart) dashboardHeatmapChart.destroy();
                if (dashboardPatternsChart) dashboardPatternsChart.destroy();
                return;
            }

            const gameType = document.getElementById('lotteryGame').value;
            const params = getGameParams(gameType);
            const { mainPool } = params;
            const freqAnalysis = calculateFrequency(historicalData, mainPool);
            const frequencies = freqAnalysis.overall;

            // Dashboard Heatmap
            const heatmapLabels = Array.from({ length: mainPool }, (_, i) => i + 1);
            const heatmapData = heatmapLabels.map(n => frequencies[n] || 0);

            if (dashboardHeatmapChart) dashboardHeatmapChart.destroy();
            dashboardHeatmapChart = new Chart(document.getElementById('dashboardHeatmap').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: heatmapLabels,
                    datasets: [{
                        label: 'Number Frequency',
                        data: heatmapData,
                        backgroundColor: heatmapData.map(val => val > (historicalData.length / 20) ? '#EF4444' : val < (historicalData.length / 50) ? '#3B82F6' : '#8B5CF6'),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Dashboard Patterns (conceptual, needs more complex pattern detection)
            if (dashboardPatternsChart) dashboardPatternsChart.destroy();
            dashboardPatternsChart = new Chart(document.getElementById('dashboardPatterns').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Draw 1', 'Draw 2', 'Draw 3', 'Draw 4', 'Draw 5'], // Placeholder
                    datasets: [{
                        label: 'Average Sum Trend',
                        data: historicalData.slice(0,5).map(d => _.sum(d.numbers)), // Last 5 sums
                        borderColor: '#10B981',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: true } }
                }
            });
        }

        function updateAnalysisCharts(numbers, bonus, mainPool, bonusPool) {
            const allNums = [...numbers, ...bonus];
            if (allNums.length === 0) {
                if (freqDistributionChart) freqDistributionChart.destroy();
                if (lastDigitDistributionChart) lastDigitDistributionChart.destroy();
                if (sumDistributionChart) sumDistributionChart.destroy();
                if (oddEvenDistributionChart) oddEvenDistributionChart.destroy();
                return;
            }

            // Frequency Distribution Chart (for analyzed numbers)
            const analysisFreq = {};
            for (let i = 1; i <= mainPool; i++) analysisFreq[i] = 0;
            allNums.forEach(n => { if (n <= mainPool) analysisFreq[n]++; });
            
            const analysisLabels = Object.keys(analysisFreq).map(Number);
            const analysisData = Object.values(analysisFreq);

            if (freqDistributionChart) freqDistributionChart.destroy();
            freqDistributionChart = new Chart(document.getElementById('freqDistributionChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: analysisLabels,
                    datasets: [{
                        label: 'Number Frequency in Current Set',
                        data: analysisData,
                        backgroundColor: '#3B82F6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Last Digit Distribution
            const lastDigitCounts = {};
            for (let i = 0; i <= 9; i++) lastDigitCounts[i] = 0;
            allNums.forEach(n => lastDigitCounts[n % 10]++);

            if (lastDigitDistributionChart) lastDigitDistributionChart.destroy();
            lastDigitDistributionChart = new Chart(document.getElementById('lastDigitDistributionChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(lastDigitCounts),
                    datasets: [{
                        label: 'Last Digit Distribution',
                        data: Object.values(lastDigitCounts),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#E7E9ED', '#8B5CF6', '#10B981', '#3B82F6'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Number Sum Distribution (of current set)
            const currentSum = _.sum(numbers);
            if (sumDistributionChart) sumDistributionChart.destroy();
            sumDistributionChart = new Chart(document.getElementById('sumDistributionChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Current Sum', 'Remaining Potential Sum'],
                    datasets: [{
                        data: [currentSum, mainPool * pickCount / 2 - currentSum], // Very rough estimation for potential
                        backgroundColor: ['#EF4444', '#E7E9ED'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });

            // Odd/Even Distribution
            const oddCount = numbers.filter(n => n % 2 !== 0).length;
            const evenCount = numbers.length - oddCount;
            if (oddEvenDistributionChart) oddEvenDistributionChart.destroy();
            oddEvenDistributionChart = new Chart(document.getElementById('oddEvenDistributionChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Odd', 'Even'],
                    datasets: [{
                        data: [oddCount, evenCount],
                        backgroundColor: ['#8B5CF6', '#3B82F6'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }
        
        function updateHistoricalDataCharts(gameType) {
            const historicalData = appState.historicalData;
            if (historicalData.length === 0) {
                if (freqHeatmapChart) freqHeatmapChart.destroy();
                if (freqOverTimeChart) freqOverTimeChart.destroy();
                if (gapAnalysisChart) gapAnalysisChart.destroy();
                return;
            }

            const params = getGameParams(gameType);
            const { mainPool } = params;
            const freqAnalysis = calculateFrequency(historicalData, mainPool);
            const gapAnalysis = calculateGapAnalysis(historicalData, mainPool);

            // Frequency Heatmap (same as dashboard, but specific to historical section)
            const heatmapLabels = Array.from({ length: mainPool }, (_, i) => i + 1);
            const heatmapData = heatmapLabels.map(n => freqAnalysis.overall[n] || 0);

            if (freqHeatmapChart) freqHeatmapChart.destroy();
            freqHeatmapChart = new Chart(document.getElementById('freqHeatmapChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: heatmapLabels,
                    datasets: [{
                        label: 'Overall Number Frequency',
                        data: heatmapData,
                        backgroundColor: heatmapData.map(val => val > (historicalData.length / 10) ? '#EF4444' : val < (historicalData.length / 50) ? '#3B82F6' : '#8B5CF6'),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Frequency Over Time Chart (Top 5 numbers)
            const top5FreqNumbers = freqAnalysis.mostFrequent.slice(0, 5);
            const dates = historicalData.map(d => d.date).reverse(); // Oldest to newest
            const freqOverTimeDatasets = top5FreqNumbers.map(num => {
                const data = historicalData.map(draw => draw.numbers.includes(num) || (draw.bonus && draw.bonus.includes(num)) ? 1 : 0).reverse();
                return {
                    label: `Number ${num}`,
                    data: data,
                    borderColor: `hsl(${Math.random() * 360}, 70%, 50%)`, // Random color for each line
                    tension: 0.3,
                    pointRadius: 0
                };
            });

            if (freqOverTimeChart) freqOverTimeChart.destroy();
            freqOverTimeChart = new Chart(document.getElementById('freqOverTimeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: freqOverTimeDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 1, title: { display: true, text: 'Drawn (1) / Not Drawn (0)' } } },
                    plugins: { legend: { display: true } }
                }
            });

            // Gap Analysis Chart (Top 10 due numbers)
            const dueNumbersChartData = gapAnalysis.due.slice(0, 10);
            const gapValues = dueNumbersChartData.map(num => gapAnalysis.gaps[num]);

            if (gapAnalysisChart) gapAnalysisChart.destroy();
            gapAnalysisChart = new Chart(document.getElementById('gapAnalysisChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: dueNumbersChartData.map(String),
                    datasets: [{
                        label: 'Draws Since Last Appearance',
                        data: gapValues,
                        backgroundColor: '#F59E0B',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function updateGeneratorCharts(generatedNumbers) {
            if (!generatedNumbers || generatedNumbers.length === 0) {
                if (numberFrequencyChart) numberFrequencyChart.destroy();
                if (sumAnalysisChart) sumAnalysisChart.destroy();
                if (patternAnalysisChart) patternAnalysisChart.destroy();
                return;
            }

            const gameType = document.getElementById('lotteryGame').value;
            const params = getGameParams(gameType);
            const { mainPool } = params;

            // Number Frequency Chart for Generated Tickets
            const freqGenerated = {};
            for (let i = 1; i <= mainPool; i++) freqGenerated[i] = 0;
            generatedNumbers.forEach(ticket => {
                ticket.numbers.forEach(num => {
                    if (num <= mainPool) freqGenerated[num]++;
                });
                ticket.bonusNumbers.forEach(num => {
                    if (num <= mainPool) freqGenerated[num]++; // Include bonus in overall frequency for this chart
                });
            });

            const labels = Object.keys(freqGenerated).map(Number);
            const data = Object.values(freqGenerated);

            if (numberFrequencyChart) numberFrequencyChart.destroy();
            numberFrequencyChart = new Chart(document.getElementById('numberFrequencyChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency in Generated Tickets',
                        data: data,
                        backgroundColor: '#3B82F6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Sum Analysis Chart
            const sums = generatedNumbers.map(ticket => _.sum(ticket.numbers));
            const sumBins = {}; // Group sums into bins
            sums.forEach(s => {
                const bin = Math.floor(s / 10) * 10; // Example: 10-19, 20-29
                sumBins[bin] = (sumBins[bin] || 0) + 1;
            });
            const sumLabels = Object.keys(sumBins).sort((a,b) => a-b).map(s => `${s}-${parseInt(s)+9}`);
            const sumData = Object.values(sumBins);

            if (sumAnalysisChart) sumAnalysisChart.destroy();
            sumAnalysisChart = new Chart(document.getElementById('sumAnalysisChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sumLabels,
                    datasets: [{
                        label: 'Sum Distribution',
                        data: sumData,
                        backgroundColor: '#8B5CF6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Pattern Analysis Chart (conceptual - e.g., consecutive pairs distribution)
            const consecutiveCounts = { '0': 0, '1': 0, '2': 0, '3+': 0 };
            generatedNumbers.forEach(ticket => {
                let pairs = 0;
                for (let i = 0; i < ticket.numbers.length - 1; i++) {
                    if (ticket.numbers[i + 1] === ticket.numbers[i] + 1) {
                        pairs++;
                    }
                }
                if (pairs >= 3) consecutiveCounts['3+']++;
                else consecutiveCounts[pairs]++;
            });

            if (patternAnalysisChart) patternAnalysisChart.destroy();
            patternAnalysisChart = new Chart(document.getElementById('patternAnalysisChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(consecutiveCounts),
                    datasets: [{
                        label: 'Consecutive Pairs Distribution',
                        data: Object.values(consecutiveCounts),
                        backgroundColor: ['#4BC0C0', '#FF9F40', '#FF6384', '#36A2EB'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }


        function updateDashboardStats() {
            const numbers = appState.currentDraws.length > 0 ? appState.currentDraws[0].numbers : [];
            if (numbers.length === 0) {
                document.getElementById('statsOverview').innerHTML = `<p>Generate numbers to see statistics</p>`;
                return;
            }
            const sum = _.sum(numbers);
            const avg = sum / numbers.length;
            const oddCount = numbers.filter(n => n % 2 === 1).length;
            const evenCount = numbers.length - oddCount;
            
            document.getElementById('statsOverview').innerHTML = `
                <p>Numbers Generated: ${appState.currentDraws.length}</p>
                <p>Average Number: ${avg.toFixed(1)}</p>
                <p>Odd/Even: ${oddCount}/${evenCount}</p>
            `;
        }

        function handleQuickAction(e) {
            const action = e.target.dataset.action;
            
            switch (action) {
                case 'quickPick':
                    document.getElementById('generationMethod').value = 'standard';
                    document.getElementById('numTickets').value = 1;
                    document.getElementById('generateSmart').click(); // Simulate click
                    break;
                case 'analyzeLast':
                    if (appState.historicalData.length > 0) {
                        const lastDraw = appState.historicalData[0]; // Most recent draw
                        document.getElementById('numbersToAnalyze').value = [...lastDraw.numbers, ...(lastDraw.bonus || [])].join(', ');
                        document.getElementById('analyzerGame').value = document.getElementById('historicalGame').value; // Sync game type
                        analyzeNumbers(document.getElementById('numbersToAnalyze').value, document.getElementById('analyzerGame').value);
                    } else {
                        showNotification('No historical data to analyze!', 'warning');
                    }
                    break;
                case 'checkOdds':
                    document.getElementById('probabilityGame').value = document.getElementById('lotteryGame').value; // Sync game type
                    document.getElementById('calculateProbability').click();
                    document.getElementById('probability').scrollIntoView({ behavior: 'smooth' });
                    break;
            }
        }
        
        // --- Event Listeners and Initialisation ---
        function initApp() {
            loadAppState();
            
            // Apply theme
            if (appState.settings.theme === 'dark') {
                document.body.classList.add('dark:bg-dark', 'dark:text-white');
                document.body.classList.remove('bg-gray-50', 'text-gray-900');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light Theme';
            } else {
                document.body.classList.remove('dark:bg-dark', 'dark:text-white');
                document.body.classList.add('bg-gray-50', 'text-gray-900');
                document.getElementById('themeToggle').textContent = 'üåô Dark Theme';
            }

            // Set default game in generator and analyzer
            document.getElementById('lotteryGame').value = appState.settings.defaultGame;
            document.getElementById('analyzerGame').value = appState.settings.defaultGame;
            document.getElementById('seedReverseGame').value = appState.settings.defaultGame;
            document.getElementById('historicalGame').value = appState.settings.defaultGame;
            document.getElementById('probabilityGame').value = appState.settings.defaultGame;
            document.getElementById('predictionGame').value = appState.settings.defaultGame;
            document.getElementById('defaultGameSetting').value = appState.settings.defaultGame;
            document.getElementById('enableNotifications').checked = appState.settings.notifications;

            updateGameConfig(); // Set initial custom game visibility
            loadHistoricalData(appState.settings.defaultGame, 50); // Load some initial data

            // General UI toggles
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('sidebar-hidden');
                document.querySelector('.main-content-area').classList.toggle('md:ml-64');
            });
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('notifications').addEventListener('click', () => showNotification('No new notifications.', 'info'));

            // Generator Section
            document.getElementById('lotteryGame').addEventListener('change', updateGameConfig);
            document.getElementById('randomSeedBtn').addEventListener('click', () => {
                document.getElementById('randomSeed').value = Math.random().toString(36).substring(2, 10).toUpperCase();
            });
            document.getElementById('generateSmart').addEventListener('click', () => {
                const gameType = document.getElementById('lotteryGame').value;
                const method = document.getElementById('generationMethod').value;
                const numTickets = parseInt(document.getElementById('numTickets').value);
                const useHistorical = document.getElementById('useHistorical').checked;
                const favorHot = document.getElementById('favorHot').checked;
                const includeDue = document.getElementById('includeDue').checked;
                const avoidRepeats = document.getElementById('avoidRepeats').checked;

                if (isNaN(numTickets) || numTickets < 1) {
                    showNotification('Please enter a valid number of tickets (1-100).', 'danger');
                    return;
                }

                showNotification('Generating numbers...', 'info');
                document.getElementById('generatedTickets').innerHTML = '<div class="loading-indicator"></div> Generating...';

                setTimeout(() => { // Simulate a small delay for "generation"
                    const generated = [];
                    for (let i = 0; i < numTickets; i++) {
                        generated.push(generateNumbers(gameType, method, { useHistorical, favorHot, includeDue, avoidRepeats }));
                    }
                    appState.currentDraws = generated; // Store generated tickets
                    saveAppState(); // Save state including generated tickets

                    const ticketsHtml = generated.map(ticket => {
                        const mainBalls = ticket.numbers.map(n => `<span class="number-ball">${n}</span>`).join('');
                        const bonusBalls = ticket.bonusNumbers.length > 0 ? ticket.bonusNumbers.map(n => `<span class="number-ball bonus-ball">${n}</span>`).join('') : '';
                        return `<div>${mainBalls} ${bonusBalls}</div>`;
                    }).join('<br>');
                    document.getElementById('generatedTickets').innerHTML = ticketsHtml || '<p class="text-gray-500 dark:text-gray-400">No numbers generated. Check settings.</p>';
                    showNotification(`Generated ${numTickets} tickets.`, 'success');
                    updateGeneratorCharts(generated); // Update charts in generator section
                    updateDashboardStats(); // Update dashboard with generated stats
                }, 100);
            });

            document.getElementById('quickPick').addEventListener('click', () => {
                document.getElementById('generationMethod').value = 'standard';
                document.getElementById('numTickets').value = 1;
                document.getElementById('generateSmart').click();
            });

            document.getElementById('clearGenerator').addEventListener('click', () => {
                document.getElementById('generatedTickets').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>';
                appState.currentDraws = [];
                saveAppState();
                if (numberFrequencyChart) numberFrequencyChart.destroy();
                if (sumAnalysisChart) sumAnalysisChart.destroy();
                if (patternAnalysisChart) patternAnalysisChart.destroy();
                updateDashboardStats(); // Clear dashboard stats
                showNotification('Generator cleared.');
            });

            // Analyzer Section
            document.getElementById('analyzeNumbers').addEventListener('click', () => {
                const numbersToAnalyze = document.getElementById('numbersToAnalyze').value;
                const analyzerGame = document.getElementById('analyzerGame').value;
                analyzeNumbers(numbersToAnalyze, analyzerGame);
                showNotification('Analysis complete.');
            });

            document.querySelectorAll('.sample-input').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.getElementById('numbersToAnalyze').value = e.target.dataset.sample;
                    // Auto-detect game type if possible, or prompt user
                    if (e.target.dataset.sample.split(/[, ]+/).length === 6 && e.target.dataset.sample.includes(',')) { // Simplistic check for Powerball/Mega Millions
                        document.getElementById('analyzerGame').value = 'powerball'; // Assume Powerball for this sample
                    }
                    showNotification('Sample numbers loaded.');
                });
            });

            document.getElementById('clearAnalyzer').addEventListener('click', () => {
                document.getElementById('numbersToAnalyze').value = '';
                document.getElementById('analysisResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>';
                document.getElementById('numberProps').innerHTML = '';
                document.getElementById('patternStats').innerHTML = '';
                document.getElementById('visualAnalysis').innerHTML = '';
                document.getElementById('basicStats').innerHTML = '';
                document.getElementById('advancedMetrics').innerHTML = '';
                document.getElementById('aiInsightsOutput').classList.add('hidden');
                document.getElementById('aiInsightsText').innerHTML = '';
                if (freqDistributionChart) freqDistributionChart.destroy();
                if (lastDigitDistributionChart) lastDigitDistributionChart.destroy();
                if (sumDistributionChart) sumDistributionChart.destroy();
                if (oddEvenDistributionChart) oddEvenDistributionChart.destroy();
                showNotification('Analyzer cleared.');
            });
            
            // AI Insights (Simulated)
            document.getElementById('getAIInsights').addEventListener('click', () => {
                const numbersToAnalyze = document.getElementById('numbersToAnalyze').value;
                if (!numbersToAnalyze) {
                    showNotification('Please enter numbers before requesting AI insights.', 'warning');
                    return;
                }
                const numbers = numbersToAnalyze.split(/[, ]+/).map(Number).filter(n => !isNaN(n));
                if (numbers.length === 0) {
                    showNotification('No valid numbers found for AI insights.', 'danger');
                    return;
                }

                const aiInsightsDiv = document.getElementById('aiInsightsOutput');
                const aiInsightsText = document.getElementById('aiInsightsText');
                const aiInsightsLoading = document.getElementById('aiInsightsLoading');

                aiInsightsDiv.classList.remove('hidden');
                aiInsightsText.innerHTML = '';
                aiInsightsLoading.classList.remove('hidden');
                showNotification('Generating AI insights...', 'info');

                setTimeout(() => {
                    const sum = _.sum(numbers);
                    const oddCount = numbers.filter(n => n % 2 !== 0).length;
                    const evenCount = numbers.length - oddCount;
                    const primeCount = numbers.filter(isPrime).length;

                    let insight = "Based on a simulated AI model: ";
                    if (oddCount > evenCount && oddCount / numbers.length > 0.6) {
                        insight += "This set has a higher than average number of odd digits, which can be less common in some historical draws. ";
                    } else if (evenCount > oddCount && evenCount / numbers.length > 0.6) {
                        insight += "This set has a higher than average number of even digits, which might make it stand out. ";
                    }
                    if (primeCount >= numbers.length / 2) {
                        insight += "A significant portion of these numbers are prime, a pattern sometimes observed. ";
                    }
                    if (sum < 50) { // Arbitrary low sum
                        insight += "The sum is relatively low, often seen in less frequent combinations. ";
                    } else if (sum > 200) { // Arbitrary high sum
                        insight += "The sum is on the higher side, which can occur less frequently. ";
                    }

                    if (appState.historicalData.length > 100) {
                        const freqAnalysis = calculateFrequency(appState.historicalData, getGameParams(document.getElementById('analyzerGame').value).mainPool);
                        const hotNumbersInSet = numbers.filter(n => freqAnalysis.hot.includes(n));
                        const coldNumbersInSet = numbers.filter(n => freqAnalysis.cold.includes(n));
                        if (hotNumbersInSet.length >= numbers.length / 2) {
                            insight += `Many numbers (${hotNumbersInSet.join(', ')}) are historically 'hot', increasing their statistical probability. `;
                        } else if (coldNumbersInSet.length >= numbers.length / 2) {
                            insight += `Several numbers (${coldNumbersInSet.join(', ')}) are historically 'cold', making them less likely based on past trends. `;
                        }
                    } else {
                        insight += "More historical data would allow for deeper AI-powered insights. ";
                    }

                    aiInsightsText.innerHTML = `<p>${insight}</p>`;
                    aiInsightsLoading.classList.add('hidden');
                    showNotification('AI insights ready!', 'success');
                }, 1500); // Simulate AI processing time
            });

            // Seed Reverser (Conceptual)
            document.getElementById('reverseSeedBtn').addEventListener('click', () => {
                const numbersToReverse = document.getElementById('numbersToReverse').value;
                if (!numbersToReverse) {
                    showNotification('Please enter numbers for Seed Reverser.', 'warning');
                    document.getElementById('seedProfileResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers and generate profile</p>';
                    document.getElementById('seedStats').innerHTML = '';
                    document.getElementById('seedPatterns').innerHTML = '';
                    document.getElementById('seedVisuals').innerHTML = '';
                    document.getElementById('seedInterpretationOutput').classList.add('hidden');
                    return;
                }
                const numbers = numbersToReverse.split(/[, ]+/).map(Number).filter(n => !isNaN(n));
                if (numbers.length === 0) {
                    showNotification('No valid numbers found for Seed Reverser.', 'danger');
                    document.getElementById('seedProfileResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers and generate profile</p>';
                    document.getElementById('seedStats').innerHTML = '';
                    document.getElementById('seedPatterns').innerHTML = '';
                    document.getElementById('seedVisuals').innerHTML = '';
                    document.getElementById('seedInterpretationOutput').classList.add('hidden');
                    return;
                }

                // Simulate seed reversal - this is highly complex and not truly possible client-side for secure PRNGs
                const pseudoSeed = _.sum(numbers) * numbers.length % 999999;
                const complexity = (numbers.length * _.sum(numbers.map(n => Math.log(n)))) % 100;

                document.getElementById('seedProfileResults').innerHTML = `<p><strong>Simulated Seed:</strong> ${pseudoSeed}</p><p><strong>Pattern Complexity Score:</strong> ${complexity.toFixed(2)}%</p>`;
                document.getElementById('seedStats').innerHTML = `<p>Avg: ${(_.mean(numbers)).toFixed(2)}</p><p>Range: ${(_.max(numbers) - _.min(numbers))}</p>`;
                document.getElementById('seedPatterns').innerHTML = `<p>Odd/Even Ratio: ${(numbers.filter(n => n % 2 !== 0).length / numbers.length).toFixed(2)}</p>`;
                
                const visualSeedDiv = document.getElementById('seedVisuals');
                visualSeedDiv.innerHTML = '';
                numbers.forEach(num => {
                    const span = document.createElement('span');
                    span.classList.add('number-ball');
                    span.textContent = num;
                    visualSeedDiv.appendChild(span);
                });
                showNotification('Seed Profile Generated (Simulated).', 'success');
            });

            document.getElementById('interpretSeedProfile').addEventListener('click', () => {
                const seedText = document.getElementById('seedProfileResults').textContent;
                if (seedText.includes('Enter numbers')) {
                    showNotification('Generate a seed profile first.', 'warning');
                    return;
                }
                const aiInterpretationOutput = document.getElementById('seedInterpretationOutput');
                const aiInterpretationText = document.getElementById('seedInterpretationText');
                const aiInterpretationLoading = document.getElementById('seedInterpretationLoading');

                aiInterpretationOutput.classList.remove('hidden');
                aiInterpretationText.innerHTML = '';
                aiInterpretationLoading.classList.remove('hidden');
                showNotification('Interpreting seed profile...', 'info');

                setTimeout(() => {
                    // This is a simulated interpretation
                    let interpretation = "Based on the generated seed profile (simulated): ";
                    if (seedText.includes("Complexity Score: 80")) { // Example high complexity
                        interpretation += "The pattern exhibits high complexity, suggesting a less predictable or more chaotic generation process. ";
                    } else {
                        interpretation += "The pattern shows moderate complexity, indicating some underlying structures or biases. ";
                    }
                    interpretation += "Further analysis with a dedicated Seed Reversal engine would be needed for true insights.";
                    aiInterpretationText.innerHTML = `<p>${interpretation}</p>`;
                    aiInterpretationLoading.classList.add('hidden');
                    showNotification('Seed interpretation complete!', 'success');
                }, 1500);
            });

            document.getElementById('clearSeedReverse').addEventListener('click', () => {
                document.getElementById('numbersToReverse').value = '';
                document.getElementById('seedProfileResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers and generate profile</p>';
                document.getElementById('seedStats').innerHTML = '';
                document.getElementById('seedPatterns').innerHTML = '';
                document.getElementById('seedVisuals').innerHTML = '';
                document.getElementById('seedInterpretationOutput').classList.add('hidden');
                showNotification('Seed Reverser cleared.');
            });

            // Historical Data Section
            document.getElementById('historicalGame').addEventListener('change', (e) => loadHistoricalData(e.target.value, document.getElementById('pastDraws').value));
            document.getElementById('dataSource').addEventListener('change', (e) => {
                if (e.target.value === 'csv') {
                    document.getElementById('csvUploadContainer').classList.remove('hidden');
                } else {
                    document.getElementById('csvUploadContainer').classList.add('hidden');
                }
            });
            document.getElementById('loadData').addEventListener('click', () => {
                const gameType = document.getElementById('historicalGame').value;
                const dataSource = document.getElementById('dataSource').value;
                const pastDraws = document.getElementById('pastDraws').value;

                if (dataSource === 'csv') {
                    const csvFile = document.getElementById('csvUpload').files[0];
                    if (csvFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const text = e.target.result;
                            // Basic CSV parsing: Date,N1,N2,...,Bn1
                            const lines = text.split('\n').filter(line => line.trim() !== '');
                            const parsedData = lines.map(line => {
                                const parts = line.split(',');
                                const date = parts[0];
                                const numbersAndBonus = parts.slice(1).map(Number).filter(n => !isNaN(n));
                                const params = getGameParams(gameType);
                                const numbers = numbersAndBonus.slice(0, params.pickCount);
                                const bonus = numbersAndBonus.slice(params.pickCount, params.pickCount + params.bonusCount);
                                return { date, numbers, bonus };
                            });
                            appState.historicalData = parsedData.reverse(); // Newest first
                            saveAppState();
                            displayHistoricalData();
                            updateHistoricalDataCharts(gameType);
                            updateDashboardStats();
                            showNotification(`Loaded ${parsedData.length} draws from CSV.`);
                        };
                        reader.readAsText(csvFile);
                    } else {
                        showNotification('Please select a CSV file to upload.', 'danger');
                    }
                } else {
                    loadHistoricalData(gameType, pastDraws);
                }
            });

            document.getElementById('clearHistorical').addEventListener('click', () => {
                appState.historicalData = [];
                saveAppState();
                displayHistoricalData(); // Clear table
                updateHistoricalDataSummary(); // Clear summary
                if (freqHeatmapChart) freqHeatmapChart.destroy();
                if (freqOverTimeChart) freqOverTimeChart.destroy();
                if (gapAnalysisChart) gapAnalysisChart.destroy();
                updateDashboardStats(); // Clear dashboard stats
                showNotification('Historical data cleared.');
            });

            // AI Strategies (Apply Strategy buttons)
            document.querySelectorAll('.applyStrategy').forEach(button => {
                button.addEventListener('click', (e) => {
                    const strategy = e.target.dataset.strategy;
                    if (appState.historicalData.length === 0) {
                        showNotification('Load historical data first to apply strategies.', 'warning');
                        return;
                    }
                    showNotification(`Applying ${strategy} strategy...`, 'info');
                    document.getElementById('strategyResults').innerHTML = '<div class="loading-indicator"></div> Analyzing...';
                    document.getElementById('recommendedNumbers').innerHTML = '';
                    document.getElementById('strategyAnalysis').innerHTML = '';

                    setTimeout(() => {
                        const gameType = document.getElementById('lotteryGame').value; // Use generator's game type
                        const params = getGameParams(gameType);
                        const { mainPool, pickCount, bonusPool, bonusCount } = params;
                        let recommendations = [];
                        let analysisText = `Strategy applied: ${strategy}. `;

                        if (strategy === 'frequency') {
                            const freqAnalysis = calculateFrequency(appState.historicalData, mainPool);
                            recommendations = freqAnalysis.hot.slice(0, pickCount);
                            analysisText += `Based on historical frequency, the hottest numbers are recommended.`;
                        } else if (strategy === 'gap') {
                            const gapAnalysis = calculateGapAnalysis(appState.historicalData, mainPool);
                            recommendations = gapAnalysis.due.slice(0, pickCount);
                            analysisText += `Numbers with the longest gaps since their last appearance are recommended.`;
                        } else if (strategy === 'pattern') {
                            // This is a complex pattern recognition placeholder
                            // For a real app, this would involve analyzing sequences, groups, etc.
                            // For now, it will combine hot and due numbers with a preference for certain sums/odd-even mixes.
                            const freqAnalysis = calculateFrequency(appState.historicalData, mainPool);
                            const gapAnalysis = calculateGapAnalysis(appState.historicalData, mainPool);
                            
                            const strongCandidates = _.uniq([...freqAnalysis.hot, ...gapAnalysis.due]);
                            recommendations = _.sampleSize(strongCandidates, pickCount);
                            if (recommendations.length < pickCount) {
                                recommendations = [...recommendations, ..._.sampleSize(Array.from({ length: mainPool }, (_, i) => i + 1).filter(n => !recommendations.includes(n)), pickCount - recommendations.length)];
                            }
                            analysisText += `A mix of hot and due numbers, with an attempt to find common sum ranges.`;
                        }
                        recommendations.sort((a,b) => a-b);

                        document.getElementById('strategyResults').innerHTML = '<p>Strategy analysis complete.</p>';
                        document.getElementById('recommendedNumbers').innerHTML = recommendations.map(n => `<span class="number-ball">${n}</span>`).join('');
                        document.getElementById('strategyAnalysis').innerHTML = `<p>${analysisText}</p>`;
                        showNotification(`Strategy ${strategy} applied!`, 'success');
                    }, 1000); // Simulate processing
                });
            });

            // Custom Strategy Builder (conceptual logic for now)
            document.getElementById('buildStrategy').addEventListener('click', () => {
                showNotification('Building custom strategy (simulated)...', 'info');
                // In a real scenario, weights and selected components would drive a more complex generation algorithm.
                // For this example, we'll just acknowledge the build.
                document.getElementById('strategyResults').innerHTML = '<p>Custom strategy built and applied (conceptual). Recommendations will be based on weighted choices.</p>';
                document.getElementById('recommendedNumbers').innerHTML = '';
                document.getElementById('strategyAnalysis').innerHTML = '';
                showNotification('Custom strategy applied (simulated).', 'success');
            });

            // Range slider value updates
            document.getElementById('freqWeight').addEventListener('input', (e) => document.getElementById('freqWeightValue').textContent = `${e.target.value}%`);
            document.getElementById('gapWeight').addEventListener('input', (e) => document.getElementById('gapWeightValue').textContent = `${e.target.value}%`);
            document.getElementById('patternWeight').addEventListener('input', (e) => document.getElementById('patternWeightValue').textContent = `${e.target.value}%`);
            document.getElementById('otherWeight').addEventListener('input', (e) => document.getElementById('otherWeightValue').textContent = `${e.target.value}%`);

            // Probability Lab
            document.getElementById('calculateProbability').addEventListener('click', () => {
                const gameType = document.getElementById('probabilityGame').value;
                const matchMain = parseInt(document.getElementById('matchMain').value);
                const matchBonus = parseInt(document.getElementById('matchBonus').value);
                const params = getGameParams(gameType);
                const { mainPool, pickCount, bonusPool, bonusCount } = params;

                if (isNaN(matchMain) || isNaN(matchBonus) || matchMain < 0 || matchBonus < 0) {
                    showNotification('Please enter valid numbers to match.', 'danger');
                    return;
                }
                if (matchMain > pickCount || matchBonus > bonusCount) {
                    showNotification('Matches cannot exceed game pick counts.', 'danger');
                    return;
                }

                // Combination function C(n, k) = n! / (k! * (n-k)!)
                const factorial = (n) => {
                    if (n === 0 || n === 1) return 1;
                    let res = 1;
                    for (let i = 2; i <= n; i++) res *= i;
                    return res;
                };
                const combinations = (n, k) => {
                    if (k < 0 || k > n) return 0;
                    if (k === 0 || k === n) return 1;
                    if (k > n / 2) k = n - k; // Optimization
                    return factorial(n) / (factorial(k) * factorial(n - k));
                };

                // Calculate probability
                let probMain = 0;
                if (pickCount >= matchMain) {
                    probMain = combinations(pickCount, matchMain) * combinations(mainPool - pickCount, pickCount - matchMain);
                }
                
                let totalCombinationsMain = combinations(mainPool, pickCount);
                
                let probBonus = 1; // Default to 1 if no bonus or no bonus match needed
                let totalCombinationsBonus = 1;
                if (bonusCount > 0) {
                    if (bonusCount >= matchBonus) {
                        probBonus = combinations(bonusCount, matchBonus) * combinations(bonusPool - bonusCount, bonusCount - matchBonus);
                    }
                    totalCombinationsBonus = combinations(bonusPool, bonusCount);
                }
                
                // Winning combinations for exact match
                const winningCombinations = combinations(pickCount, matchMain) * combinations(mainPool - pickCount, pickCount - matchMain) * combinations(bonusCount, matchBonus) * combinations(bonusPool - bonusCount, bonusCount - matchBonus)
                
                const totalPossibleCombinations = totalCombinationsMain * totalCombinationsBonus;
                const probability = winningCombinations / totalPossibleCombinations;

                document.getElementById('probabilityResults').innerHTML = `
                    <p><strong>Total Combinations:</strong> ${totalPossibleCombinations.toLocaleString()}</p>
                    <p><strong>Winning Combinations (Exact Match):</strong> ${winningCombinations.toLocaleString()}</p>
                    <p><strong>Probability:</strong> ${probability.toExponential(4)}</p>
                `;
                document.getElementById('oddsInverse').innerHTML = `
                    <p><strong>Odds in 1 to:</strong> ${ (1 / probability).toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>
                `;
                showNotification('Probability calculated.', 'success');
            });

            // Prediction Engine (Simulated)
            document.getElementById('generatePrediction').addEventListener('click', () => {
                const predictionGame = document.getElementById('predictionGame').value;
                const predictionModel = document.getElementById('predictionModel').value;
                const confidenceLevel = parseInt(document.getElementById('confidenceLevel').value);
                const params = getGameParams(predictionGame);
                const { mainPool, pickCount, bonusPool, bonusCount } = params;

                if (appState.historicalData.length < 50) {
                    showNotification('Need more historical data for meaningful predictions (at least 50 draws).', 'warning');
                    document.getElementById('predictionResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Not enough data for prediction.</p>';
                    document.getElementById('predictionInsights').innerHTML = '';
                    if (predictionCertaintyChart) predictionCertaintyChart.destroy();
                    return;
                }

                showNotification(`Generating prediction with ${predictionModel} model...`, 'info');
                document.getElementById('predictionResults').innerHTML = '<div class="loading-indicator"></div> Predicting...';
                document.getElementById('predictionInsights').innerHTML = '';
                document.getElementById('predictionLoading').classList.remove('hidden');

                setTimeout(() => {
                    let predictedNumbers = [];
                    let predictedBonus = [];
                    let certaintyScore = Math.random() * (90 - 50) + 50; // Simulate 50-90% certainty

                    // Simplified prediction logic:
                    // For "AI" models, strongly favor hot numbers and due numbers.
                    // For "Markov/Regression", try to find numbers that frequently follow others or show linear trends.
                    if (predictionModel === 'rnn' || predictionModel === 'lstm' || predictionModel === 'markov' || predictionModel === 'regression') {
                        const freqAnalysis = calculateFrequency(appState.historicalData, mainPool);
                        const gapAnalysis = calculateGapAnalysis(appState.historicalData, mainPool);
                        
                        let candidates = _.uniq([...freqAnalysis.hot, ...gapAnalysis.due]);
                        // Add some random numbers to fill if needed
                        if (candidates.length < pickCount) {
                            candidates = [...candidates, ..._.sampleSize(Array.from({ length: mainPool }, (_, i) => i + 1).filter(n => !candidates.includes(n)), pickCount - candidates.length)];
                        }
                        predictedNumbers = _.take(candidates.sort((a,b) => a-b), pickCount);

                        if (bonusCount > 0) {
                             predictedBonus = _.sampleSize(Array.from({ length: bonusPool }, (_, i) => i + 1), bonusCount);
                        }
                        certaintyScore = (certaintyScore * (confidenceLevel / 100)).toFixed(2); // Adjust certainty by confidence input
                    } else {
                        // Fallback to statistical if model is unknown
                        const { numbers, bonusNumbers } = generateNumbers(predictionGame, 'statistical', { useHistorical: true, favorHot: true, includeDue: true });
                        predictedNumbers = numbers;
                        predictedBonus = bonusNumbers;
                    }

                    document.getElementById('predictionResults').innerHTML = `
                        <p><strong>Predicted Main Numbers:</strong> ${predictedNumbers.join(', ')}</p>
                        ${predictedBonus.length > 0 ? `<p><strong>Predicted Bonus Numbers:</strong> ${predictedBonus.join(', ')}</p>` : ''}
                    `;
                    document.getElementById('predictionInsights').innerHTML = `<p>This prediction is generated based on historical trends and patterns using the selected model. Certainty: ${certaintyScore}%.</p>`;
                    document.getElementById('predictionLoading').classList.add('hidden');
                    showNotification('Prediction generated!', 'success');

                    // Update Prediction Certainty Chart
                    if (predictionCertaintyChart) predictionCertaintyChart.destroy();
                    predictionCertaintyChart = new Chart(document.getElementById('predictionCertaintyChart').getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Certainty', 'Uncertainty'],
                            datasets: [{
                                data: [parseFloat(certaintyScore), 100 - parseFloat(certaintyScore)],
                                backgroundColor: ['#10B981', '#E7E9ED'],
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            return `${label}: ${value}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }, 2000); // Simulate longer prediction time
            });

            // Settings
            document.getElementById('saveSettings').addEventListener('click', () => {
                appState.settings.defaultGame = document.getElementById('defaultGameSetting').value;
                appState.settings.notifications = document.getElementById('enableNotifications').checked;
                saveAppState();
                showNotification('Settings saved successfully!', 'success');
                // Re-apply settings that affect UI immediately
                document.getElementById('lotteryGame').value = appState.settings.defaultGame;
                document.getElementById('analyzerGame').value = appState.settings.defaultGame;
                document.getElementById('seedReverseGame').value = appState.settings.defaultGame;
                document.getElementById('historicalGame').value = appState.settings.defaultGame;
                document.getElementById('probabilityGame').value = appState.settings.defaultGame;
                document.getElementById('predictionGame').value = appState.settings.defaultGame;
                document.getElementById('themeToggle').textContent = appState.settings.theme === 'dark' ? '‚òÄÔ∏è Light Theme' : 'üåô Dark Theme';
            });

            document.getElementById('clearAllData').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all local data? This action cannot be undone.')) {
                    localStorage.removeItem('lottoGeniusProState');
                    appState.historicalData = [];
                    appState.currentDraws = [];
                    // Reset settings to default or reload app to default state
                    appState.settings = { theme: 'dark', notifications: true, defaultGame: 'powerball' };
                    saveAppState();
                    location.reload(); // Reload the page to reset everything
                    showNotification('All local data cleared.', 'success');
                }
            });

            document.getElementById('exportAllData').addEventListener('click', () => {
                const dataStr = JSON.stringify(appState, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lotto_genius_pro_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('All data exported to JSON.', 'success');
            });

            document.getElementById('importData').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });

            document.getElementById('importFileInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedState = JSON.parse(e.target.result);
                            // Merge or overwrite, depending on desired behavior. Overwriting here for simplicity.
                            Object.assign(appState, importedState);
                            saveAppState();
                            showNotification('Data imported successfully! Reloading application...', 'success');
                            location.reload(); // Reload to apply imported state
                        } catch (error) {
                            showNotification('Failed to import data: Invalid JSON file.', 'danger');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // Update charts and dashboard on initial load
            updateDashboardCharts();
            updateGeneratorCharts(appState.currentDraws);
            updateHistoricalDataCharts(appState.settings.defaultGame);
            updateDashboardStats(); // Initial stats based on loaded data

            // Quick action buttons in dashboard
            document.querySelectorAll('.quick-action').forEach(button => {
                button.addEventListener('click', handleQuickAction);
            });
        }

        // Custom Game Configuration visibility
        function updateGameConfig() {
            const gameType = document.getElementById('lotteryGame').value;
            const customConfigDiv = document.getElementById('customGameConfig');
            if (gameType === 'custom') {
                customConfigDiv.classList.remove('hidden');
            } else {
                customConfigDiv.classList.add('hidden');
            }
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
