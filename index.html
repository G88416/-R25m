<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto Genius Pro - Enhanced</title>
    <!-- Preload critical CSS/JS for faster initial load -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" as="script" crossorigin="anonymous">

    <!-- Tailwind CSS CDN (consider self-hosting for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS Configuration - Moved outside global scope if possible for better encapsulation
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                        accent: '#10B981',
                        dark: '#1F2937',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Sidebar transitions and responsiveness */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            /* Ensures sidebar is always on top */
            z-index: 50;
        }
        /* On small screens, hide by default unless toggled */
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* On medium screens and up, sidebar is always visible */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0%) !important; /* Override hidden state on desktop */
            }
        }

        /* Main content area responsiveness */
        .main-content-area {
            margin-left: 0; /* Default for mobile */
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .main-content-area {
                margin-left: 16rem; /* md:ml-64 */
            }
        }

        /* Chart container styling */
        .chart-container {
            max-height: 200px;
            width: 100%;
            position: relative; /* For Chart.js responsiveness */
        }

        /* Number ball styling */
        .number-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Slightly larger for better UX */
            height: 40px;
            border-radius: 50%;
            background-color: #3B82F6;
            color: white;
            font-weight: bold;
            margin: 5px; /* Increased margin */
            flex-shrink: 0;
            font-size: 1.1rem; /* Larger font size */
        }
        .bonus-ball { background-color: #8B5CF6; }
        .hot-number { background-color: #EF4444; } /* Red for hot */
        .cold-number { background-color: #3B82F6; } /* Blue for cold (default) */
        .due-number { background-color: #F59E0B; } /* Orange for due */

        /* General button styling */
        button {
            padding: 0.75rem 1.25rem; /* Enhanced padding */
            border-radius: 0.5rem;
            font-weight: 600; /* Bolder font */
            transition: all 0.2s ease-in-out; /* Smooth transitions for all properties */
            cursor: pointer;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px); /* Slight lift on hover */
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Input and textarea styling */
        textarea, input[type="text"], input[type="number"], select {
            padding: 0.75rem; /* Increased padding */
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB; /* Light background for inputs */
            color: #1F2937; /* Dark text for inputs */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3B82F6; /* Primary color border on focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); /* Subtle focus ring */
        }
        .dark textarea, .dark input[type="text"], .dark input[type="number"], .dark select {
            border-color: #4B5563;
            background-color: #374151; /* Darker background in dark mode */
            color: #F9FAFB; /* Light text in dark mode */
        }

        /* Loading indicator */
        .loading-indicator {
            display: inline-block;
            width: 20px; /* Slightly larger */
            height: 20px;
            border: 3px solid rgba(255,255,255,.3); /* Thicker border */
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-xl p-6 sidebar z-40 sidebar-hidden" aria-label="Main Navigation">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-extrabold text-primary flex items-center">
                Lotto Genius <span class="ml-2 px-3 py-1 text-xs bg-accent text-white rounded-full font-bold uppercase tracking-wider">PRO</span>
            </h1>
            <button id="closeSidebar" class="md:hidden text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary rounded-md" aria-label="Close sidebar">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav>
            <ul class="space-y-3">
                <li><a href="#dashboard" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200" aria-current="page">üìä Dashboard</a></li>
                <li><a href="#generator" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üé∞ Smart Generator</a></li>
                <li><a href="#analyzer" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üîç Advanced Analyzer</a></li>
                <li><a href="#seed-reverser" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üîÑ Seed Reverser</a></li>
                <li><a href="#historical" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üìà Historical Data</a></li>
                <li><a href="#strategies" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üß† AI Strategies</a></li>
                <li><a href="#probability" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üìâ Probability Lab</a></li>
                <li><a href="#prediction" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">üîÆ Prediction Engine</a></li>
                <li><a href="#settings" class="nav-link flex items-center p-3 text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">‚öôÔ∏è Settings</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="ml-0 p-6 md:p-8 main-content-area">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
            <button id="toggleSidebar" class="md:hidden p-3 bg-primary text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Open sidebar">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <div class="flex items-center space-x-4">
                <button id="themeToggle" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Toggle dark mode">
                    üåô Toggle Theme
                </button>
                <button id="notificationsBtn" class="p-3 bg-secondary text-white rounded-lg relative hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-secondary" aria-label="View notifications">
                    üîî Notifications
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full h-6 w-6 flex items-center justify-center font-bold hidden" aria-live="polite" aria-atomic="true">0</span>
                </button>
            </div>
        </header>

        <main class="space-y-8">
            <!-- Dashboard Section -->
            <section id="dashboard" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="dashboard-title">
                <h2 id="dashboard-title" class="text-3xl font-bold mb-6 text-primary">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Recent Activity</h3>
                        <div id="recentActivity" class="text-base text-gray-700 dark:text-gray-300">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Quick Actions</h3>
                        <div class="flex flex-wrap gap-3">
                            <button class="quick-action p-3 bg-primary text-white rounded-lg text-base hover:bg-blue-700" data-action="quickPick">Quick Pick</button>
                            <button class="quick-action p-3 bg-secondary text-white rounded-lg text-base hover:bg-purple-700" data-action="analyzeLast">Analyze Last</button>
                            <button class="quick-action p-3 bg-accent text-white rounded-lg text-base hover:bg-green-700" data-action="checkOdds">Check Odds</button>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Statistics</h3>
                        <div id="statsOverview" class="text-base text-gray-700 dark:text-gray-300">
                            <p>Generate numbers to see statistics</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Number Frequency Heatmap</h3>
                        <canvas id="dashboardHeatmap" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Recent Patterns</h3>
                        <canvas id="dashboardPatterns" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- Smart Generator Section -->
            <section id="generator" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="generator-title">
                <h2 id="generator-title" class="text-3xl font-bold mb-6 text-primary">Smart Number Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Game Configuration -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Game Setup</h3>
                        <div class="space-y-3">
                            <label for="lotteryGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Lottery Game</label>
                            <select id="lotteryGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customGameConfig" class="grid grid-cols-2 gap-4 hidden">
                            <div>
                                <label for="mainPool" class="block text-base font-medium text-gray-700 dark:text-gray-300">Main Pool Max</label>
                                <input id="mainPool" type="number" min="1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label for="pickCount" class="block text-base font-medium text-gray-700 dark:text-gray-300">Main Pick Count</label>
                                <input id="pickCount" type="number" min="1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label for="bonusPool" class="block text-base font-medium text-gray-700 dark:text-gray-300">Bonus Pool Max</label>
                                <input id="bonusPool" type="number" min="0" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label for="bonusCount" class="block text-base font-medium text-gray-700 dark:text-gray-300">Bonus Pick Count</label>
                                <input id="bonusCount" type="number" min="0" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label for="randomSeed" class="block text-base font-medium text-gray-700 dark:text-gray-300">Random Seed</label>
                            <div class="flex gap-2">
                                <input id="randomSeed" type="text" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="Enter seed for reproducible results">
                                <button id="randomSeedBtn" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700" aria-label="Generate random seed">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Options -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Generation Method</h3>
                        <div class="space-y-3">
                            <label for="generationMethod" class="block text-base font-medium text-gray-700 dark:text-gray-300">Algorithm</label>
                            <select id="generationMethod" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="standard">Standard Random</option>
                                <option value="fisherYates">Fisher-Yates Shuffle</option>
                                <option value="crypto">Cryptographically Secure</option>
                                <option value="lowHigh">Low-High Balance</option>
                                <option value="oddEven">Odd-Even Balance</option>
                                <option value="prime">Prime Number Filter</option>
                                <option value="fibonacci">Fibonacci Filter</option>
                                <option value="statistical">Statistical Weighted</option>
                                <option value="ai">AI-Powered ‚ú®</option>
                            </select>
                        </div>
                        
                        <div>
                            <p class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2">Historical Filters</p>
                            <div class="space-y-2">
                                <label class="flex items-center text-base">
                                    <input id="useHistorical" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary"> Use Historical Data
                                </label>
                                <label class="flex items-center text-base">
                                    <input id="favorHot" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary"> Favor Hot Numbers
                                </label>
                                <label class="flex items-center text-base">
                                    <input id="includeDue" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary"> Include Due Numbers
                                </label>
                                <label class="flex items-center text-base">
                                    <input id="avoidRepeats" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary"> Avoid Recent Repeats
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Advanced Options</h3>
                        <div>
                            <label for="numTickets" class="block text-base font-medium text-gray-700 dark:text-gray-300">Number of Tickets</label>
                            <input id="numTickets" type="number" min="1" max="100" value="1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        
                        <div>
                            <label for="sumFilter" class="block text-base font-medium text-gray-700 dark:text-gray-300">Sum Filter</label>
                            <select id="sumFilter" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="any">Any Sum</option>
                                <option value="low">Low Sum</option>
                                <option value="medium">Medium Sum</option>
                                <option value="high">High Sum</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="consecutiveFilter" class="block text-base font-medium text-gray-700 dark:text-gray-300">Consecutive Numbers</label>
                            <select id="consecutiveFilter" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="any">Any Consecutives</option>
                                <option value="none">No Consecutives</option>
                                <option value="max1">Max 1 Pair</option>
                                <option value="max2">Max 2 Pairs</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button id="generateSmart" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700">Generate Smart Numbers</button>
                        <button id="quickPick" class="p-3 bg-secondary text-white rounded-lg hover:bg-purple-700">Quick Pick (Random)</button>
                        <button id="generateWheeling" class="p-3 bg-accent text-white rounded-lg hover:bg-green-700">Generate Wheeling System</button>
                        <button id="clearGenerator" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear All</button>
                    </div>
                    <p class="mt-4 text-sm text-gray-600 dark:text-gray-400"><strong>Tip:</strong> Combine AI-Powered generation with historical data for statistically optimized numbers.</p>
                </div>

                <!-- Generated Tickets -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Generated Tickets</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="exportTxt" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export TXT</button>
                            <button id="exportCsv" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export CSV</button>
                            <button id="copyTickets" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                            <button id="saveTickets" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 text-sm">Save</button>
                        </div>
                    </div>
                    <div id="generatedTickets" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] flex flex-wrap items-center justify-center gap-3 text-gray-500 dark:text-gray-400">
                        <p>Generate some numbers to see results</p>
                    </div>
                </div>

                <!-- Analysis Panels for Generator -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Number Frequency</h3>
                        <canvas id="numberFrequencyChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Sum Analysis</h3>
                        <canvas id="sumAnalysisChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Pattern Analysis</h3>
                        <canvas id="patternAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- Advanced Analyzer Section -->
            <section id="analyzer" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="analyzer-title">
                <h2 id="analyzer-title" class="text-3xl font-bold mb-6 text-primary">Advanced Number Analyzer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Analysis Input -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Input Numbers</h3>
                        <div class="space-y-3">
                            <label for="analyzerGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Game Type</label>
                            <select id="analyzerGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="numbersToAnalyze" class="block text-base font-medium text-gray-700 dark:text-gray-300">Numbers to Analyze</label>
                            <textarea id="numbersToAnalyze" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)" aria-describedby="analyzer-format-tip"></textarea>
                            <p id="analyzer-format-tip" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: <code>5,12,23,34,45,6</code> or <code>5 12 23 34 45 6</code> or <code>5-12-23-34-45-6</code></p>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button id="analyzeNumbers" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Analyze</button>
                            <button id="getAIInsights" class="p-3 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">AI Insights ‚ú®</button>
                            <button id="clearAnalyzer" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Sample Inputs</h4>
                            <div class="text-sm space-y-1">
                                <button class="sample-input text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary" data-sample="5,12,23,34,45,6" data-game="powerball">Powerball Sample</button><br>
                                <button class="sample-input text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary" data-sample="3,18,29,41,52,15" data-game="megamillions">Mega Millions Sample</button><br>
                                <button class="sample-input text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary" data-sample="7,14,21,28,35" data-game="lotto649">Lotto 6/49 Sample</button>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Analysis Results -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Basic Analysis</h3>
                        <div id="analysisResults" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-500 dark:text-gray-400">
                            <p>Enter numbers to analyze them</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Number Properties</h4>
                                <div id="numberProps" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Pattern Analysis</h4>
                                <div id="patternStats" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Visual Analysis</h4>
                            <div id="visualAnalysis" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        
                        <!-- AI Insights Output -->
                        <div id="aiInsightsOutput" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md hidden" role="status" aria-live="polite">
                            <h4 class="font-semibold text-base mb-2">AI Insights</h4>
                            <div id="aiInsightsText" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            <div id="aiInsightsLoading" class="loading-indicator mx-auto mt-4 hidden" aria-hidden="true"></div>
                        </div>
                    </div>

                    <!-- Advanced Analysis -->
                    <div class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Advanced Metrics</h3>
                            <button id="exportAnalysis" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Basic Statistics</h4>
                                <div id="basicStats" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Advanced Metrics</h4>
                                <div id="advancedMetrics" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Number Frequency</h4>
                            <canvas id="freqDistributionChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Analysis Charts -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Last Digit Distribution</h4>
                        <canvas id="lastDigitDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Number Sum Distribution</h4>
                        <canvas id="sumDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Odd/Even Distribution</h4>
                        <canvas id="oddEvenDistributionChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- Seed Reverser Section -->
            <section id="seed-reverser" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="seed-reverser-title">
                <h2 id="seed-reverser-title" class="text-3xl font-bold mb-6 text-primary">Advanced Lotto Seed Reverser</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Input for Seed Reverser -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Input Numbers for Profile</h3>
                        <div class="space-y-3">
                            <label for="seedReverseGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Lottery Game</label>
                            <select id="seedReverseGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div>
                            <label for="numbersToReverse" class="block text-base font-medium text-gray-700 dark:text-gray-300">Numbers to Reverse Analyze</label>
                            <textarea id="numbersToReverse" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)" aria-describedby="seed-reverse-format-tip"></textarea>
                            <p id="seed-reverse-format-tip" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: <code>5,12,23,34,45,6</code> or <code>5 12 23 34 45 6</code></p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="reverseSeedBtn" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Generate Statistical Profile</button>
                            <button id="interpretSeedProfile" class="p-3 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">Interpret Profile ‚ú®</button>
                            <button id="clearSeedReverse" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <!-- Output for Seed Reverser -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Generated Statistical Profile</h3>
                        <div id="seedProfileResults" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-500 dark:text-gray-400">
                            <p>Enter numbers and generate profile</p>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Statistical Characteristics</h4>
                                <div id="seedStats" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Pattern Indicators</h4>
                                <div id="seedPatterns" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Visual Representation</h4>
                            <div id="seedVisuals" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <!-- AI Interpretation Output -->
                        <div id="seedInterpretationOutput" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md hidden" role="status" aria-live="polite">
                            <h4 class="font-semibold text-base mb-2">AI Interpretation</h4>
                            <div id="seedInterpretationText" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            <div id="seedInterpretationLoading" class="loading-indicator mx-auto mt-4 hidden" aria-hidden="true"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Historical Data Section -->
            <section id="historical" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="historical-title">
                <h2 id="historical-title" class="text-3xl font-bold mb-6 text-primary">Historical Data Explorer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Data Configuration -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Data Source</h3>
                        <div class="space-y-3">
                            <label for="historicalGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Game Type</label>
                            <select id="historicalGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div class="space-y-3">
                            <label for="dataSource" class="block text-base font-medium text-gray-700 dark:text-gray-300">Data Source</label>
                            <select id="dataSource" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="sample">Sample Data (Built-in)</option>
                                <option value="api">Live API (Premium)</option>
                                <option value="csv">Upload CSV</option>
                            </select>
                        </div>
                        
                        <div id="csvUploadContainer" class="hidden space-y-3">
                            <label for="csvUpload" class="block text-base font-medium text-gray-700 dark:text-gray-300">Upload CSV File</label>
                            <input id="csvUpload" type="file" accept=".csv" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">CSV format: <code>Date,Number1,Number2,...,Bonus1,Bonus2</code></p>
                        </div>
                        
                        <div class="space-y-3">
                            <label for="pastDraws" class="block text-base font-medium text-gray-700 dark:text-gray-300">Number of Past Draws</label>
                            <select id="pastDraws" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="10">10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">500</option>
                                <option value="all">All Available</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button id="loadData" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Load Data</button>
                            <button id="clearHistorical" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <!-- Data Summary -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Data Summary</h3>
                        <div id="dataSummary" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-500 dark:text-gray-400">
                            <p>Load historical data to see summary</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Most Frequent</h4>
                                <div id="mostFrequent" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                                <h4 class="font-semibold text-base mb-2">Least Frequent</h4>
                                <div id="leastFrequent" class="text-sm text-gray-700 dark:text-gray-300"></div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Due Numbers</h4>
                            <div id="dueNumbers" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>

                    <!-- Quick Analysis -->
                    <div class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Quick Analysis</h3>
                            <button id="exportHistorical" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Recent Trends</h4>
                            <div id="recentTrends" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Pattern Frequency</h4>
                            <div id="patternFrequency" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-base mb-2">Sum Statistics</h4>
                            <div id="sumStatistics" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Data Table -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Historical Draws</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table id="historicalTable" class="w-full text-left whitespace-nowrap">
                            <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 uppercase text-sm">
                                <tr>
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Numbers</th>
                                    <th class="p-3">Bonus</th>
                                    <th class="p-3">Sum</th>
                                    <th class="p-3">Odd/Even</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3">
                        <div class="text-base text-gray-600 dark:text-gray-400" id="paginationInfo">Showing 0 of 0</div>
                        <div class="flex gap-2">
                            <button id="prevPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Previous page"><</button>
                            <button id="nextPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled aria-label="Next page">></button>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Analysis Charts -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Number Frequency Heatmap</h4>
                        <canvas id="freqHeatmapChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Frequency Over Time</h4>
                        <canvas id="freqOverTimeChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                        <h4 class="font-semibold text-base mb-3">Gap Analysis</h4>
                        <canvas id="gapAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- AI Strategies Section -->
            <section id="strategies" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="strategies-title">
                <h2 id="strategies-title" class="text-3xl font-bold mb-6 text-primary">AI-Powered Strategies</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Strategy Cards -->
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg border-t-4 border-primary shadow-md">
                        <h3 class="text-xl font-semibold">Frequency Analysis</h3>
                        <p class="text-base mt-2 text-gray-700 dark:text-gray-300">Identifies hot (frequently drawn) and cold (rarely drawn) numbers based on historical data patterns.</p>
                        <button class="applyStrategy mt-4 p-3 bg-primary text-white rounded-lg hover:bg-blue-700 w-full" data-strategy="frequency">Apply Strategy</button>
                    </div>
                    
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg border-t-4 border-secondary shadow-md">
                        <h3 class="text-xl font-semibold">Gap Analysis</h3>
                        <p class="text-base mt-2 text-gray-700 dark:text-gray-300">Finds numbers that are statistically "due" to be drawn based on the time since their last appearance.</p>
                        <button class="applyStrategy mt-4 p-3 bg-secondary text-white rounded-lg hover:bg-purple-700 w-full" data-strategy="gap">Apply Strategy</button>
                    </div>
                    
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg border-t-4 border-accent shadow-md">
                        <h3 class="text-xl font-semibold">Pattern Recognition</h3>
                        <p class="text-base mt-2 text-gray-700 dark:text-gray-300">Detects number patterns and sequences that frequently occur in winning combinations.</p>
                        <button class="applyStrategy mt-4 p-3 bg-accent text-white rounded-lg hover:bg-green-700 w-full" data-strategy="pattern">Apply Strategy</button>
                    </div>
                </div>

                <!-- Custom Strategy Builder -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Custom Strategy Builder</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                            <h4 class="font-semibold text-lg mb-3">Strategy Components</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="frequency" checked> Number Frequency</label>
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="gap" checked> Gap Analysis</label>
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="pattern"> Pattern Recognition</label>
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="sum"> Sum Analysis</label>
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="prime"> Prime Numbers</label>
                                <label class="flex items-center text-base"><input type="checkbox" class="strategyComponent mr-2 h-5 w-5 text-primary rounded focus:ring-primary" value="fibonacci"> Fibonacci Numbers</label>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                            <h4 class="font-semibold text-lg mb-3">Weighting</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="freqWeight" class="block text-base font-medium text-gray-700 dark:text-gray-300">Frequency Importance</label>
                                    <input id="freqWeight" type="range" min="0" max="100" value="40" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                                    <span id="freqWeightValue" class="text-sm text-gray-600 dark:text-gray-400">40%</span>
                                </div>
                                <div>
                                    <label for="gapWeight" class="block text-base font-medium text-gray-700 dark:text-gray-300">Gap Importance</label>
                                    <input id="gapWeight" type="range" min="0" max="100" value="30" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                                    <span id="gapWeightValue" class="text-sm text-gray-600 dark:text-gray-400">30%</span>
                                </div>
                                <div>
                                    <label for="patternWeight" class="block text-base font-medium text-gray-700 dark:text-gray-300">Pattern Importance</label>
                                    <input id="patternWeight" type="range" min="0" max="100" value="20" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                                    <span id="patternWeightValue" class="text-sm text-gray-600 dark:text-gray-400">20%</span>
                                </div>
                                <div>
                                    <label for="otherWeight" class="block text-base font-medium text-gray-700 dark:text-gray-300">Other Importance</label>
                                    <input id="otherWeight" type="range" min="0" max="100" value="10" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                                    <span id="otherWeightValue" class="text-sm text-gray-600 dark:text-gray-400">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="buildStrategy" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Build & Apply Custom Strategy</button>
                    </div>
                </div>

                <!-- Strategy Results -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Strategy Results</h3>
                    <div id="strategyResults" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-500 dark:text-gray-400">
                        <p>Apply a strategy to see recommendations</p>
                    </div>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                            <h4 class="font-semibold text-lg mb-3">Recommended Numbers</h4>
                            <div id="recommendedNumbers" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md">
                            <h4 class="font-semibold text-lg mb-3">Strategy Analysis</h4>
                            <div id="strategyAnalysis" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Probability Lab Section -->
            <section id="probability" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="probability-title">
                <h2 id="probability-title" class="text-3xl font-bold mb-6 text-primary">Probability Laboratory</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Calculator -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Probability Calculator</h3>
                        <div class="space-y-3">
                            <label for="probabilityGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Game Type</label>
                            <select id="probabilityGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="calcMainMatch" class="block text-base font-medium text-gray-700 dark:text-gray-300">Main Numbers Match</label>
                                <input id="calcMainMatch" type="number" min="0" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" value="0">
                            </div>
                            <div>
                                <label for="calcBonusMatch" class="block text-base font-medium text-gray-700 dark:text-gray-300">Bonus Numbers Match</label>
                                <input id="calcBonusMatch" type="number" min="0" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" value="0">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="calculateProbability" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Calculate Probability</button>
                            <button id="clearProbability" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <!-- Results & Visuals -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Probability Results</h3>
                        <div id="probabilityResults" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-500 dark:text-gray-400">
                            <p>Enter criteria to calculate probability</p>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-lg mb-3">Probability Distribution</h4>
                            <canvas id="probabilityChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Prediction Engine Section -->
            <section id="prediction" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="prediction-title">
                <h2 id="prediction-title" class="text-3xl font-bold mb-6 text-primary">Prediction Engine</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Prediction Input -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Generate Predictions</h3>
                        <div class="space-y-3">
                            <label for="predictionGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Lottery Game</label>
                            <select id="predictionGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div class="space-y-3">
                            <label for="predictionModel" class="block text-base font-medium text-gray-700 dark:text-gray-300">Prediction Model</label>
                            <select id="predictionModel" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="ai-neural">AI Neural Network (Advanced)</option>
                                <option value="markov-chain">Markov Chain (Probabilistic)</option>
                                <option value="regression">Regression Analysis (Trend-based)</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="generatePrediction" class="p-3 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Generate Prediction</button>
                            <button id="clearPrediction" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        <div id="predictionLoading" class="flex items-center justify-center hidden" role="alert" aria-live="assertive">
                            <span class="loading-indicator mr-2"></span> Generating prediction...
                        </div>
                    </div>

                    <!-- Prediction Output -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Predicted Numbers</h3>
                        <div id="predictionResults" class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-[100px] flex flex-wrap items-center justify-center gap-3 text-gray-500 dark:text-gray-400">
                            <p>Generate a prediction to see results</p>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-lg mb-3">Prediction Confidence</h4>
                            <canvas id="predictionConfidenceChart" class="chart-container"></canvas>
                        </div>
                        <div id="predictionDetails" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hidden">
                            <h4 class="font-semibold text-lg mb-3">Prediction Details</h4>
                            <div id="predictionDetailsText" class="text-sm text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl" role="region" aria-labelledby="settings-title">
                <h2 id="settings-title" class="text-3xl font-bold mb-6 text-primary">Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">User Preferences</h3>
                        <div class="space-y-3">
                            <label for="defaultGame" class="block text-base font-medium text-gray-700 dark:text-gray-300">Default Lottery Game</label>
                            <select id="defaultGame" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="powerball">Powerball</option>
                                <option value="megamillions">Mega Millions</option>
                                <option value="euromillions">EuroMillions</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        <div class="space-y-3">
                            <label class="flex items-center text-base">
                                <input id="saveHistoricalData" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary" checked> Auto-save Historical Data
                            </label>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Automatically saves generated and analyzed numbers to your local history.</p>
                        </div>
                        <div class="space-y-3">
                            <label class="flex items-center text-base">
                                <input id="enableNotifications" type="checkbox" class="mr-2 h-5 w-5 text-primary rounded focus:ring-primary" checked> Enable Desktop Notifications
                            </label>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Receive alerts for new draws or important updates.</p>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">Data Management</h3>
                        <button id="exportAllData" class="p-3 bg-secondary text-white rounded-lg hover:bg-purple-700 w-full">Export All Data (JSON)</button>
                        <button id="importData" class="p-3 bg-accent text-white rounded-lg hover:bg-green-700 w-full">Import Data (JSON)</button>
                        <button id="clearAllData" class="p-3 bg-danger text-white rounded-lg hover:bg-red-600 w-full">Clear All Local Data</button>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Use with caution. This will remove all saved data from your browser.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notifications Toast Container -->
    <div id="notificationToastContainer" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Notifications will be appended here -->
    </div>

    <!-- Chart.js and Lodash CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <!-- Main Application Script (app.js - suggested for modularity) -->
    <script>
        // Global application state
        const appState = {
            historicalData: [], // Stores generated/analyzed draws
            gameConfig: {
                powerball: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1 },
                megamillions: { mainPool: 70, pickCount: 5, bonusPool: 25, bonusCount: 1 },
                euromillions: { mainPool: 50, pickCount: 5, bonusPool: 12, bonusCount: 2 },
                lotto649: { mainPool: 49, pickCount: 6, bonusPool: 0, bonusCount: 0 },
                lotto645: { mainPool: 45, pickCount: 6, bonusPool: 0, bonusCount: 0 },
                custom: { mainPool: 0, pickCount: 0, bonusPool: 0, bonusCount: 0 } // Dynamically set
            },
            notifications: [],
            // Store calculated hot/cold/due numbers for current game type
            currentHotNumbers: [],
            currentColdNumbers: [],
            currentDueNumbers: []
        };

        // Utility Functions (Example: utils.js)
        const Utils = {
            // Parses a string of numbers into an array, handling various delimiters
            parseNumbers: (input, gameType) => {
                const numbers = input.split(/[, -]+/).map(Number).filter(n => !isNaN(n) && n > 0);
                const config = appState.gameConfig[gameType];
                if (!config) {
                    console.error("Invalid game type for parsing numbers.");
                    return { main: [], bonus: [] };
                }

                // Basic validation and separation of main and bonus numbers
                const mainNumbers = numbers.slice(0, config.pickCount);
                const bonusNumbers = numbers.slice(config.pickCount, config.pickCount + config.bonusCount);

                return { main: mainNumbers, bonus: bonusNumbers };
            },
            // Generates a set of unique random numbers within a given range
            generateRandomNumbers: (count, max) => {
                const numbers = new Set();
                while (numbers.size < count) {
                    numbers.add(Math.floor(Math.random() * max) + 1);
                }
                return Array.from(numbers).sort((a, b) => a - b);
            },
            // Calculates the sum of an array of numbers
            calculateSum: (numbers) => _.sum(numbers),
            // Counts odd and even numbers in an array
            countOddEven: (numbers) => {
                const oddCount = numbers.filter(n => n % 2 !== 0).length;
                return { odd: oddCount, even: numbers.length - oddCount };
            },
            // Debounces a function call
            debounce: (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            },
            // Throttles a function call
            throttle: (func, limit) => {
                let inThrottle;
                return function(...args) {
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            // Exports data to a CSV file
            exportToCSV: (filename, data) => {
                const csvRows = [];
                if (data.length === 0) return;

                const headers = Object.keys(data[0]);
                csvRows.push(headers.join(','));

                for (const row of data) {
                    const values = headers.map(header => {
                        const val = row[header];
                        return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                    });
                    csvRows.push(values.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            // Exports data to a TXT file
            exportToTXT: (filename, data) => {
                const textContent = data.join('\n');
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            // Copies text to clipboard
            copyToClipboard: (text) => {
                document.execCommand('copy'); // Fallback for iFrame
                navigator.clipboard.writeText(text).then(() => {
                    Notifier.showNotification('Copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    Notifier.showNotification('Failed to copy to clipboard. Please try manually.', 'error');
                });
            },
            // Checks if a number is prime
            isPrime: (num) => {
                if (num <= 1) return false;
                for (let i = 2; i <= Math.sqrt(num); i++) {
                    if (num % i === 0) return false;
                }
                return true;
            },
            // Checks if a number is a Fibonacci number
            isFibonacci: (num) => {
                const isPerfectSquare = (n) => Math.sqrt(n) % 1 === 0;
                return isPerfectSquare(5 * num * num + 4) || isPerfectSquare(5 * num * num - 4);
            },
            // Calculates standard deviation
            calculateStdDev: (numbers) => {
                if (numbers.length === 0) return 0;
                const mean = _.mean(numbers);
                const sumOfSquares = _.sum(numbers.map(n => Math.pow(n - mean, 2)));
                return Math.sqrt(sumOfSquares / numbers.length);
            },
            // Calculates median
            calculateMedian: (numbers) => {
                if (numbers.length === 0) return 0;
                const sorted = [...numbers].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            },
            // Calculates mode (most frequent number)
            calculateMode: (numbers) => {
                if (numbers.length === 0) return [];
                const counts = _.countBy(numbers);
                let mode = [];
                let maxCount = 0;
                for (const num in counts) {
                    if (counts[num] > maxCount) {
                        mode = [Number(num)];
                        maxCount = counts[num];
                    } else if (counts[num] === maxCount) {
                        mode.push(Number(num));
                    }
                }
                return mode;
            }
        };

        // UI Helpers (Example: ui.js)
        const UI = {
            // Toggles sidebar visibility
            toggleSidebar: () => {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content-area');
                sidebar.classList.toggle('sidebar-hidden');
                // Adjust main content margin only on smaller screens
                if (window.innerWidth < 768) {
                    mainContent.style.marginLeft = sidebar.classList.contains('sidebar-hidden') ? '0' : '16rem';
                }
            },
            // Toggles dark/light theme
            toggleTheme: () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            },
            // Renders number balls with appropriate styling for hot/cold/due
            renderNumberBalls: (containerId, numbers, bonusNumbers = [], hotNumbers = [], coldNumbers = [], dueNumbers = []) => {
                const container = typeof containerId === 'string' ? document.getElementById(containerId) : containerId;
                if (!container) {
                    console.error('Container not found:', containerId);
                    return;
                }
                container.innerHTML = '';
                if (numbers.length === 0 && bonusNumbers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No numbers to display.</p>';
                    return;
                }
                const allNumbers = [...numbers, ...bonusNumbers];
                allNumbers.forEach(num => {
                    const ball = document.createElement('span');
                    let classes = ['number-ball'];
                    if (bonusNumbers.includes(num)) classes.push('bonus-ball');
                    if (hotNumbers.includes(num)) classes.push('hot-number');
                    else if (coldNumbers.includes(num)) classes.push('cold-number'); // Cold if not hot
                    if (dueNumbers.includes(num)) classes.push('due-number'); // Due can overlap with hot/cold

                    ball.className = classes.join(' ');
                    ball.textContent = num;
                    container.appendChild(ball);
                });
            },
            // Shows a loading indicator
            showLoading: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.remove('hidden');
                }
            },
            // Hides a loading indicator
            hideLoading: (elementId) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('hidden');
                }
            },
            // Updates an existing Chart.js instance
            updateChart: (chartInstance, labels, data, label, backgroundColor = 'rgba(59, 130, 246, 0.6)') => {
                if (chartInstance) {
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    chartInstance.data.datasets[0].label = label;
                    chartInstance.data.datasets[0].backgroundColor = backgroundColor;
                    chartInstance.update();
                }
            },
            // Initializes a new Chart.js instance
            initChart: (ctx, type, labels, data, label, backgroundColor = 'rgba(59, 130, 246, 0.6)') => {
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: '#3B82F6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            },
            // Updates the notification badge count
            updateNotificationBadge: () => {
                const badge = document.getElementById('notificationBadge');
                const count = appState.notifications.filter(n => !n.read).length;
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            },
            // Displays a toast notification
            showNotification: (message, type = 'info', duration = 3000) => {
                const container = document.getElementById('notificationToastContainer');
                const toast = document.createElement('div');
                toast.className = `p-4 rounded-lg shadow-lg text-white mb-2 flex items-center justify-between transition-all duration-300 transform translate-x-full opacity-0`;
                
                let bgColor = 'bg-gray-700';
                if (type === 'success') bgColor = 'bg-accent';
                else if (type === 'error') bgColor = 'bg-danger';
                else if (type === 'warning') bgColor = 'bg-warning';
                
                toast.classList.add(bgColor);
                toast.innerHTML = `
                    <span>${message}</span>
                    <button class="ml-4 text-white opacity-75 hover:opacity-100 focus:outline-none close-toast" aria-label="Close notification">
                        &times;
                    </button>
                `;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 100);

                const closeBtn = toast.querySelector('.close-toast');
                closeBtn.addEventListener('click', () => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                });

                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
        };

        const Notifier = {
            // Adds a new notification and displays it
            addNotification: (message, type = 'info') => {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    read: false,
                    timestamp: new Date()
                };
                appState.notifications.push(notification);
                UI.updateNotificationBadge();
                UI.showNotification(message, type);
            },
            // Marks all notifications as read
            markAllAsRead: () => {
                appState.notifications.forEach(n => n.read = true);
                UI.updateNotificationBadge();
            },
            // Clears all notifications
            clearAllNotifications: () => {
                appState.notifications = [];
                UI.updateNotificationBadge();
            }
        };

        // Data Store (Example: dataStore.js)
        const DataStore = {
            // Saves the application state to local storage with debouncing
            saveState: Utils.debounce(() => {
                try {
                    localStorage.setItem('lottoGeniusState', JSON.stringify(appState));
                    console.log("App state saved.");
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                    Notifier.showNotification("Failed to save data. Browser storage might be full.", "error");
                }
            }, 1000),

            // Loads the application state from local storage
            loadState: () => {
                try {
                    const savedState = localStorage.getItem('lottoGeniusState');
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        // Deep merge to preserve new default configs while loading old data
                        _.merge(appState, parsedState);
                        console.log("App state loaded.");
                    }
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                    Notifier.showNotification("Failed to load saved data. Data might be corrupted.", "error");
                    localStorage.removeItem('lottoGeniusState'); // Clear corrupted data
                }
            },

            // Adds a new historical draw to the state and saves it
            addHistoricalDraw: (draw) => {
                appState.historicalData.push(draw);
                DataStore.saveState();
                Notifier.showNotification("New draw added to historical data.");
            },
            // Clears all local data
            clearAllData: () => {
                if (confirm("Are you sure you want to clear all local data? This action cannot be undone.")) {
                    localStorage.removeItem('lottoGeniusState');
                    appState.historicalData = [];
                    appState.notifications = [];
                    appState.currentHotNumbers = [];
                    appState.currentColdNumbers = [];
                    appState.currentDueNumbers = [];
                    Notifier.showNotification("All local data cleared successfully.", "success");
                    location.reload();
                }
            },
            // Exports all application data as JSON
            exportAllData: () => {
                const data = JSON.stringify(appState, null, 2);
                Utils.exportToTXT('lotto_genius_data.json', [data]);
            },
            // Imports data from a JSON file
            importData: (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (confirm("Are you sure you want to import data? This will overwrite your current saved data.")) {
                            _.merge(appState, importedState); // Deep merge
                            DataStore.saveState();
                            Notifier.showNotification("Data imported successfully!", "success");
                            location.reload();
                        }
                    } catch (error) {
                        Notifier.showNotification("Failed to import data. Invalid JSON file.", "error");
                        console.error("Import error:", error);
                    }
                };
                reader.readAsText(file);
            }
        };

        // Core Lottery Logic (Example: lotteryLogic.js)
        const Lottery = {
            // Retrieves game configuration
            getGameConfig: (gameType) => {
                return appState.gameConfig[gameType];
            },

            // Analyzes historical data to find hot, cold, and due numbers
            analyzeHistoricalTrends: (historicalData, gameConfig) => {
                if (historicalData.length === 0) {
                    return { hot: [], cold: [], due: [] };
                }

                const allNumbers = historicalData.flatMap(d => d.numbers.concat(d.bonus));
                const frequencyMap = _.countBy(allNumbers);

                // Determine all possible numbers in the main pool
                const possibleMainNumbers = Array.from({ length: gameConfig.mainPool }, (_, i) => i + 1);
                const possibleBonusNumbers = gameConfig.bonusPool > 0 ? Array.from({ length: gameConfig.bonusPool }, (_, i) => i + 1) : [];

                // Sort numbers by frequency to identify hot/cold
                const sortedFrequencies = Object.entries(frequencyMap)
                    .map(([num, count]) => ({ num: Number(num), count: count }))
                    .sort((a, b) => b.count - a.count);

                // Hot numbers: Top 10% of the most frequent numbers
                const hotNumbers = sortedFrequencies
                    .slice(0, Math.ceil(gameConfig.mainPool * 0.15)) // Top 15%
                    .map(item => item.num);

                // Cold numbers: Bottom 10% of the least frequent numbers
                const coldNumbers = sortedFrequencies
                    .slice(Math.max(0, sortedFrequencies.length - Math.ceil(gameConfig.mainPool * 0.15))) // Bottom 15%
                    .map(item => item.num);

                // Due numbers: Numbers not seen in the last 10-20 draws (configurable)
                const recentDrawsCount = Math.min(20, historicalData.length); // Look at last 20 draws or fewer if not enough data
                const recentNumbers = historicalData.slice(0, recentDrawsCount).flatMap(d => d.numbers.concat(d.bonus));
                const dueNumbers = possibleMainNumbers.filter(num => !recentNumbers.includes(num));
                
                // Add bonus due numbers if applicable
                if (gameConfig.bonusCount > 0) {
                    const recentBonusNumbers = historicalData.slice(0, recentDrawsCount).flatMap(d => d.bonus);
                    const bonusDueNumbers = possibleBonusNumbers.filter(num => !recentBonusNumbers.includes(num));
                    dueNumbers.push(...bonusDueNumbers);
                }

                return { hot: hotNumbers, cold: coldNumbers, due: dueNumbers };
            },

            // Generates smart numbers with various biases and filters
            generateSmartNumbers: (gameType, options) => {
                const config = Lottery.getGameConfig(gameType);
                if (!config) {
                    Notifier.showNotification("Invalid game configuration for generation.", "error");
                    return [];
                }

                const generatedTickets = [];
                const { hot: historicalHot, cold: historicalCold, due: historicalDue } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);
                appState.currentHotNumbers = historicalHot; // Store for UI rendering
                appState.currentColdNumbers = historicalCold;
                appState.currentDueNumbers = historicalDue;

                for (let i = 0; i < (options.numTickets || 1); i++) {
                    let mainNumbers = new Set();
                    let bonusNumbers = new Set();
                    let attempts = 0;
                    const maxAttemptsPerNumber = 1000; // Prevent infinite loops for strict filters

                    // Function to pick a number with bias
                    const pickNumberWithBias = (poolMax, isBonus = false) => {
                        let num;
                        let pool = Array.from({ length: poolMax }, (_, i) => i + 1);
                        let availableHot = isBonus ? historicalHot.filter(n => n <= poolMax) : historicalHot.filter(n => n <= poolMax);
                        let availableDue = isBonus ? historicalDue.filter(n => n <= poolMax) : historicalDue.filter(n => n <= poolMax);
                        let availableCold = isBonus ? historicalCold.filter(n => n <= poolMax) : historicalCold.filter(n => n <= poolMax);

                        // Prioritize based on options and availability
                        if (options.useHistorical) {
                            if (options.favorHot && availableHot.length > 0 && Math.random() < 0.4) { // 40% chance to pick hot
                                num = _.sample(availableHot);
                            } else if (options.includeDue && availableDue.length > 0 && Math.random() < 0.3) { // 30% chance to pick due
                                num = _.sample(availableDue);
                            } else if (options.generationMethod === 'ai' && Math.random() < 0.2) { // AI might try to balance hot/cold/due
                                // A more complex AI would use a weighted probability distribution
                                num = _.sample(pool); // For simulation, still random
                            } else {
                                num = _.sample(pool); // Default random
                            }
                        } else {
                            num = _.sample(pool); // Pure random if historical data not used
                        }
                        return num;
                    };

                    // Generate Main Numbers
                    while (mainNumbers.size < config.pickCount && attempts < maxAttemptsPerNumber * config.pickCount) {
                        let num = pickNumberWithBias(config.mainPool);
                        if (num && !mainNumbers.has(num)) {
                            // Apply additional filters (sum, odd/even, consecutive, prime, fibonacci)
                            let isValid = true;
                            const tempNumbers = [...Array.from(mainNumbers), num].sort((a,b) => a-b);

                            // Sum filter (very basic, would need a range)
                            if (options.sumFilter !== 'any') {
                                const currentSum = Utils.calculateSum(tempNumbers);
                                // This is a very simplified check. A real filter needs min/max ranges.
                                if (options.sumFilter === 'low' && currentSum > (config.mainPool * config.pickCount * 0.3)) isValid = false;
                                if (options.sumFilter === 'medium' && (currentSum < (config.mainPool * config.pickCount * 0.3) || currentSum > (config.mainPool * config.pickCount * 0.7))) isValid = false;
                                if (options.sumFilter === 'high' && currentSum < (config.mainPool * config.pickCount * 0.7)) isValid = false;
                            }

                            // Consecutive filter
                            if (options.consecutiveFilter !== 'any') {
                                let consecutivePairs = 0;
                                for (let k = 0; k < tempNumbers.length - 1; k++) {
                                    if (tempNumbers[k+1] === tempNumbers[k] + 1) {
                                        consecutivePairs++;
                                    }
                                }
                                if (options.consecutiveFilter === 'none' && consecutivePairs > 0) isValid = false;
                                if (options.consecutiveFilter === 'max1' && consecutivePairs > 1) isValid = false;
                                if (options.consecutiveFilter === 'max2' && consecutivePairs > 2) isValid = false;
                            }

                            // Prime/Fibonacci filters
                            if (options.generationMethod === 'prime' && !Utils.isPrime(num)) isValid = false;
                            if (options.generationMethod === 'fibonacci' && !Utils.isFibonacci(num)) isValid = false;
                            // For 'ai' or 'statistical', these could be weighted
                            
                            if (isValid) {
                                mainNumbers.add(num);
                            }
                        }
                        attempts++;
                    }
                    // Fallback to random if filters are too strict
                    while (mainNumbers.size < config.pickCount) {
                        mainNumbers.add(Math.floor(Math.random() * config.mainPool) + 1);
                    }

                    // Generate Bonus Numbers
                    if (config.bonusCount > 0) {
                        attempts = 0;
                        while (bonusNumbers.size < config.bonusCount && attempts < maxAttemptsPerNumber * config.bonusCount) {
                            let num = pickNumberWithBias(config.bonusPool, true);
                            if (num && !bonusNumbers.has(num)) {
                                bonusNumbers.add(num);
                            }
                            attempts++;
                        }
                        while (bonusNumbers.size < config.bonusCount) {
                            bonusNumbers.add(Math.floor(Math.random() * config.bonusPool) + 1);
                        }
                    }
                    
                    generatedTickets.push({
                        main: Array.from(mainNumbers).sort((a, b) => a - b),
                        bonus: Array.from(bonusNumbers).sort((a, b) => a - b),
                        timestamp: new Date().toISOString()
                    });
                }
                return generatedTickets;
            },

            // Performs advanced statistical analysis on a set of numbers
            analyzeNumbers: (numbers, bonusNumbers, gameType) => {
                const config = Lottery.getGameConfig(gameType);
                const allNumbers = numbers.concat(bonusNumbers);
                allNumbers.sort((a, b) => a - b); // Ensure sorted for pattern analysis

                const sum = Utils.calculateSum(allNumbers);
                const { odd, even } = Utils.countOddEven(allNumbers);
                const min = _.min(allNumbers) || 0;
                const max = _.max(allNumbers) || 0;
                const average = _.mean(allNumbers).toFixed(2);
                const median = Utils.calculateMedian(allNumbers).toFixed(2);
                const stdDev = Utils.calculateStdDev(allNumbers).toFixed(2);
                const mode = Utils.calculateMode(allNumbers);

                // Consecutive pairs/triplets
                let consecutivePairs = 0;
                let consecutiveTriplets = 0;
                for (let i = 0; i < numbers.length - 1; i++) {
                    if (numbers[i+1] === numbers[i] + 1) {
                        consecutivePairs++;
                        if (i < numbers.length - 2 && numbers[i+2] === numbers[i] + 2) {
                            consecutiveTriplets++;
                        }
                    }
                }

                // Prime/Fibonacci counts
                const primeCount = allNumbers.filter(n => Utils.isPrime(n)).length;
                const fibonacciCount = allNumbers.filter(n => Utils.isFibonacci(n)).length;

                // Last digit distribution
                const lastDigitFreq = _.countBy(allNumbers.map(n => n % 10));

                // Decade/Tens distribution (e.g., 1-10, 11-20, etc.)
                const decadeFreq = {};
                allNumbers.forEach(n => {
                    const decade = Math.ceil(n / 10) * 10;
                    decadeFreq[decade] = (decadeFreq[decade] || 0) + 1;
                });

                // Compare against historical trends (hot/cold/due)
                const { hot: historicalHot, cold: historicalCold, due: historicalDue } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);
                const hotMatches = allNumbers.filter(n => historicalHot.includes(n)).length;
                const coldMatches = allNumbers.filter(n => historicalCold.includes(n)).length;
                const dueMatches = allNumbers.filter(n => historicalDue.includes(n)).length;

                return {
                    sum: sum,
                    oddEvenRatio: `${odd}/${even}`,
                    min: min,
                    max: max,
                    average: average,
                    median: median,
                    stdDev: stdDev,
                    mode: mode,
                    consecutivePairs: consecutivePairs,
                    consecutiveTriplets: consecutiveTriplets,
                    primeCount: primeCount,
                    fibonacciCount: fibonacciCount,
                    lastDigitFreq: lastDigitFreq,
                    decadeFreq: decadeFreq,
                    hotMatches: hotMatches,
                    coldMatches: coldMatches,
                    dueMatches: dueMatches,
                    allNumbers: allNumbers, // Include for easier access in prompt
                    mainNumbers: numbers,
                    bonusNumbers: bonusNumbers
                };
            },

            // Calculates lottery probability
            calculateProbability: (gameType, mainMatches, bonusMatches) => {
                const config = Lottery.getGameConfig(gameType);
                if (!config || mainMatches > config.pickCount || bonusMatches > config.bonusCount || mainMatches < 0 || bonusMatches < 0) {
                    return "Invalid input for probability calculation.";
                }

                const combinations = (n, k) => {
                    if (k < 0 || k > n) return 0;
                    if (k === 0 || k === n) return 1;
                    if (k > n / 2) k = n - k;
                    let res = 1;
                    for (let i = 1; i <= k; ++i) {
                        res = res * (n - i + 1) / i;
                    }
                    return res;
                };

                const totalMainCombinations = combinations(config.mainPool, config.pickCount);
                const totalBonusCombinations = combinations(config.bonusPool, config.bonusCount);

                const winningMainCombinations = combinations(config.pickCount, mainMatches) * combinations(config.mainPool - config.pickCount, config.pickCount - mainMatches);
                const winningBonusCombinations = combinations(config.bonusCount, bonusMatches) * combinations(config.bonusPool - config.bonusCount, config.bonusCount - bonusMatches);

                // Handle cases where bonus pool is 0 but bonus matches are requested
                if (config.bonusPool === 0 && bonusMatches > 0) {
                    return "Invalid: Bonus matches requested for a game without a bonus pool.";
                }
                
                // If bonus pool is 0, bonus combinations are 1 (no bonus to match)
                const finalBonusCombinations = config.bonusPool === 0 ? 1 : totalBonusCombinations;
                const finalWinningBonusCombinations = config.bonusPool === 0 ? 1 : winningBonusCombinations;

                const probability = (winningMainCombinations / totalMainCombinations) * (finalWinningBonusCombinations / finalBonusCombinations);
                
                if (probability === 0) return "Extremely low (effectively 1 in ‚àû)";
                return `1 in ${Math.round(1 / probability).toLocaleString()}`;
            },

            // Simulates AI-powered number prediction
            predictNumbers: async (gameType, model) => {
                UI.showLoading('predictionLoading');
                await new Promise(resolve => setTimeout(resolve, 2500)); // Simulate API call delay

                const config = Lottery.getGameConfig(gameType);
                if (!config) return { predictedMain: [], predictedBonus: [], confidence: 0, details: "Invalid game configuration." };

                // Get current historical trends to inform prediction
                const { hot: historicalHot, cold: historicalCold, due: historicalDue } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);

                let predictedMain = [];
                let predictedBonus = [];
                let confidence = 0;
                let details = "";

                if (appState.historicalData.length < 50 && (model === 'ai-neural' || model === 'markov-chain')) {
                    details = `Insufficient historical data (${appState.historicalData.length} draws) for robust ${model} prediction. Using a statistically weighted approach.`;
                    model = 'statistical'; // Fallback to statistical if not enough data for advanced models
                }

                switch (model) {
                    case 'ai-neural':
                        // Simulated Neural Network logic: heavily favors hot and due numbers, avoids cold
                        predictedMain = Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'ai',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true,
                            avoidRepeats: true // AI might learn to avoid recent repeats
                        })[0].main;
                        predictedBonus = config.bonusCount > 0 ? Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'ai',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].bonus : [];
                        confidence = 75 + Math.random() * 20; // High confidence for AI
                        details = `AI Neural Network model predicts numbers with a strong emphasis on historically "hot" and "due" numbers, while minimizing "cold" numbers. This model identifies subtle patterns in past draws.`;
                        break;
                    case 'markov-chain':
                        // Simulated Markov Chain logic: predicts based on transitions between numbers
                        // For simplicity, this is still a biased random pick, but conceptually different
                        predictedMain = Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].main; // Still using biased random for simulation
                        predictedBonus = config.bonusCount > 0 ? Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].bonus : [];
                        confidence = 60 + Math.random() * 25; // Moderate confidence
                        details = `Markov Chain analysis predicts numbers based on the probability of one number following another in historical draws. It identifies common sequences and transitions.`;
                        break;
                    case 'regression':
                        // Simulated Regression Analysis: looks for linear/non-linear trends (e.g., sum trends)
                        // For simplicity, this will also lean on hot/due numbers
                        predictedMain = Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].main; // Still using biased random for simulation
                        predictedBonus = config.bonusCount > 0 ? Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].bonus : [];
                        confidence = 50 + Math.random() * 20; // Lower confidence, as trends are less reliable in true randomness
                        details = `Regression analysis identifies potential trends in number sums, odd/even ratios, or other statistical properties over time. This prediction attempts to follow those identified trends.`;
                        break;
                    case 'statistical':
                    default:
                        // Default statistical approach: heavily weighted towards hot and due numbers
                        predictedMain = Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].main;
                        predictedBonus = config.bonusCount > 0 ? Lottery.generateSmartNumbers(gameType, {
                            numTickets: 1,
                            generationMethod: 'statistical',
                            useHistorical: true,
                            favorHot: true,
                            includeDue: true
                        })[0].bonus : [];
                        confidence = 40 + Math.random() * 20; // Basic confidence
                        details = `This prediction is based on a weighted statistical analysis of hot, cold, and due numbers from historical data.`;
                        break;
                }
                
                // Add common insights based on generated numbers
                const allPredicted = predictedMain.concat(predictedBonus);
                const predictedSum = Utils.calculateSum(allPredicted);
                const { odd: predictedOdd, even: predictedEven } = Utils.countOddEven(allPredicted);
                const hotCount = allPredicted.filter(n => historicalHot.includes(n)).length;
                const dueCount = allPredicted.filter(n => historicalDue.includes(n)).length;
                const coldCount = allPredicted.filter(n => historicalCold.includes(n)).length;

                details += `<br><br><strong>Prediction Characteristics:</strong>
                    <ul>
                        <li>Sum: ${predictedSum} (often falls within historical average range)</li>
                        <li>Odd/Even Ratio: ${predictedOdd}:${predictedEven} (aims for balance)</li>
                        <li>Hot Numbers Included: ${hotCount}</li>
                        <li>Due Numbers Included: ${dueCount}</li>
                        <li>Cold Numbers Avoided: ${coldCount}</li>
                    </ul>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Remember: Lottery outcomes are inherently random. Predictions are based on statistical patterns and should be used for entertainment purposes only.</p>
                `;

                UI.hideLoading('predictionLoading');
                return { predictedMain, predictedBonus, confidence: confidence.toFixed(2), details };
            }
        };

        // Chart Instances
        let dashboardHeatmapChart, dashboardPatternsChart;
        let numberFrequencyChart, sumAnalysisChart, patternAnalysisChart;
        let freqDistributionChart, lastDigitDistributionChart, sumDistributionChart, oddEvenDistributionChart;
        let freqHeatmapHistoricalChart, freqOverTimeChart, gapAnalysisChart;
        let probabilityChart;
        let predictionConfidenceChart;

        // Event Listeners and Initialization (app.js main entry)
        document.addEventListener('DOMContentLoaded', () => {
            DataStore.loadState();
            UI.updateNotificationBadge();

            // Apply saved theme
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // Sidebar Toggles
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content-area');

            document.getElementById('toggleSidebar').addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-hidden');
                if (window.innerWidth < 768) {
                    mainContent.style.marginLeft = sidebar.classList.contains('sidebar-hidden') ? '0' : '16rem';
                }
            });
            document.getElementById('closeSidebar').addEventListener('click', () => {
                sidebar.classList.add('sidebar-hidden');
                if (window.innerWidth < 768) {
                    mainContent.style.marginLeft = '0';
                }
            });

            // Ensure sidebar is visible on desktop on load and resize
            const handleResize = () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('sidebar-hidden');
                    mainContent.style.marginLeft = '16rem';
                } else {
                    // Only hide if it was explicitly hidden by the user on mobile
                    if (!sidebar.classList.contains('sidebar-hidden')) {
                         mainContent.style.marginLeft = '16rem'; // Keep it open if not explicitly hidden
                    } else {
                         mainContent.style.marginLeft = '0'; // Keep it closed if explicitly hidden
                    }
                }
            };
            window.addEventListener('resize', handleResize);
            handleResize(); // Call on load


            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', UI.toggleTheme);

            // Navigation Links (Smooth scrolling and active state)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.closest('a').getAttribute('href').substring(1);
                    document.getElementById(targetId).scrollIntoView({ behavior: 'smooth' });

                    document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('text-white', 'bg-primary'));
                    e.target.closest('a').classList.add('text-white', 'bg-primary');

                    if (window.innerWidth < 768) {
                        UI.toggleSidebar();
                    }
                });
            });

            // Quick Actions
            document.querySelectorAll('.quick-action').forEach(button => {
                button.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    switch (action) {
                        case 'quickPick':
                            const game = document.getElementById('lotteryGame').value;
                            const generated = Lottery.generateSmartNumbers(game, { numTickets: 1, generationMethod: 'standard' });
                            if (generated.length > 0) {
                                UI.renderNumberBalls('generatedTickets', generated[0].main, generated[0].bonus);
                                Notifier.showNotification("Quick Pick generated!");
                            }
                            break;
                        case 'analyzeLast':
                            if (appState.historicalData.length > 0) {
                                const lastDraw = appState.historicalData[appState.historicalData.length - 1];
                                document.getElementById('numbersToAnalyze').value = [...lastDraw.numbers, ...lastDraw.bonus].join(', ');
                                document.getElementById('analyzerGame').value = document.getElementById('historicalGame').value; // Infer game type from historical
                                document.getElementById('analyzeNumbers').click();
                                Notifier.showNotification("Last historical draw loaded for analysis.");
                            } else {
                                Notifier.showNotification('No historical data to analyze!', 'warning');
                            }
                            break;
                        case 'checkOdds':
                            document.getElementById('probability').scrollIntoView({ behavior: 'smooth' });
                            Notifier.showNotification("Scrolled to Probability Lab.");
                            break;
                    }
                });
            });

            // Dashboard Charts (Initialize placeholders)
            dashboardHeatmapChart = UI.initChart(document.getElementById('dashboardHeatmap').getContext('2d'), 'bar', [], [], 'Frequency');
            dashboardPatternsChart = UI.initChart(document.getElementById('dashboardPatterns').getContext('2d'), 'line', [], [], 'Patterns');

            // Generator Section Logic
            const lotteryGameSelect = document.getElementById('lotteryGame');
            const customGameConfigDiv = document.getElementById('customGameConfig');

            lotteryGameSelect.addEventListener('change', () => {
                if (lotteryGameSelect.value === 'custom') {
                    customGameConfigDiv.classList.remove('hidden');
                } else {
                    customGameConfigDiv.classList.add('hidden');
                    const config = appState.gameConfig[lotteryGameSelect.value];
                    document.getElementById('mainPool').value = config.mainPool;
                    document.getElementById('pickCount').value = config.pickCount;
                    document.getElementById('bonusPool').value = config.bonusPool;
                    document.getElementById('bonusCount').value = config.bonusCount;
                }
            });

            document.getElementById('randomSeedBtn').addEventListener('click', () => {
                document.getElementById('randomSeed').value = Math.random().toString(36).substring(2, 10).toUpperCase();
                Notifier.showNotification("Random seed generated.");
            });

            document.getElementById('generateSmart').addEventListener('click', () => {
                const gameType = lotteryGameSelect.value;
                const options = {
                    numTickets: parseInt(document.getElementById('numTickets').value),
                    generationMethod: document.getElementById('generationMethod').value,
                    useHistorical: document.getElementById('useHistorical').checked,
                    favorHot: document.getElementById('favorHot').checked,
                    includeDue: document.getElementById('includeDue').checked,
                    avoidRepeats: document.getElementById('avoidRepeats').checked,
                    sumFilter: document.getElementById('sumFilter').value,
                    consecutiveFilter: document.getElementById('consecutiveFilter').value,
                    randomSeed: document.getElementById('randomSeed').value
                };

                if (gameType === 'custom') {
                    appState.gameConfig.custom.mainPool = parseInt(document.getElementById('mainPool').value);
                    appState.gameConfig.custom.pickCount = parseInt(document.getElementById('pickCount').value);
                    appState.gameConfig.custom.bonusPool = parseInt(document.getElementById('bonusPool').value);
                    appState.gameConfig.custom.bonusCount = parseInt(document.getElementById('bonusCount').value);
                    if (appState.gameConfig.custom.pickCount > appState.gameConfig.custom.mainPool ||
                        appState.gameConfig.custom.bonusCount > appState.gameConfig.custom.bonusPool) {
                        Notifier.showNotification("Custom game configuration is invalid. Pick count cannot exceed pool size.", "error");
                        return;
                    }
                }

                UI.showLoading('generatedTickets');
                const generated = Lottery.generateSmartNumbers(gameType, options);
                UI.hideLoading('generatedTickets');

                if (generated.length > 0) {
                    document.getElementById('generatedTickets').innerHTML = '';
                    generated.forEach(ticket => {
                        const ticketDiv = document.createElement('div');
                        ticketDiv.className = 'flex flex-wrap gap-1 items-center bg-gray-200 dark:bg-gray-600 p-2 rounded-md shadow-sm';
                        // Pass hot/cold/due numbers to renderNumberBalls for visual highlighting
                        UI.renderNumberBalls(ticketDiv, ticket.main, ticket.bonus, appState.currentHotNumbers, appState.currentColdNumbers, appState.currentDueNumbers);
                        document.getElementById('generatedTickets').appendChild(ticketDiv);
                        DataStore.addHistoricalDraw(ticket);
                    });
                    Notifier.showNotification(`${generated.length} ticket(s) generated successfully!`, 'success');
                    
                    // Update Generator Analysis Charts
                    const allGeneratedNumbers = generated.flatMap(t => t.main.concat(t.bonus));
                    const freqMap = _.countBy(allGeneratedNumbers);
                    const labels = Object.keys(freqMap).sort((a,b) => a - b);
                    const data = labels.map(l => freqMap[l]);
                    UI.updateChart(numberFrequencyChart, labels, data, 'Number Frequency');

                    const ticketSums = generated.map(t => Utils.calculateSum(t.main.concat(t.bonus)));
                    const sumLabels = Array.from(new Set(ticketSums)).sort((a,b) => a - b);
                    const sumData = sumLabels.map(s => ticketSums.filter(ts => ts === s).length);
                    UI.updateChart(sumAnalysisChart, sumLabels, sumData, 'Ticket Sums');

                    // Update Dashboard Stats and Charts
                    const totalNumbers = appState.historicalData.flatMap(d => d.numbers.concat(d.bonus));
                    const totalFreqMap = _.countBy(totalNumbers);
                    const dashLabels = Object.keys(totalFreqMap).sort((a,b) => a - b);
                    const dashData = dashLabels.map(l => totalFreqMap[l]);
                    UI.updateChart(dashboardHeatmapChart, dashLabels, dashData, 'Global Number Frequency');

                    const avgNumbers = _.mean(totalNumbers).toFixed(1);
                    const { odd, even } = Utils.countOddEven(totalNumbers);
                    document.getElementById('statsOverview').innerHTML = `
                        <p>Numbers Generated: ${totalNumbers.length}</p>
                        <p>Average Number: ${avgNumbers}</p>
                        <p>Odd/Even: ${odd}/${even}</p>
                    `;

                } else {
                    document.getElementById('generatedTickets').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Could not generate numbers with current settings.</p>';
                    Notifier.showNotification("Failed to generate numbers. Try adjusting filters.", "warning");
                }
            });

            document.getElementById('quickPick').addEventListener('click', () => {
                const game = document.getElementById('lotteryGame').value;
                const generated = Lottery.generateSmartNumbers(game, { numTickets: 1, generationMethod: 'standard' });
                if (generated.length > 0) {
                    UI.renderNumberBalls('generatedTickets', generated[0].main, generated[0].bonus);
                    Notifier.showNotification("Quick Pick generated!");
                }
            });

            document.getElementById('clearGenerator').addEventListener('click', () => {
                document.getElementById('generatedTickets').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>';
                document.getElementById('numTickets').value = 1;
                document.getElementById('randomSeed').value = '';
                UI.updateChart(numberFrequencyChart, [], [], '');
                UI.updateChart(sumAnalysisChart, [], [], '');
                UI.updateChart(patternAnalysisChart, [], [], '');
                Notifier.showNotification("Generator fields cleared.");
            });

            document.getElementById('exportTxt').addEventListener('click', () => {
                const ticketsHtml = Array.from(document.getElementById('generatedTickets').children).map(div => div.textContent.trim());
                if (ticketsHtml.length > 0 && ticketsHtml[0] !== 'Generate some numbers to see results') {
                    Utils.exportToTXT('lotto_tickets.txt', ticketsHtml);
                } else {
                    Notifier.showNotification('No tickets to export.', 'warning');
                }
            });

            document.getElementById('exportCsv').addEventListener('click', () => {
                const ticketsData = appState.historicalData;
                if (ticketsData.length > 0) {
                     const formattedData = ticketsData.map(draw => ({
                        Date: draw.timestamp ? new Date(draw.timestamp).toLocaleDateString() : 'N/A',
                        MainNumbers: draw.numbers.join(' '),
                        BonusNumbers: draw.bonus.join(' '),
                        Sum: Utils.calculateSum(draw.numbers.concat(draw.bonus)),
                        OddEven: `${Utils.countOddEven(draw.numbers.concat(draw.bonus)).odd}/${Utils.countOddEven(draw.numbers.concat(draw.bonus)).even}`
                    }));
                    Utils.exportToCSV('lotto_tickets.csv', formattedData);
                } else {
                    Notifier.showNotification('No tickets to export to CSV.', 'warning');
                }
            });

            document.getElementById('copyTickets').addEventListener('click', () => {
                const ticketsHtml = Array.from(document.getElementById('generatedTickets').children).map(div => div.textContent.trim());
                if (ticketsHtml.length > 0 && ticketsHtml[0] !== 'Generate some numbers to see results') {
                    Utils.copyToClipboard(ticketsHtml.join('\n'));
                } else {
                    Notifier.showNotification('No tickets to copy.', 'warning');
                }
            });

            document.getElementById('saveTickets').addEventListener('click', () => {
                Notifier.showNotification('Generated tickets are automatically saved to Historical Data.', 'info');
            });


            // Initialize Generator Charts
            numberFrequencyChart = UI.initChart(document.getElementById('numberFrequencyChart').getContext('2d'), 'bar', [], [], 'Number Frequency');
            sumAnalysisChart = UI.initChart(document.getElementById('sumAnalysisChart').getContext('2d'), 'line', [], [], 'Sum Analysis');
            patternAnalysisChart = UI.initChart(document.getElementById('patternAnalysisChart').getContext('2d'), 'bar', [], [], 'Pattern Analysis');

            // Analyzer Section Logic
            document.getElementById('analyzeNumbers').addEventListener('click', () => {
                const inputNumbersText = document.getElementById('numbersToAnalyze').value;
                const analyzerGameType = document.getElementById('analyzerGame').value;
                const { main: numbers, bonus: bonusNumbers } = Utils.parseNumbers(inputNumbersText, analyzerGameType);

                if (numbers.length === 0 && bonusNumbers.length === 0) {
                    Notifier.showNotification('Please enter numbers to analyze.', 'warning');
                    return;
                }

                const analysis = Lottery.analyzeNumbers(numbers, bonusNumbers, analyzerGameType);
                
                document.getElementById('analysisResults').innerHTML = `
                    <p><strong>Input Numbers:</strong> ${numbers.join(', ')} ${bonusNumbers.length > 0 ? `(+${bonusNumbers.join(', ')})` : ''}</p>
                    <p><strong>Game Type:</strong> ${analyzerGameType.toUpperCase()}</p>
                `;
                
                document.getElementById('basicStats').innerHTML = `
                    <p><strong>Sum:</strong> ${analysis.sum}</p>
                    <p><strong>Average:</strong> ${analysis.average}</p>
                    <p><strong>Median:</strong> ${analysis.median}</p>
                    <p><strong>Mode:</strong> ${analysis.mode.join(', ') || 'N/A'}</p>
                    <p><strong>Std Dev:</strong> ${analysis.stdDev}</p>
                `;

                document.getElementById('advancedMetrics').innerHTML = `
                    <p><strong>Odd/Even Ratio:</strong> ${analysis.oddEvenRatio}</p>
                    <p><strong>Min/Max:</strong> ${analysis.min}/${analysis.max}</p>
                    <p><strong>Consecutive Pairs:</strong> ${analysis.consecutivePairs}</p>
                    <p><strong>Consecutive Triplets:</strong> ${analysis.consecutiveTriplets}</p>
                    <p><strong>Prime Count:</strong> ${analysis.primeCount}</p>
                    <p><strong>Fibonacci Count:</strong> ${analysis.fibonacciCount}</p>
                    <p><strong>Hot Matches:</strong> ${analysis.hotMatches}</p>
                    <p><strong>Cold Matches:</strong> ${analysis.coldMatches}</p>
                    <p><strong>Due Matches:</strong> ${analysis.dueMatches}</p>
                `;

                UI.renderNumberBalls('visualAnalysis', numbers, bonusNumbers, appState.currentHotNumbers, appState.currentColdNumbers, appState.currentDueNumbers);

                // Update Analyzer Charts
                const allAnalyzedNumbers = numbers.concat(bonusNumbers);
                const freqMap = _.countBy(allAnalyzedNumbers);
                const freqLabels = Object.keys(freqMap).sort((a,b) => a - b);
                const freqData = freqLabels.map(l => freqMap[l]);
                UI.updateChart(freqDistributionChart, freqLabels, freqData, 'Number Frequency');

                const lastDigitLabels = Object.keys(analysis.lastDigitFreq).sort((a,b) => a - b);
                const lastDigitData = lastDigitLabels.map(l => analysis.lastDigitFreq[l]);
                UI.updateChart(lastDigitDistributionChart, lastDigitLabels, lastDigitData, 'Last Digit Distribution');

                const decadeLabels = Object.keys(analysis.decadeFreq).sort((a,b) => a - b);
                const decadeData = decadeLabels.map(l => analysis.decadeFreq[l]);
                UI.updateChart(sumDistributionChart, decadeLabels, decadeData, 'Decade Distribution'); // Reusing sumDistributionChart for decade

                UI.updateChart(oddEvenDistributionChart, ['Odd', 'Even'], [analysis.odd, analysis.even], 'Odd/Even Distribution', ['rgba(139, 92, 246, 0.6)', 'rgba(59, 130, 246, 0.6)']); // Secondary/Primary colors

                Notifier.showNotification("Numbers analyzed successfully!", "success");
            });

            document.getElementById('getAIInsights').addEventListener('click', async () => {
                const inputNumbersText = document.getElementById('numbersToAnalyze').value;
                const analyzerGameType = document.getElementById('analyzerGame').value;
                const { main: numbers, bonus: bonusNumbers } = Utils.parseNumbers(inputNumbersText, analyzerGameType);

                if (numbers.length === 0 && bonusNumbers.length === 0) {
                    Notifier.showNotification('Please enter numbers for AI Insights.', 'warning');
                    return;
                }

                UI.showLoading('aiInsightsLoading');
                document.getElementById('aiInsightsOutput').classList.remove('hidden');
                document.getElementById('aiInsightsText').textContent = 'Analyzing with AI...';

                try {
                    const analysis = Lottery.analyzeNumbers(numbers, bonusNumbers, analyzerGameType);
                    const allAnalyzedNumbers = numbers.concat(bonusNumbers);

                    const prompt = `Analyze the following lottery numbers for a ${analyzerGameType.toUpperCase()} game and provide insights on their statistical properties and historical context.
                    Numbers: ${numbers.join(', ')} ${bonusNumbers.length > 0 ? `Bonus: ${bonusNumbers.join(', ')}` : ''}
                    Game Type: ${analyzerGameType.toUpperCase()}
                    Statistical Properties:
                    - Sum: ${analysis.sum}
                    - Odd/Even Ratio: ${analysis.oddEvenRatio}
                    - Consecutive Pairs: ${analysis.consecutivePairs}
                    - Consecutive Triplets: ${analysis.consecutiveTriplets}
                    - Prime Count: ${analysis.primeCount}
                    - Fibonacci Count: ${analysis.fibonacciCount}
                    Historical Context (based on available app data, if any):
                    - Hot Matches: ${analysis.hotMatches}
                    - Cold Matches: ${analysis.coldMatches}
                    - Due Matches: ${analysis.dueMatches}
                    
                    Provide a concise summary and a recommendation for these numbers. Explain if they are balanced, lean towards certain patterns, or align with historical trends.`;

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will automatically provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        document.getElementById('aiInsightsText').innerHTML = text;
                        Notifier.showNotification("AI insights generated.", "success");
                    } else {
                        document.getElementById('aiInsightsText').textContent = 'Failed to get AI insights. Please try again.';
                        Notifier.showNotification('Failed to get AI insights.', 'error');
                        console.error('Gemini API response error:', result);
                    }
                } catch (error) {
                    document.getElementById('aiInsightsText').textContent = 'Error connecting to AI service. Please check your network or try again later.';
                    Notifier.showNotification('Error connecting to AI service.', 'error');
                    console.error('Error in AI Insights:', error);
                } finally {
                    UI.hideLoading('aiInsightsLoading');
                }
            });

            document.getElementById('clearAnalyzer').addEventListener('click', () => {
                document.getElementById('numbersToAnalyze').value = '';
                document.getElementById('analysisResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>';
                document.getElementById('basicStats').innerHTML = '';
                document.getElementById('advancedMetrics').innerHTML = '';
                document.getElementById('visualAnalysis').innerHTML = '';
                document.getElementById('aiInsightsOutput').classList.add('hidden');
                document.getElementById('aiInsightsText').textContent = '';
                UI.updateChart(freqDistributionChart, [], [], '');
                UI.updateChart(lastDigitDistributionChart, [], [], '');
                UI.updateChart(sumDistributionChart, [], [], '');
                UI.updateChart(oddEvenDistributionChart, [], [], '');
                Notifier.showNotification("Analyzer fields cleared.");
            });

            document.querySelectorAll('.sample-input').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.getElementById('numbersToAnalyze').value = e.target.dataset.sample;
                    document.getElementById('analyzerGame').value = e.target.dataset.game;
                    Notifier.showNotification("Sample numbers loaded.");
                });
            });

            // Initialize Analyzer Charts
            freqDistributionChart = UI.initChart(document.getElementById('freqDistributionChart').getContext('2d'), 'bar', [], [], 'Number Frequency');
            lastDigitDistributionChart = UI.initChart(document.getElementById('lastDigitDistributionChart').getContext('2d'), 'bar', [], [], 'Last Digit Distribution');
            sumDistributionChart = UI.initChart(document.getElementById('sumDistributionChart').getContext('2d'), 'bar', [], [], 'Decade Distribution');
            oddEvenDistributionChart = UI.initChart(document.getElementById('oddEvenDistributionChart').getContext('2d'), 'pie', [], [], 'Odd/Even Distribution', ['rgba(139, 92, 246, 0.6)', 'rgba(59, 130, 246, 0.6)']);

            // Seed Reverser Logic
            document.getElementById('reverseSeedBtn').addEventListener('click', async () => {
                const numbersToReverseText = document.getElementById('numbersToReverse').value;
                const seedGameType = document.getElementById('seedReverseGame').value;
                const { main: numbers, bonus: bonusNumbers } = Utils.parseNumbers(numbersToReverseText, seedGameType);

                if (numbers.length === 0 && bonusNumbers.length === 0) {
                    Notifier.showNotification('Please enter numbers for Statistical Profile generation.', 'warning');
                    return;
                }

                UI.showLoading('seedInterpretationLoading');
                document.getElementById('seedProfileResults').innerHTML = '<p>Generating statistical profile...</p>';
                document.getElementById('seedInterpretationOutput').classList.add('hidden'); // Hide interpretation until requested
                document.getElementById('seedInterpretationText').textContent = '';

                // Perform detailed analysis using existing Lottery.analyzeNumbers
                const analysis = Lottery.analyzeNumbers(numbers, bonusNumbers, seedGameType);
                const allNumbers = analysis.allNumbers;

                document.getElementById('seedProfileResults').innerHTML = `
                    <p><strong>Input Numbers:</strong> ${analysis.mainNumbers.join(', ')} ${analysis.bonusNumbers.length > 0 ? `(+${analysis.bonusNumbers.join(', ')})` : ''}</p>
                    <p><strong>Game Type:</strong> ${seedGameType.toUpperCase()}</p>
                    <p><strong>Sum:</strong> ${analysis.sum}</p>
                    <p><strong>Average:</strong> ${analysis.average}</p>
                    <p><strong>Odd/Even Ratio:</strong> ${analysis.oddEvenRatio}</p>
                `;
                document.getElementById('seedStats').innerHTML = `
                    <p><strong>Min/Max:</strong> ${analysis.min}/${analysis.max}</p>
                    <p><strong>Median:</strong> ${analysis.median}</p>
                    <p><strong>Std Dev:</strong> ${analysis.stdDev}</p>
                    <p><strong>Mode:</strong> ${analysis.mode.join(', ') || 'N/A'}</p>
                `;
                document.getElementById('seedPatterns').innerHTML = `
                    <p><strong>Consecutive Pairs:</strong> ${analysis.consecutivePairs}</p>
                    <p><strong>Consecutive Triplets:</strong> ${analysis.consecutiveTriplets}</p>
                    <p><strong>Prime Count:</strong> ${analysis.primeCount}</p>
                    <p><strong>Fibonacci Count:</strong> ${analysis.fibonacciCount}</p>
                    <p><strong>Hot Matches:</strong> ${analysis.hotMatches}</p>
                    <p><strong>Cold Matches:</strong> ${analysis.coldMatches}</p>
                    <p><strong>Due Matches:</strong> ${analysis.dueMatches}</p>
                `;
                UI.renderNumberBalls('seedVisuals', numbers, bonusNumbers, appState.currentHotNumbers, appState.currentColdNumbers, appState.currentDueNumbers);

                UI.hideLoading('seedInterpretationLoading');
                Notifier.showNotification("Statistical profile generated.", "success");
            });

            document.getElementById('interpretSeedProfile').addEventListener('click', async () => {
                const numbersToReverseText = document.getElementById('numbersToReverse').value;
                const seedGameType = document.getElementById('seedReverseGame').value;
                const { main: numbers, bonus: bonusNumbers } = Utils.parseNumbers(numbersToReverseText, seedGameType);

                if (numbers.length === 0 && bonusNumbers.length === 0) {
                    Notifier.showNotification('Please generate a statistical profile first.', 'warning');
                    return;
                }

                UI.showLoading('seedInterpretationLoading');
                document.getElementById('seedInterpretationOutput').classList.remove('hidden');
                document.getElementById('seedInterpretationText').textContent = 'Interpreting profile with AI...';

                try {
                    const analysis = Lottery.analyzeNumbers(numbers, bonusNumbers, seedGameType);

                    const prompt = `Interpret the following statistical profile of a lottery number sequence. This profile describes the characteristics of a set of numbers, NOT a true random seed for prediction of future draws. Focus on explaining what these characteristics mean in the context of lottery numbers and what insights can be drawn about the *properties* of the given numbers. Provide actionable advice for improving the number selection if the user desires a more balanced or historically aligned set.

                    Statistical Profile:
                    - Game Type: ${seedGameType.toUpperCase()}
                    - Numbers: ${analysis.mainNumbers.join(', ')} ${analysis.bonusNumbers.length > 0 ? `Bonus: ${analysis.bonusNumbers.join(', ')}` : ''}
                    - Sum: ${analysis.sum} (Average: ${analysis.average})
                    - Odd/Even Ratio: ${analysis.oddEvenRatio}
                    - Min/Max: ${analysis.min}/${analysis.max}
                    - Median: ${analysis.median}
                    - Standard Deviation: ${analysis.stdDev}
                    - Mode: ${analysis.mode.join(', ') || 'N/A'}
                    - Consecutive Pairs: ${analysis.consecutivePairs}
                    - Consecutive Triplets: ${analysis.consecutiveTriplets}
                    - Prime Count: ${analysis.primeCount}
                    - Fibonacci Count: ${analysis.fibonacciCount}
                    - Hot Numbers Matched: ${analysis.hotMatches}
                    - Cold Numbers Matched: ${analysis.coldMatches}
                    - Due Numbers Matched: ${analysis.dueMatches}

                    Provide a comprehensive interpretation and practical advice.`;

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will automatically provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        document.getElementById('seedInterpretationText').innerHTML = text;
                        Notifier.showNotification("AI interpretation complete.", "success");
                    } else {
                        document.getElementById('seedInterpretationText').textContent = 'Failed to get AI interpretation. Please try again.';
                        Notifier.showNotification('Failed to get AI interpretation.', 'error');
                        console.error('Gemini API response error:', result);
                    }
                } catch (error) {
                    document.getElementById('seedInterpretationText').textContent = 'Error connecting to AI service. Please check your network or try again later.';
                    Notifier.showNotification('Error connecting to AI service.', 'error');
                    console.error('Error in AI Interpretation:', error);
                } finally {
                    UI.hideLoading('seedInterpretationLoading');
                }
            });

            document.getElementById('clearSeedReverse').addEventListener('click', () => {
                document.getElementById('numbersToReverse').value = '';
                document.getElementById('seedProfileResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers and generate profile</p>';
                document.getElementById('seedStats').innerHTML = '';
                document.getElementById('seedPatterns').innerHTML = '';
                document.getElementById('seedVisuals').innerHTML = '';
                document.getElementById('seedInterpretationOutput').classList.add('hidden');
                document.getElementById('seedInterpretationText').textContent = '';
                Notifier.showNotification("Seed reverser fields cleared.");
            });

            // Historical Data Logic
            const dataSourceSelect = document.getElementById('dataSource');
            const csvUploadContainer = document.getElementById('csvUploadContainer');

            dataSourceSelect.addEventListener('change', () => {
                if (dataSourceSelect.value === 'csv') {
                    csvUploadContainer.classList.remove('hidden');
                } else {
                    csvUploadContainer.classList.add('hidden');
                }
            });

            document.getElementById('loadData').addEventListener('click', () => {
                const historicalGame = document.getElementById('historicalGame').value;
                const dataSource = document.getElementById('dataSource').value;
                const pastDrawsCount = document.getElementById('pastDraws').value;
                const config = appState.gameConfig[historicalGame];

                UI.showLoading('dataSummary');
                document.getElementById('historicalTable').querySelector('tbody').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Loading data...</td></tr>';

                setTimeout(() => {
                    let loadedData = [];
                    if (dataSource === 'sample') {
                        // Generate sample historical data with some bias for hot/cold/due
                        const numDraws = pastDrawsCount === 'all' ? 200 : parseInt(pastDrawsCount);
                        const possibleNumbers = Array.from({ length: config.mainPool }, (_, i) => i + 1);
                        const possibleBonusNumbers = config.bonusPool > 0 ? Array.from({ length: config.bonusPool }, (_, i) => i + 1) : [];

                        // Simulate some "hot" numbers for the sample data
                        const sampleHotNumbers = _.sampleSize(possibleNumbers, Math.ceil(config.mainPool * 0.1));
                        const sampleDueNumbers = _.sampleSize(possibleNumbers.filter(n => !sampleHotNumbers.includes(n)), Math.ceil(config.mainPool * 0.1));

                        for (let i = 0; i < numDraws; i++) {
                            const date = new Date(Date.now() - (i * 7 * 24 * 60 * 60 * 1000)); // Weekly draws
                            let main = new Set();
                            let bonus = new Set();

                            // Bias generation for sample data
                            for(let j = 0; j < config.pickCount; j++) {
                                let num;
                                if (Math.random() < 0.4 && sampleHotNumbers.length > 0) { // 40% chance to pick hot
                                    num = _.sample(sampleHotNumbers);
                                } else if (Math.random() < 0.2 && sampleDueNumbers.length > 0) { // 20% chance to pick due
                                    num = _.sample(sampleDueNumbers);
                                } else {
                                    num = _.sample(possibleNumbers);
                                }
                                if (num && !main.has(num)) {
                                    main.add(num);
                                } else { // Fallback to ensure enough numbers
                                    main.add(Utils.generateRandomNumbers(1, config.mainPool)[0]);
                                }
                            }
                            main = Array.from(main).sort((a,b) => a-b);

                            if (config.bonusCount > 0) {
                                bonus = Utils.generateRandomNumbers(config.bonusCount, config.bonusPool);
                            }

                            loadedData.push({
                                timestamp: date.toISOString(),
                                date: date.toLocaleDateString(),
                                numbers: main,
                                bonus: bonus,
                                sum: Utils.calculateSum([...main, ...bonus]),
                                oddEven: Utils.countOddEven([...main, ...bonus])
                            });
                        }
                    } else if (dataSource === 'csv') {
                        const csvFile = document.getElementById('csvUpload').files[0];
                        if (csvFile) {
                            DataStore.importData(csvFile);
                            Notifier.showNotification("CSV data processing initiated.");
                            UI.hideLoading('dataSummary');
                            return;
                        } else {
                            Notifier.showNotification('Please select a CSV file to upload.', 'warning');
                            UI.hideLoading('dataSummary');
                            return;
                        }
                    } else if (dataSource === 'api') {
                        Notifier.showNotification("Live API data loading (Premium feature - not implemented).", "info");
                        UI.hideLoading('dataSummary');
                        return;
                    }

                    appState.historicalData = loadedData;
                    DataStore.saveState();

                    const tableBody = document.getElementById('historicalTable').querySelector('tbody');
                    tableBody.innerHTML = '';
                    if (loadedData.length > 0) {
                        loadedData.forEach(draw => {
                            const row = tableBody.insertRow();
                            row.insertCell().textContent = draw.date;
                            row.insertCell().innerHTML = draw.numbers.map(n => `<span class="number-ball !w-8 !h-8 !text-sm !font-semibold">${n}</span>`).join('');
                            row.insertCell().innerHTML = draw.bonus.length > 0 ? draw.bonus.map(n => `<span class="number-ball bonus-ball !w-8 !h-8 !text-sm !font-semibold">${n}</span>`).join('') : 'N/A';
                            row.insertCell().textContent = draw.sum;
                            row.insertCell().textContent = `${draw.oddEven.odd}/${draw.oddEven.even}`;
                        });
                        Notifier.showNotification(`${loadedData.length} historical draws loaded.`, "success");
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">No data available for selected criteria.</td></tr>';
                        Notifier.showNotification("No historical data found.", "warning");
                    }

                    // Update Data Summary and Quick Analysis
                    const allNumbersFlat = loadedData.flatMap(d => d.numbers.concat(d.bonus));
                    const freqMap = _.countBy(allNumbersFlat);
                    const sortedFreq = Object.entries(freqMap).sort(([, a], [, b]) => b - a);

                    document.getElementById('dataSummary').innerHTML = `
                        <p>Total Draws: ${loadedData.length}</p>
                        <p>Game Type: ${historicalGame.toUpperCase()}</p>
                        <p>Date Range: ${loadedData.length > 0 ? `${loadedData[loadedData.length - 1].date} - ${loadedData[0].date}` : 'N/A'}</p>
                    `;
                    document.getElementById('mostFrequent').innerHTML = sortedFreq.slice(0, 5).map(([num, count]) => `<p>${num} (${count})</p>`).join('');
                    document.getElementById('leastFrequent').innerHTML = sortedFreq.slice(-5).map(([num, count]) => `<p>${num} (${count})</p>`).reverse().join('');
                    
                    const { hot: currentHot, cold: currentCold, due: currentDue } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);
                    appState.currentHotNumbers = currentHot;
                    appState.currentColdNumbers = currentCold;
                    appState.currentDueNumbers = currentDue;

                    document.getElementById('dueNumbers').innerHTML = currentDue.length > 0 ? currentDue.slice(0, 10).join(', ') + (currentDue.length > 10 ? '...' : '') : 'None';

                    // Update Historical Charts
                    const historicalLabels = Object.keys(freqMap).sort((a,b) => a - b);
                    const historicalData = historicalLabels.map(l => freqMap[l]);
                    UI.updateChart(freqHeatmapHistoricalChart, historicalLabels, historicalData, 'Historical Frequency');

                    // Frequency Over Time (example: show frequency of one number over draws)
                    UI.updateChart(freqOverTimeChart, [], [], 'Freq Over Time'); // Placeholder

                    // Gap Analysis (placeholder)
                    UI.updateChart(gapAnalysisChart, [], [], 'Gap Analysis'); // Placeholder

                    UI.hideLoading('dataSummary');

                }, 1000);
            });

            document.getElementById('clearHistorical').addEventListener('click', () => {
                appState.historicalData = [];
                appState.currentHotNumbers = [];
                appState.currentColdNumbers = [];
                appState.currentDueNumbers = [];
                DataStore.saveState();
                document.getElementById('dataSummary').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Load historical data to see summary</p>';
                document.getElementById('mostFrequent').innerHTML = '';
                document.getElementById('leastFrequent').innerHTML = '';
                document.getElementById('dueNumbers').innerHTML = '';
                document.getElementById('recentTrends').innerHTML = '';
                document.getElementById('patternFrequency').innerHTML = '';
                document.getElementById('sumStatistics').innerHTML = '';
                document.getElementById('historicalTable').querySelector('tbody').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td></tr>';
                UI.updateChart(freqHeatmapHistoricalChart, [], [], '');
                UI.updateChart(freqOverTimeChart, [], [], '');
                UI.updateChart(gapAnalysisChart, [], [], '');
                Notifier.showNotification("Historical data cleared.", "success");
            });

            document.getElementById('exportHistorical').addEventListener('click', () => {
                if (appState.historicalData.length > 0) {
                    const formattedData = appState.historicalData.map(draw => ({
                        Date: draw.timestamp ? new Date(draw.timestamp).toLocaleDateString() : 'N/A',
                        MainNumbers: draw.numbers.join(' '),
                        BonusNumbers: draw.bonus.join(' '),
                        Sum: draw.sum,
                        OddEven: `${draw.oddEven.odd}/${draw.oddEven.even}`
                    }));
                    Utils.exportToCSV('lotto_historical_data.csv', formattedData);
                } else {
                    Notifier.showNotification('No historical data to export.', 'warning');
                }
            });

            // Initialize Historical Charts
            freqHeatmapHistoricalChart = UI.initChart(document.getElementById('freqHeatmapChart').getContext('2d'), 'bar', [], [], 'Number Frequency Heatmap');
            freqOverTimeChart = UI.initChart(document.getElementById('freqOverTimeChart').getContext('2d'), 'line', [], [], 'Frequency Over Time');
            gapAnalysisChart = UI.initChart(document.getElementById('gapAnalysisChart').getContext('2d'), 'bar', [], [], 'Gap Analysis');

            // AI Strategies Logic
            document.querySelectorAll('.applyStrategy').forEach(button => {
                button.addEventListener('click', (e) => {
                    const strategy = e.target.dataset.strategy;
                    if (appState.historicalData.length === 0) {
                        Notifier.showNotification('Load historical data first to apply strategies.', 'warning');
                        return;
                    }
                    UI.showLoading('strategyResults');
                    document.getElementById('strategyResults').textContent = `Applying ${strategy} strategy...`;
                    document.getElementById('recommendedNumbers').innerHTML = '';
                    document.getElementById('strategyAnalysis').innerHTML = '';

                    setTimeout(() => {
                        const gameType = document.getElementById('lotteryGame').value; // Assuming generator game type
                        const config = appState.gameConfig[gameType];
                        let recommended = [];
                        let analysisText = '';
                        const { hot: historicalHot, cold: historicalCold, due: historicalDue } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);

                        if (strategy === 'frequency') {
                            // Recommend a mix of hot and a few mid-frequency numbers
                            const allNumbers = appState.historicalData.flatMap(d => d.numbers.concat(d.bonus));
                            const freqMap = _.countBy(allNumbers);
                            const sortedFreq = Object.entries(freqMap).sort(([, a], [, b]) => b - a);
                            
                            const topHot = sortedFreq.slice(0, Math.ceil(config.pickCount * 0.7)).map(([num]) => Number(num));
                            const remaining = config.pickCount - topHot.length;
                            const midFreq = sortedFreq.slice(Math.ceil(config.pickCount * 0.7), Math.ceil(config.pickCount * 0.7) + remaining * 2).map(([num]) => Number(num));
                            recommended = _.sampleSize([...topHot, ...midFreq], config.pickCount).sort((a,b) => a-b);

                            analysisText = `Numbers selected with a strong bias towards historically "hot" (frequently drawn) numbers, supplemented by some mid-frequency numbers for balance.`;
                        } else if (strategy === 'gap') {
                            // Recommend mostly due numbers, with some hot as anchor
                            recommended = _.sampleSize([...historicalDue, ...historicalHot], config.pickCount).sort((a,b) => a-b);
                            analysisText = `Numbers selected primarily based on their "due" status (longest absence from draws), with a few "hot" numbers to stabilize the selection.`;
                        } else if (strategy === 'pattern') {
                            // This is still a simulation, but implies looking for specific number relationships
                            // For true pattern recognition, you'd need more complex algorithms (e.g., sequence mining)
                            recommended = Lottery.generateSmartNumbers(gameType, {
                                numTickets: 1,
                                generationMethod: 'ai', // Using the AI generation logic
                                useHistorical: true,
                                favorHot: true,
                                includeDue: true,
                                avoidRepeats: true
                            })[0].main;
                            analysisText = `This strategy attempts to identify and leverage recurring number patterns and sequences from historical data, combining them with hot and due numbers for an optimized selection.`;
                        }

                        UI.renderNumberBalls('recommendedNumbers', recommended, [], historicalHot, historicalCold, historicalDue);
                        document.getElementById('strategyAnalysis').textContent = analysisText;
                        document.getElementById('strategyResults').innerHTML = `<p>Strategy Applied: <strong>${strategy}</strong></p>`;
                        UI.hideLoading('strategyResults');
                        Notifier.showNotification("Strategy applied successfully!", "success");
                    }, 1500);
                });
            });

            // New AI Strategy Advisor Button
            const customStrategyBuilderDiv = document.querySelector('#strategies .mt-8.pt-6.border-t');
            const aiStrategyAdvisorButton = document.createElement('button');
            aiStrategyAdvisorButton.id = 'aiStrategyAdvisor';
            aiStrategyAdvisorButton.className = 'p-3 bg-accent text-white rounded-lg hover:bg-green-700 w-full mt-4';
            aiStrategyAdvisorButton.innerHTML = 'AI Strategy Advisor ‚ú®';
            customStrategyBuilderDiv.appendChild(aiStrategyAdvisorButton);

            aiStrategyAdvisorButton.addEventListener('click', async () => {
                if (appState.historicalData.length === 0) {
                    Notifier.showNotification('Load historical data first for AI strategy advice.', 'warning');
                    return;
                }

                UI.showLoading('strategyResults');
                document.getElementById('strategyResults').textContent = 'Consulting AI Strategy Advisor...';
                document.getElementById('recommendedNumbers').innerHTML = '';
                document.getElementById('strategyAnalysis').innerHTML = '';

                try {
                    const gameType = document.getElementById('lotteryGame').value;
                    const config = appState.gameConfig[gameType];
                    const { hot, cold, due } = Lottery.analyzeHistoricalTrends(appState.historicalData, config);

                    const prompt = `Given the following lottery game configuration and historical number trends, suggest a strategic approach for picking numbers.
                    Game: ${gameType.toUpperCase()} (Main Pool: ${config.mainPool}, Pick Count: ${config.pickCount}, Bonus Pool: ${config.bonusPool}, Bonus Count: ${config.bonusCount})
                    Hot Numbers (most frequent): ${hot.join(', ') || 'None'}
                    Cold Numbers (least frequent): ${cold.join(', ') || 'None'}
                    Due Numbers (overdue): ${due.join(', ') || 'None'}
                    
                    Provide a concise, actionable strategy, including a mix of number types (hot, cold, due, random) and general advice on balancing different statistical properties. Suggest a few example numbers based on your strategy.`;

                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Canvas will automatically provide this
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        document.getElementById('strategyAnalysis').innerHTML = text;
                        document.getElementById('strategyResults').innerHTML = `<p>AI Strategy Advisor consulted!</p>`;
                        Notifier.showNotification("AI Strategy Advisor provided insights.", "success");
                    } else {
                        document.getElementById('strategyAnalysis').textContent = 'Failed to get AI strategy advice. Please try again.';
                        Notifier.showNotification('Failed to get AI strategy advice.', 'error');
                        console.error('Gemini API response error:', result);
                    }
                } catch (error) {
                    document.getElementById('strategyAnalysis').textContent = 'Error connecting to AI service. Please check your network or try again later.';
                    Notifier.showNotification('Error connecting to AI service.', 'error');
                    console.error('Error in AI Strategy Advisor:', error);
                } finally {
                    UI.hideLoading('strategyResults');
                }
            });


            document.getElementById('buildStrategy').addEventListener('click', () => {
                Notifier.showNotification("Custom Strategy Builder logic needs to be implemented. This would combine selected components with their weights.", "info");
            });

            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueSpan = document.getElementById(slider.id + 'Value');
                slider.addEventListener('input', () => {
                    valueSpan.textContent = `${slider.value}%`;
                });
            });

            // Probability Lab Logic
            document.getElementById('calculateProbability').addEventListener('click', () => {
                const gameType = document.getElementById('probabilityGame').value;
                const mainMatches = parseInt(document.getElementById('calcMainMatch').value);
                const bonusMatches = parseInt(document.getElementById('calcBonusMatch').value);

                if (isNaN(mainMatches) || isNaN(bonusMatches) || mainMatches < 0 || bonusMatches < 0) {
                    Notifier.showNotification('Please enter valid numbers for matches.', 'warning');
                    return;
                }

                const probability = Lottery.calculateProbability(gameType, mainMatches, bonusMatches);
                document.getElementById('probabilityResults').innerHTML = `
                    <p><strong>Game:</strong> ${gameType.toUpperCase()}</p>
                    <p><strong>Matches:</strong> ${mainMatches} Main, ${bonusMatches} Bonus</p>
                    <p><strong>Odds:</strong> ${probability}</p>
                `;

                UI.updateChart(probabilityChart, ['Your Odds', 'Against You'], [1, (probability.includes('‚àû') ? 1000000000 : parseFloat(probability.replace('1 in ', '').replace(/,/g, '')))], 'Probability', ['rgba(16, 185, 129, 0.6)', 'rgba(239, 68, 68, 0.6)']); // Accent/Danger colors
                Notifier.showNotification("Probability calculated.", "success");
            });

            document.getElementById('clearProbability').addEventListener('click', () => {
                document.getElementById('calcMainMatch').value = 0;
                document.getElementById('calcBonusMatch').value = 0;
                document.getElementById('probabilityResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter criteria to calculate probability</p>';
                UI.updateChart(probabilityChart, [], [], '');
                Notifier.showNotification("Probability calculator cleared.");
            });

            // Initialize Probability Chart
            probabilityChart = UI.initChart(document.getElementById('probabilityChart').getContext('2d'), 'bar', [], [], 'Probability');

            // Prediction Engine Logic
            document.getElementById('generatePrediction').addEventListener('click', async () => {
                const predictionGame = document.getElementById('predictionGame').value;
                const predictionModel = document.getElementById('predictionModel').value;

                UI.renderNumberBalls('predictionResults', []);
                document.getElementById('predictionDetails').classList.add('hidden');

                const { predictedMain, predictedBonus, confidence, details } = await Lottery.predictNumbers(predictionGame, predictionModel);

                if (predictedMain.length > 0 || predictedBonus.length > 0) {
                    // Render predicted numbers, highlighting hot/cold/due based on overall historical data
                    UI.renderNumberBalls('predictionResults', predictedMain, predictedBonus, appState.currentHotNumbers, appState.currentColdNumbers, appState.currentDueNumbers);
                    document.getElementById('predictionDetailsText').innerHTML = details;
                    document.getElementById('predictionDetails').classList.remove('hidden');

                    UI.updateChart(predictionConfidenceChart, ['Confidence'], [parseFloat(confidence)], 'Prediction Confidence', 'rgba(16, 185, 129, 0.6)'); // Accent color
                    Notifier.showNotification("Prediction generated successfully!", "success");
                } else {
                    document.getElementById('predictionResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Could not generate prediction.</p>';
                    Notifier.showNotification("Failed to generate prediction.", "error");
                }
            });

            document.getElementById('clearPrediction').addEventListener('click', () => {
                UI.renderNumberBalls('predictionResults', []);
                document.getElementById('predictionDetails').classList.add('hidden');
                document.getElementById('predictionDetailsText').textContent = '';
                UI.updateChart(predictionConfidenceChart, [], [], '');
                Notifier.showNotification("Prediction engine cleared.");
            });

            // Initialize Prediction Chart
            predictionConfidenceChart = UI.initChart(document.getElementById('predictionConfidenceChart').getContext('2d'), 'bar', [], [], 'Prediction Confidence');

            // Settings Logic
            document.getElementById('exportAllData').addEventListener('click', DataStore.exportAllData);
            document.getElementById('clearAllData').addEventListener('click', DataStore.clearAllData);
            document.getElementById('importData').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    if (e.target.files.length > 0) {
                        DataStore.importData(e.target.files[0]);
                    }
                };
                input.click();
            });

            document.getElementById('notificationsBtn').addEventListener('click', () => {
                Notifier.showNotification("Notifications panel is not fully implemented yet, but new notifications appear as toasts.", "info");
                Notifier.markAllAsRead();
            });

            // Initial active navigation link and scroll to dashboard
            document.querySelector('.nav-link[href="#dashboard"]').classList.add('text-white', 'bg-primary');
            document.getElementById('dashboard').scrollIntoView();
        });

        // Global Error Handling
        window.onerror = (message, source, lineno, colno, error) => {
            console.error("Global Error:", message, source, lineno, colno, error);
            Notifier.showNotification(`An unexpected error occurred: ${message.substring(0, 100)}...`, 'error', 5000);
            return true;
        };

        window.addEventListener('unhandledrejection', (event) => {
            console.error("Unhandled Promise Rejection:", event.reason);
            Notifier.showNotification(`An operation failed: ${event.reason.message || event.reason}...`, 'error', 5000);
        });

    </script>
</body>
</html>
